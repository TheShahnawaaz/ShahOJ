{% extends "base.html" %}

{% block title %}Edit Problem - {{ problem.config.get('title') or problem.slug }} - PocketOJ{% endblock %}

{% block extra_css %}
<style>
    .code-editor {
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .file-tab {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .file-tab:hover {
        background-color: #f8f9fa;
    }
    
    .file-tab.active {
        background-color: #007bff;
        color: white;
    }
    
    .file-tab.modified {
        font-weight: bold;
        color: #dc3545;
    }
    
    .file-tab.modified::after {
        content: " â€¢";
        color: #dc3545;
    }
    
    .validation-status {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    
    .validation-valid {
        background-color: #d4edda;
        color: #155724;
    }
    
    .validation-invalid {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .validation-loading {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .save-indicator {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('problem_detail', slug=problem.slug) }}">{{ problem.config.get('title') or problem.slug }}</a></li>
            <li class="breadcrumb-item active">Edit</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-edit"></i> Edit Problem</h1>
            <p class="text-muted">{{ problem.config.get('title') or problem.slug }}</p>
        </div>
        <div class="col-md-4 text-end">
                            <div class="btn-group">
                    <button class="btn btn-success" id="saveAllBtn">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                    <button class="btn btn-outline-secondary" onclick="location.reload()">
                        <i class="fas fa-undo"></i> Discard Changes
                    </button>
                </div>
        </div>
    </div>

    <div class="row">
        
        <!-- File Tabs Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-folder-open"></i> Problem Files</h5>
                </div>
                <div class="list-group list-group-flush">
                    
                    <!-- Configuration -->
                    <div class="list-group-item file-tab active" data-file="config">
                        <i class="fas fa-cog text-primary"></i>
                        <strong>Configuration</strong>
                        <small class="d-block text-muted">Basic settings & metadata</small>
                    </div>
                    
                    <!-- Statement -->
                    <div class="list-group-item file-tab" data-file="statement">
                        <i class="fas fa-file-alt text-info"></i>
                        <strong>statement.md</strong>
                        <small class="d-block text-muted">Problem description</small>
                    </div>
                    
                    <!-- Solution -->
                    <div class="list-group-item file-tab" data-file="solution">
                        <i class="fas fa-python text-success"></i>
                        <strong>solution.py</strong>
                        <small class="d-block text-muted">Reference solution</small>
                    </div>
                    
                    <!-- Generator -->
                    <div class="list-group-item file-tab" data-file="generator">
                        <i class="fas fa-random text-warning"></i>
                        <strong>generator.py</strong>
                        <small class="d-block text-muted">Test case generator</small>
                    </div>
                    
                    <!-- Validator -->
                    <div class="list-group-item file-tab" data-file="validator">
                        <i class="fas fa-shield-alt text-secondary"></i>
                        <strong>validator.py</strong>
                        <small class="d-block text-muted">Input validator (optional)</small>
                    </div>
                    
                    <!-- Custom Checker -->
                    <div class="list-group-item file-tab" data-file="checker">
                        <i class="fas fa-gavel text-danger"></i>
                        <strong>checker/spj.cpp</strong>
                        <small class="d-block text-muted">Special judge (optional)</small>
                    </div>
                    
                </div>
            </div>
            
            <!-- File Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-tools"></i> File Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success btn-sm" id="testIntegrationBtn">
                            <i class="fas fa-flask"></i> Test Integration
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="previewTestBtn">
                            <i class="fas fa-eye"></i> Preview Test Case
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Editor -->
        <div class="col-md-9">
            
            <!-- Configuration Editor -->
            <div class="file-content active" id="config-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5><i class="fas fa-cog"></i> Problem Configuration</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="resetConfigBtn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="edit_title" 
                                           value="{{ problem.config.get('title') or '' }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_difficulty" class="form-label">Difficulty</label>
                                    <select class="form-select" id="edit_difficulty">
                                        <option value="Easy" {% if problem.config.get('difficulty') == 'Easy' %}selected{% endif %}>Easy</option>
                                        <option value="Medium" {% if problem.config.get('difficulty') == 'Medium' %}selected{% endif %}>Medium</option>
                                        <option value="Hard" {% if problem.config.get('difficulty') == 'Hard' %}selected{% endif %}>Hard</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_tags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="edit_tags" 
                                           value="{{ (problem.config.get('tags') or [])|join(', ') }}">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_time_limit" class="form-label">Time Limit (ms)</label>
                                    <input type="number" class="form-control" id="edit_time_limit" 
                                           value="{{ problem.config.get('limits.time_ms') or 1000 }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_memory_limit" class="form-label">Memory Limit (MB)</label>
                                    <input type="number" class="form-control" id="edit_memory_limit" 
                                           value="{{ problem.config.get('limits.memory_mb') or 256 }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_checker_type" class="form-label">Checker Type</label>
                                    <select class="form-select" id="edit_checker_type">
                                        <option value="diff" {% if problem.config.get('checker.type') == 'diff' %}selected{% endif %}>Exact Match (diff)</option>
                                        <option value="float" {% if problem.config.get('checker.type') == 'float' %}selected{% endif %}>Floating Point</option>
                                        <option value="spj" {% if problem.config.get('checker.type') == 'spj' %}selected{% endif %}>Special Judge</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit_description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit_description" rows="2">{{ problem.config.get('description') or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statement Editor -->
            <div class="file-content" id="statement-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5><i class="fas fa-file-alt"></i> Problem Statement</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="resetStatementBtn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <textarea class="form-control code-editor" id="statement_editor" 
                                  rows="20" placeholder="# Problem Title

## Problem Statement
...">{{ statement_content or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Solution Editor -->
            <div class="file-content" id="solution-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5><i class="fas fa-python"></i> Reference Solution</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="resetSolutionBtn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <textarea class="form-control code-editor" id="solution_editor" 
                                  rows="20">{{ solution_content or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Generator Editor -->
            <div class="file-content" id="generator-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5><i class="fas fa-random"></i> Test Generator</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="resetGeneratorBtn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <textarea class="form-control code-editor" id="generator_editor" 
                                  rows="20">{{ generator_content or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Validator Editor -->
            <div class="file-content" id="validator-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-shield-alt"></i> Input Validator</h5>
                        <div>
                            <div class="form-check form-switch d-inline-block me-3">
                                <input class="form-check-input" type="checkbox" id="validatorEnabled" 
                                       {{ 'checked' if problem.config.get('validation.enabled', False) else '' }}>
                                <label class="form-check-label" for="validatorEnabled">
                                    Enable Validation
                                </label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" id="resetValidatorBtn">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Validator Control:</strong> 
                            <span id="validatorStatusText">
                                {% if problem.config.get('validation.enabled', False) %}
                                    Validation is <strong>enabled</strong>. Generated test cases will be validated.
                                {% else %}
                                    Validation is <strong>disabled</strong>. Test cases will be generated without validation.
                                {% endif %}
                            </span>
                        </div>
                        <textarea class="form-control code-editor" id="validator_editor" 
                                  rows="15" placeholder="#!/usr/bin/env python3
# Input validator (optional)
# Exit 0 = valid, 1 = invalid
# Only runs if validation is enabled">{{ validator_content or '' }}</textarea>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Note:</strong> The validator will only be used if validation is enabled above. 
                                You can create problems without validators and add them later.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checker Editor -->
            <div class="file-content" id="checker-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5><i class="fas fa-gavel"></i> Custom Checker (SPJ)</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="resetCheckerBtn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <textarea class="form-control code-editor" id="checker_editor" 
                                  rows="15" placeholder='#include "testlib.h"
using namespace std;

int main(int argc, char* argv[]) {
    registerTestlibCmd(argc, argv);
    // Your SPJ logic here
    quitf(_ok, "correct");
}'>{{ checker_content or '' }}</textarea>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Test Integration Results Modal -->
    <div class="modal fade" id="integrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-flask"></i> Integration Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="integrationResults">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div class="save-indicator alert" id="saveIndicator">
        <!-- Save status messages -->
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    let currentFile = 'config';
    let originalContents = {};
    let modifiedFiles = new Set();
    
    // Load initial file contents
    loadFileContents();
    
    // File tab switching
    document.querySelectorAll('.file-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const fileName = this.dataset.file;
            switchToFile(fileName);
        });
    });
    
    // Track modifications
    ['statement_editor', 'solution_editor', 'generator_editor', 'validator_editor', 'checker_editor'].forEach(editorId => {
        const editor = document.getElementById(editorId);
        if (editor) {
            editor.addEventListener('input', function() {
                const fileName = editorId.split('_')[0];
                markFileModified(fileName);
            });
        }
    });
    
    // Track config modifications
    ['edit_title', 'edit_difficulty', 'edit_tags', 'edit_time_limit', 'edit_memory_limit', 'edit_checker_type', 'edit_description'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                markFileModified('config');
            });
        }
    });
    
    // Save all changes
    document.getElementById('saveAllBtn').addEventListener('click', function() {
        saveAllChanges();
    });
    
    // Test integration
    document.getElementById('testIntegrationBtn').addEventListener('click', function() {
        testFileIntegration();
    });
    
    // SPJ compilation
    document.getElementById('compileCheckerBtn').addEventListener('click', function() {
        compileSpj();
    });
    
    document.getElementById('testCheckerBtn').addEventListener('click', function() {
        testSpjCompilation();
    });
    
    function switchToFile(fileName) {
        // Update tab appearance
        document.querySelectorAll('.file-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.file === fileName);
        });
        
        // Update content visibility
        document.querySelectorAll('.file-content').forEach(content => {
            content.style.display = content.id === fileName + '-content' ? 'block' : 'none';
        });
        
        currentFile = fileName;
    }
    
    function loadFileContents() {
        // Store original contents for reset functionality
        originalContents = {
            statement: document.getElementById('statement_editor').value,
            solution: document.getElementById('solution_editor').value,
            generator: document.getElementById('generator_editor').value,
            validator: document.getElementById('validator_editor').value,
            checker: document.getElementById('checker_editor').value
        };
    }
    
    function markFileModified(fileName) {
        modifiedFiles.add(fileName);
        const tab = document.querySelector(`[data-file="${fileName}"]`);
        if (tab) {
            tab.classList.add('modified');
        }
        
        // Update save button
        const saveBtn = document.getElementById('saveAllBtn');
        if (modifiedFiles.size > 0) {
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Save ${modifiedFiles.size} Modified File${modifiedFiles.size > 1 ? 's' : ''}`;
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-warning');
        }
    }
    

    
    function saveAllChanges() {
        const btn = document.getElementById('saveAllBtn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        
        // Collect all data
        const data = {
            config: {
                title: document.getElementById('edit_title').value.trim(),
                difficulty: document.getElementById('edit_difficulty').value,
                tags: document.getElementById('edit_tags').value.split(',').map(t => t.trim()).filter(t => t),
                time_limit_ms: parseInt(document.getElementById('edit_time_limit').value),
                memory_limit_mb: parseInt(document.getElementById('edit_memory_limit').value),
                checker_type: document.getElementById('edit_checker_type').value,
                description: document.getElementById('edit_description').value.trim()
            },
            files: {
                'statement.md': document.getElementById('statement_editor').value,
                'solution.py': document.getElementById('solution_editor').value,
                'generator.py': document.getElementById('generator_editor').value,
                'validator.py': document.getElementById('validator_editor').value,
                'checker/spj.cpp': document.getElementById('checker_editor').value
            },
            validator_enabled: document.getElementById('validatorEnabled').checked
        };
        
        // Save via API
        fetch(`/api/problem/{{ problem.slug }}/save-all`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSaveStatus('success', 'All changes saved successfully!');
                
                // Clear modification markers
                modifiedFiles.clear();
                document.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.remove('modified');
                });
                
                // Reset save button
                btn.innerHTML = '<i class="fas fa-save"></i> Save All Changes';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                
                // Reload page after short delay to reflect changes
                setTimeout(() => location.reload(), 2000);
                
            } else {
                showSaveStatus('error', `Save failed: ${data.error}`);
            }
        })
        .catch(error => {
            showSaveStatus('error', `Network error: ${error.message}`);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    function testFileIntegration() {
        const modal = new bootstrap.Modal(document.getElementById('integrationModal'));
        const resultsDiv = document.getElementById('integrationResults');
        
        resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Testing file integration...</p></div>';
        modal.show();
        
        // Collect current file contents
        const files = {
            'statement.md': document.getElementById('statement_editor').value,
            'solution.py': document.getElementById('solution_editor').value,  
            'generator.py': document.getElementById('generator_editor').value,
            'validator.py': document.getElementById('validator_editor').value,
            'checker/spj.cpp': document.getElementById('checker_editor').value
        };
        
        // Test integration
        fetch('/api/test-file-integration', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ files: files })
        })
        .then(response => response.json())
        .then(data => {
            displayIntegrationResults(data);
        })
        .catch(error => {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Integration test failed: ${error.message}</div>`;
        });
    }
    
    function displayIntegrationResults(data) {
        const resultsDiv = document.getElementById('integrationResults');
        let html = '';
        
        if (data.success) {
            html += '<div class="alert alert-success"><i class="fas fa-check-circle"></i> All files integrate correctly!</div>';
            
            if (data.preview) {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Generated Test Case:</h6>
                            <pre class="bg-light p-3">${data.preview.input}</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Solution Output:</h6>
                            <pre class="bg-light p-3">${data.preview.output}</pre>
                            ${data.preview.valid ? '<span class="badge bg-success">âœ“ Validator Passed</span>' : ''}
                        </div>
                    </div>
                `;
            }
        } else {
            html += '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Integration issues found:</div>';
            
            if (data.errors) {
                html += '<ul class="text-danger">';
                data.errors.forEach(error => {
                    html += `<li><strong>Error:</strong> ${error}</li>`;
                });
                html += '</ul>';
            }
        }
        
        if (data.warnings) {
            html += '<div class="alert alert-warning"><strong>Warnings:</strong></div>';
            html += '<ul>';
            data.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul>';
        }
        
        resultsDiv.innerHTML = html;
    }
    
    function showSaveStatus(type, message) {
        const indicator = document.getElementById('saveIndicator');
        
        indicator.className = `save-indicator alert alert-${type === 'success' ? 'success' : 'danger'} show`;
        indicator.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle"></i> ${message}`;
        indicator.style.display = 'block';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 5000);
    }
    
    // Handle validator toggle
    document.getElementById('validatorEnabled').addEventListener('change', function() {
        const statusText = document.getElementById('validatorStatusText');
        if (this.checked) {
            statusText.innerHTML = 'Validation is <strong>enabled</strong>. Generated test cases will be validated.';
        } else {
            statusText.innerHTML = 'Validation is <strong>disabled</strong>. Test cases will be generated without validation.';
        }
    });
    
    // Initialize
    switchToFile('config');
    
    console.log('Problem editor initialized for: {{ problem.slug }}');
});
</script>
{% endblock %}
