{% extends "layouts/base.html" %}
{% from "layouts/components.html" import enhanced_breadcrumb, problem_detail_header, enhanced_card, file_status_indicator, test_case_summary %}

{% block title %}{{ problem.config.get('title', problem.slug) }} - ShahOJ{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body {
        background-color: #f5f7fa;
    }

    /* Enhanced Layout */
    .edit-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
    }

    /* Progress Bar */
    .progress-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    /* Enhanced Buttons */
    .btn-enhanced {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    /* Markdown Content Styling */
    .markdown-content {
        line-height: 1.6;
        color: #333;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: #2c3e50;
        font-weight: 600;
    }

    .markdown-content h1 {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .markdown-content h2 {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.3rem;
    }

    .markdown-content code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background-color: #f8f9fa !important;
        border: 1px solid #e9ecef !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        overflow-x: auto;
    }

    .markdown-content ul,
    .markdown-content ol {
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content blockquote {
        border-left: 4px solid #007bff;
        padding-left: 1rem;
        margin-left: 0;
        color: #6c757d;
        font-style: italic;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-content th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .btn-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }

    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        background: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        transition: var(--transition);
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        background: none;
    }

    .tab-content {
        background: white;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        color: var(--dark-color);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-content pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }

    .markdown-content code {
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* Code block copy button styling */
    .code-block-container {
        position: relative;
    }

    .copy-btn {
        opacity: 1;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        background: #fff;
        border-color: #007bff;
        color: #007bff;
    }

    .copy-btn.copied {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Enhanced Breadcrumb -->
    {{ enhanced_breadcrumb([
        {'text': 'Dashboard', 'url': url_for('dashboard'), 'icon': 'fas fa-home'},
        {'text': problem.config.get('title', problem.slug), 'icon': 'fas fa-file-code'}
    ]) }}

    <!-- Enhanced Problem Header -->
    {{ problem_detail_header(problem) }}

    <!-- Problem Information -->
    <div class="row">
        
        <!-- Configuration Panel -->
        <div class="col-lg-3 col-md-4">
            
            <!-- Basic Info -->
            {% call enhanced_card("Problem Information", "fas fa-info-circle") %}
                <table class="table table-sm mb-0">
                    <tr>
                        <td><strong>Time Limit:</strong></td>
                        <td><span class="badge bg-primary">{{ problem.config.get('limits.time_ms') or 1000 }}ms</span></td>
                    </tr>
                    <tr>
                        <td><strong>Memory Limit:</strong></td>
                        <td><span class="badge bg-info">{{ problem.config.get('limits.memory_mb') or 256 }}MB</span></td>
                    </tr>
                    <tr>
                        <td><strong>Checker:</strong></td>
                        <td>
                            {% set checker_type = problem.config.get('checker.type') or 'diff' %}
                            <span class="badge 
                                {% if checker_type == 'diff' %}bg-primary
                                {% elif checker_type == 'float' %}bg-info
                                {% else %}bg-warning text-dark{% endif %}">
                                {{ checker_type|upper }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Created:</strong></td>
                        <td><small class="text-muted">{{ (problem.config.get('created_date') or 'Unknown')[:10] }}</small></td>
                    </tr>
                </table>
            {% endcall %}

            <!-- File Status -->
            {% call enhanced_card("File Status", "fas fa-file-code") %}
                {% set files = problem.get_files_info() %}
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-cog text-muted me-2"></i>config.yaml</span>
                        {{ file_status_indicator(files.config_exists, true) }}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-file-alt text-muted me-2"></i>statement.md</span>
                        {{ file_status_indicator(files.statement_exists, true) }}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-code text-muted me-2"></i>solution.py</span>
                        {{ file_status_indicator(files.solution_exists, true) }}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-random text-muted me-2"></i>generator.py</span>
                        {{ file_status_indicator(files.generator_exists, true) }}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-shield-alt text-muted me-2"></i>validator.py</span>
                        {{ file_status_indicator(files.validator_exists, false) }}
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                        <span><i class="fas fa-gavel text-muted me-2"></i>checker/</span>
                        {{ file_status_indicator(files.checker_exists, false) }}
                    </div>
                </div>
            {% endcall %}

            <!-- Test Cases Summary -->
            {% call enhanced_card("Test Cases", "fas fa-vial", [
                {'text': 'Manage', 'icon': 'fas fa-cog', 'class': 'btn-outline-primary btn-sm', 'onclick': "location.href='" + url_for('manage_test_cases', slug=problem.slug) + "'"}
            ]) %}
                {% set test_counts = problem.get_test_cases_count() %}
                {{ test_case_summary(test_counts) }}
            {% endcall %}

        </div>

        <!-- Main Content Panel -->
        <div class="col-lg-9 col-md-8">
            
            <!-- Problem Statement -->
            {% call enhanced_card("Problem Statement", "fas fa-file-alt", [
                {'text': 'Edit', 'icon': 'fas fa-edit', 'class': 'btn-outline-primary btn-sm', 'onclick': "location.href='" + url_for('edit_problem_page', slug=problem.slug) + "'"}
            ]) %}
                <div id="problemStatement">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <p class="mt-2 text-muted">Loading problem statement...</p>
                    </div>
                </div>
            {% endcall %}

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load problem statement
    loadProblemStatement();

    // Initialize enhanced buttons
    initializeEnhancedButtons();
});

function loadProblemStatement() {
    fetch(`/api/problem/{{ problem.slug }}/statement`)
        .then(response => response.json())
        .then(data => {
            const statementDiv = document.getElementById('problemStatement');
            if (data.success) {
                // Convert markdown to HTML (simple conversion for now)
                const htmlContent = convertMarkdownToHtml(data.statement);
                statementDiv.innerHTML = htmlContent;
            } else {
                statementDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Problem statement could not be loaded. ${data.error || ''}
                    </div>
                    <h4>{{ problem.config.get('title', problem.slug) }}</h4>
                    <p class="text-muted">{{ problem.config.get('description', 'No description available.') }}</p>
                `;
            }
        })
        .catch(error => {
            const statementDiv = document.getElementById('problemStatement');
            statementDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Problem statement file not found or could not be loaded.
                </div>
                <h4>{{ problem.config.get('title', problem.slug) }}</h4>
                <p class="text-muted">{{ problem.config.get('description', 'No description available.') }}</p>
            `;
        });
}

function convertMarkdownToHtml(markdown) {
    // Enhanced markdown conversion
    let html = markdown;
    
    // Handle code blocks first (before other processing)
    html = html.replace(/```([^`\n]*)\n?([\s\S]*?)```/gm, function(match, lang, code) {
        const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
        return `<div class="code-block-container position-relative mb-3">
            <pre class="bg-light border rounded p-3 mb-0"><code id="${codeId}" class="language-${lang || 'text'}">${code.trim()}</code></pre>
            <button class="btn btn-sm btn-outline-secondary copy-btn position-absolute" 
                    style="top: 8px; right: 8px; padding: 4px 8px; font-size: 12px;"
                    onclick="copyCodeBlock('${codeId}')" 
                    title="Copy to clipboard">
                <i class="fas fa-copy"></i>
            </button>
        </div>`;
    });
    
    // Handle inline code
    html = html.replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>');
    
    // Handle headers
    html = html.replace(/^##### (.+)$/gm, '<h5 class="mt-4 mb-2">$1</h5>');
    html = html.replace(/^#### (.+)$/gm, '<h4 class="mt-4 mb-3">$1</h4>');
    html = html.replace(/^### (.+)$/gm, '<h3 class="mt-4 mb-3">$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2 class="mt-4 mb-3">$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1 class="mt-3 mb-4">$1</h1>');
    
    // Handle bold and italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Handle bullet lists
    html = html.replace(/^- (.+)$/gm, '###LISTITEM###$1###/LISTITEM###');
    
    // Handle numbered lists  
    html = html.replace(/^\d+\. (.+)$/gm, '###ORDEREDITEM###$1###/ORDEREDITEM###');
    
    // Convert list items to proper HTML
    html = html.replace(/(###LISTITEM###.+?###\/LISTITEM###(\n|$))+/gm, function(match) {
        const items = match.replace(/###LISTITEM###/g, '<li>').replace(/###\/LISTITEM###/g, '</li>').trim();
        return '<ul class="mb-3">' + items + '</ul>';
    });
    
    html = html.replace(/(###ORDEREDITEM###.+?###\/ORDEREDITEM###(\n|$))+/gm, function(match) {
        const items = match.replace(/###ORDEREDITEM###/g, '<li>').replace(/###\/ORDEREDITEM###/g, '</li>').trim();
        return '<ol class="mb-3">' + items + '</ol>';
    });
    
    // Handle mathematical notation (common in competitive programming)
    html = html.replace(/≤/g, '&le;');
    html = html.replace(/≥/g, '&ge;');
    html = html.replace(/\^(\d+)/g, '<sup>$1</sup>');
    
    // Handle paragraphs - split by double newlines
    const paragraphs = html.split(/\n\s*\n/);
    html = paragraphs.map(p => {
        p = p.trim();
        if (!p) return '';
        
        // Skip if already wrapped in block elements
        if (p.match(/^<(h[1-6]|pre|ul|ol|div)/)) {
            return p;
        }
        
        // Wrap in paragraph
        return `<p class="mb-3">${p}</p>`;
    }).join('\n');
    
    // Clean up extra whitespace
    html = html.replace(/\n+/g, '\n').trim();
    
    return `<div class="markdown-content">${html}</div>`;
}

function initializeEnhancedButtons() {
    // Add hover effects to enhanced buttons
    document.querySelectorAll('.btn-enhanced').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

function deleteProblem(slug) {
    if (confirm('Are you sure you want to delete this problem? This action cannot be undone.')) {
        fetch(`/api/problem/${slug}/delete`, { method: 'DELETE' })
            .then(async response => {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (err) {
                    throw new Error(text);
                }
            })
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ url_for('dashboard') }}';
                } else {
                    alert(data.error || 'Failed to delete problem');
                }
            })
            .catch(error => {
                alert('Error deleting problem: ' + error);
            });
    }
}

function exportProblem(slug) {
    // Placeholder for export functionality
    alert('Export functionality will be implemented soon!');
}

function copyCodeBlock(codeId) {
    const codeElement = document.getElementById(codeId);
    const button = event.target.closest('.copy-btn');
    
    if (!codeElement) return;
    
    // Get the text content
    const text = codeElement.textContent;
    
    // Copy to clipboard
    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Show success feedback
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('copied');
        }, 2000);
    });
}
</script>
{% endblock %}
