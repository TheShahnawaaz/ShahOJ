{% extends "layouts/base.html" %}
{% from "layouts/components.html" import enhanced_breadcrumb, problem_detail_header, enhanced_card, file_status_indicator, test_case_summary %}

{% block title %}{{ problem.config.get('title', problem.slug) }} - {{ problem.config.get('difficulty', 'Medium') }} | ShahOJ{% endblock %}

{% block description %}Solve {{ problem.config.get('title', problem.slug) }}, a {{ problem.config.get('difficulty', 'Medium') }} level competitive programming problem on ShahOJ. Practice algorithms and data structures with instant feedback.{% if problem.config.get('tags') %} Tags: {{ problem.config.get('tags')|join(', ') }}.{% endif %}{% endblock %}

{% block keywords %}{{ problem.config.get('title', problem.slug) }}, ShahOJ, competitive programming, {{ problem.config.get('difficulty', 'Medium') }} problem, algorithm practice, coding challenge, shahnawaz{% if problem.config.get('tags') %}, {{ problem.config.get('tags')|join(', ') }}{% endif %}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ problem.config.get('title', problem.slug) }} - {{ problem.config.get('difficulty', 'Medium') }} Problem | ShahOJ{% endblock %}
{% block og_description %}Solve this {{ problem.config.get('difficulty', 'Medium') }} level competitive programming challenge on ShahOJ.{% if problem.config.get('tags') %} Topics: {{ problem.config.get('tags')|join(', ') }}.{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{ problem.config.get('title', problem.slug) }}",
  "description": "A {{ problem.config.get('difficulty', 'Medium') }} level competitive programming problem",
  "author": {
    "@type": "Person",
    "name": "{{ author.name if author else 'Anonymous' }}"{% if author and author.picture_url %},
    "image": "{{ author.picture_url }}"{% endif %}
  },
  "datePublished": "{{ problem_data.created_at_iso if problem_data.created_at_iso else '' }}",
  "dateModified": "{{ problem_data.updated_at_iso if problem_data.updated_at_iso else '' }}",
  "keywords": "{{ problem.config.get('tags')|join(', ') if problem.config.get('tags') else 'algorithms, data structures' }}",
  "articleSection": "Competitive Programming",
  "inLanguage": "en",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.url }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ShahOJ",
    "url": "https://theshahnawaz.pythonanywhere.com/",
    "logo": {
      "@type": "ImageObject",
      "url": "https://theshahnawaz.pythonanywhere.com/static/images/ShahOJLogo.png"
    }
  }
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Home",
    "item": "{{ url_for('dashboard', _external=True) }}"
  }, {
    "@type": "ListItem",
    "position": 2,
    "name": "{{ problem.config.get('title', problem.slug) }}",
    "item": "{{ request.url }}"
  }]
}
</script>
{% endblock %}

{% block extra_css %}
<!-- Monaco Editor Component CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/monaco-editor-component.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/submission-modal.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body { background-color: var(--primary-bg); }

    /* Enhanced Layout */
    .edit-container {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    /* Progress Bar */
    .progress-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    /* Enhanced Buttons */
    .btn-enhanced {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    /* Enhanced Run Test Buttons */
    .btn-run-all {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.9rem;
    }

    .btn-run-all:hover {
        background: linear-gradient(135deg, #218838, #1ea085);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
    }

    .btn-run-all:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .btn-run-samples {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.9rem;
    }

    .btn-run-samples:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        color: white;
    }

    .btn-run-samples:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .btn-run-custom {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
        border: none;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.9rem;
    }

    .btn-run-custom:hover {
        background: linear-gradient(135deg, #5a32a3, #4c2a85);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        color: white;
    }

    .btn-run-custom:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
    }

    .btn-run-submit {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.9rem;
    }

    .btn-run-submit:hover {
        background: linear-gradient(135deg, #218838, #1ea085);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
    }

    .btn-run-submit:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .btn-run-all {
        background: linear-gradient(135deg, #198754, #157347);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
    }

    [data-theme="dark"] .btn-run-all:hover {
        background: linear-gradient(135deg, #146c43, #0f5132);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5);
    }

    [data-theme="dark"] .btn-run-samples {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    }

    [data-theme="dark"] .btn-run-samples:hover {
        background: linear-gradient(135deg, #0a58ca, #084298);
        box-shadow: 0 6px 20px rgba(13, 110, 253, 0.5);
    }

    [data-theme="dark"] .btn-run-custom {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    [data-theme="dark"] .btn-run-custom:hover {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
    }

    [data-theme="dark"] .btn-run-submit {
        background: linear-gradient(135deg, #198754, #157347);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
    }

    [data-theme="dark"] .btn-run-submit:hover {
        background: linear-gradient(135deg, #146c43, #0f5132);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5);
    }

    /* Button loading state */
    .btn-run-all:disabled,
    .btn-run-samples:disabled,
    .btn-run-custom:disabled,
    .btn-run-submit:disabled {
        opacity: 0.7;
        transform: none;
        cursor: not-allowed;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .btn-run-all,
        .btn-run-samples,
        .btn-run-custom,
        .btn-run-submit {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
    }

    /* Resizable Layout Styling */
    .resizable-container-wrapper {
        position: relative;
        border-radius: 8px;
        overflow: visible; /* Changed from hidden to visible */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: none !important; /* Ensure no height constraints */
        height: auto !important; /* Allow dynamic height */
    }
    
    .resizable-container {
        display: flex;
        height: calc(100vh - 188px); /* Full viewport height minus navbar (80px) + footer (60px) + container padding (48px) */
        min-height: 400px;
        max-height: none !important; /* No maximum height constraint */
        gap: 10px;
        position: relative;
        overflow: hidden;
    }
    
    .resizable-panel {
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .resizable-panel-left {
        flex: 0 0 50%;
        min-width: 300px;
        max-width: 80%;
        position: relative;
    }
    
    .resizable-panel-right {
        flex: 1;
        min-width: 300px;
        position: relative;
    }
    
    .resize-divider {
        width: 5px;
        background: var(--border-color, #dee2e6);
        cursor: col-resize;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        user-select: none;
        flex-shrink: 0;
    }
    
    .resize-divider:hover {
        background: var(--btn-primary, #007bff);
    }
    
    .resize-divider::before {
        content: '';
        position: absolute;
        width: 2px;
        height: 40px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }
    
    .resize-divider:hover::before {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }
    
    .resize-divider.dragging {
        background: var(--btn-primary, #007bff);
    }
    
    .resize-divider.dragging::before {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
    }
    
    /* Bottom resize divider for height adjustment */
    .resize-divider-bottom {
        height: 8px;
        width: 100%;
        background: var(--border-color, #dee2e6);
        cursor: row-resize;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        user-select: none;
        flex-shrink: 0;
        margin-top: 0;
        border-radius: 0 0 8px 8px;
    }
    
    .resize-divider-bottom:hover {
        background: var(--btn-primary, #007bff);
    }
    
    .resize-divider-bottom::before {
        content: '';
        position: absolute;
        width: 40px;
        height: 2px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }
    
    .resize-divider-bottom:hover::before {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }
    
    .resize-divider-bottom.dragging {
        background: var(--btn-primary, #007bff);
    }
    
    .resize-divider-bottom.dragging::before {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .resize-divider {
        background: var(--border-color, #3e3e42);
    }
    
    [data-theme="dark"] .resize-divider:hover {
        background: var(--btn-primary, #0d6efd);
    }
    
    [data-theme="dark"] .resize-divider::before {
        background: rgba(255, 255, 255, 0.6);
    }
    
    [data-theme="dark"] .resize-divider:hover::before,
    [data-theme="dark"] .resize-divider.dragging::before {
        background: rgba(255, 255, 255, 0.9);
    }
    
    /* Dark mode for bottom divider */
    [data-theme="dark"] .resize-divider-bottom {
        background: var(--border-color, #3e3e42);
    }
    
    [data-theme="dark"] .resize-divider-bottom:hover {
        background: var(--btn-primary, #0d6efd);
    }
    
    [data-theme="dark"] .resize-divider-bottom::before {
        background: rgba(255, 255, 255, 0.6);
    }
    
    [data-theme="dark"] .resize-divider-bottom:hover::before,
    [data-theme="dark"] .resize-divider-bottom.dragging::before {
        background: rgba(255, 255, 255, 0.9);
    }
    
    /* Dark mode for wrapper */
    [data-theme="dark"] .resizable-container-wrapper {
        border-color: #3e3e42;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    /* Dark mode for test results */
    [data-theme="dark"] #testResults {
        background-color: var(--card-bg) !important;
    }
    
    [data-theme="dark"] #testResults .card {
        background-color: var(--card-bg) !important;
        border-color: var(--border-color) !important;
    }
    
    [data-theme="dark"] #testResults .card-header {
        background-color: var(--secondary-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] #testResults .card-body {
        background-color: var(--card-bg) !important;
        color: var(--text-primary) !important;
    }
    
    /* Dark mode for test result statistics cards */
    [data-theme="dark"] #testResults .card.text-center {
        background-color: #2d2d30 !important;
        border-color: #3e3e42 !important;
        color: #cccccc !important;
    }
    
    /* Fix newline handling in test case content */
    #testResults .bg-light {
        word-wrap: break-word !important;
        font-family: 'Courier New', Consolas, Monaco, 'Lucida Console', monospace !important;
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
        padding: 0.75rem !important;
        border-radius: 6px !important;
        border: 1px solid #dee2e6 !important;
        overflow-x: auto !important;
        background-color: #f8f9fa !important;
        color: #212529 !important;
    }
    
    /* Dark mode for test result content */
    [data-theme="dark"] #testResults .bg-light {
        background-color: #2d2d30 !important;
        color: #cccccc !important;
        border-color: #3e3e42 !important;
    }
    
    /* Ensure code elements also respect newlines */
    #testResults .bg-light code,
    #testResults .bg-light pre {
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        font-family: inherit !important;
        font-size: inherit !important;
        color: inherit !important;
    }
    
    /* Enhanced styling for test category headers */
    #testResults .card-header {
        color: white !important;
        border: none !important;
        padding: 1rem 1.5rem !important;
        font-weight: 600 !important;
        font-size: 1rem !important;
        border-radius: 8px 8px 0 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    /* Default green gradient for successful test categories */
    #testResults .card-header:not(.bg-danger):not(.bg-warning) {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
    }
    
    #testResults .card-header h6 {
        margin: 0 !important;
        font-size: 1rem !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }
    
    #testResults .card-header i {
        font-size: 1.1rem !important;
        opacity: 0.9 !important;
    }
    
    /* Enhanced styling for the main Test Results header */
    #testResults > .card > .card-header {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
        color: white !important;
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        padding: 1.25rem 1.5rem !important;
        border-radius: 8px 8px 0 0 !important;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3) !important;
        border: none !important;
    }
    
    #testResults > .card > .card-header h5,
    #testResults > .card > .card-header h6 {
        margin: 0 !important;
        font-size: 1.1rem !important;
        font-weight: 700 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
    }
    
    #testResults > .card > .card-header i {
        font-size: 1.2rem !important;
        opacity: 1 !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
    }
    
    [data-theme="dark"] #testResults .text-success {
        color: #4caf50 !important;
    }
    
    [data-theme="dark"] #testResults .text-danger {
        color: #f44336 !important;
    }
    
    [data-theme="dark"] #testResults .text-info {
        color: #2196f3 !important;
    }
    
    [data-theme="dark"] #testResults .text-warning {
        color: #ff9800 !important;
    }
    
    /* Dark mode for compilation success/error messages */
    [data-theme="dark"] #testResults .alert-success {
        background-color: rgba(76, 175, 80, 0.1) !important;
        border-color: rgba(76, 175, 80, 0.3) !important;
        color: #4caf50 !important;
    }
    
    [data-theme="dark"] #testResults .alert-danger {
        background-color: rgba(244, 67, 54, 0.1) !important;
        border-color: rgba(244, 67, 54, 0.3) !important;
        color: #f44336 !important;
    }
    
    /* Dark mode for test badges */
    [data-theme="dark"] #testResults .badge.bg-success {
        background-color: #4caf50 !important;
        color: #ffffff !important;
    }
    
    [data-theme="dark"] #testResults .badge.bg-danger {
        background-color: #f44336 !important;
        color: #ffffff !important;
    }
    
    [data-theme="dark"] #testResults .badge.bg-warning {
        background-color: #ff9800 !important;
        color: #000000 !important;
    }
    
    [data-theme="dark"] #testResults .badge.bg-info {
        background-color: #2196f3 !important;
        color: #ffffff !important;
    }
    
    /* Fix test category headers in dark mode */
    [data-theme="dark"] #testResults .card-header {
        background-color: #2d2d30 !important;
        color: #cccccc !important;
        border-color: #3e3e42 !important;
    }
    
    /* Specific colors for different test result categories in dark mode */
    [data-theme="dark"] #testResults .card-header.bg-success {
        background: linear-gradient(135deg, #2d5a3d, #1e4d2b) !important;
        color: #ffffff !important;
    }
    
    [data-theme="dark"] #testResults .card-header.bg-danger {
        background: linear-gradient(135deg, #8b2635, #5f1e2d) !important;
        color: #ffffff !important;
    }
    
    [data-theme="dark"] #testResults .card-header.bg-warning {
        background: linear-gradient(135deg, #8b4513, #654321) !important;
        color: #ffffff !important;
    }
    
    [data-theme="dark"] #testResults .card-header.bg-primary,
    [data-theme="dark"] #testResults .card-header.bg-info {
        background: linear-gradient(135deg, #1e3a5f, #0d2748) !important;
        color: #ffffff !important;
    }
    
    /* Default dark header for samples/system tests */
    [data-theme="dark"] #testResults .card-header:not(.bg-success):not(.bg-danger):not(.bg-warning):not(.bg-primary):not(.bg-info) {
        color: #cccccc !important;
    }
    
    /* Make the main "Test Results" header colorful in dark mode */
    [data-theme="dark"] #testResults > .card > .card-header {
        background: linear-gradient(135deg, #1e3a5f, #0d2748) !important;
        color: #ffffff !important;
        border-color: #3e3e42 !important;
    }
    
    /* Alternative: Make it match the primary theme color */
    [data-theme="dark"] .resizable-panel-right #testResults > .card > .card-header {
        background: linear-gradient(135deg, var(--btn-primary), #094766) !important;
        color: #ffffff !important;
        border-color: #3e3e42 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    }
    
    /* Ensure cards fill the panel height with proper scrolling */
    .resizable-panel .card {
        height: 100%;
        display: flex;
        flex-direction: column;
        margin-bottom: 0;
        overflow: hidden;
    }
    
    .resizable-panel .card-body {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0; /* Important for flex child scrolling */
    }
    
    /* Right panel should be one scrollable unit */
    .resizable-panel-right .card-body {
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1rem;
    }
    
    /* Editor container takes fixed height */
    .resizable-panel-right .editor-resize-container {
        min-height: 300px;
        margin-bottom: 1rem;
    }
    
    .resizable-panel-right .monaco-editor-container {
        min-height: 250px;
    }
    
    /* Test results are part of the scrollable content */
    .resizable-panel-right #testResults {
        margin-top: 1rem;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
    }
    
    .resizable-panel-right #testResults .card {
        margin-bottom: 0;
        border: none;
        background: transparent;
    }
    
    .resizable-panel-right #testResults .card-header {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
    }
    
    .resizable-panel-right #testResults .card-body {
        border: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
        background: var(--card-bg);
        overflow: visible;
        max-height: none;
    }
    
    /* Custom Scrollbar Styling for Theme Responsiveness */
    
    /* Webkit browsers (Chrome, Safari, Edge) */
    .resizable-panel .card-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .resizable-panel .card-body::-webkit-scrollbar-track {
        background: var(--secondary-bg, #f8f9fa);
        border-radius: 4px;
    }
    
    .resizable-panel .card-body::-webkit-scrollbar-thumb {
        background: var(--border-color, #dee2e6);
        border-radius: 4px;
        transition: background-color 0.3s ease;
    }
    
    .resizable-panel .card-body::-webkit-scrollbar-thumb:hover {
        background: var(--btn-primary, #007bff);
    }
    
    /* Dark mode scrollbar */
    [data-theme="dark"] .resizable-panel .card-body::-webkit-scrollbar-track {
        background: #2d2d30;
    }
    
    [data-theme="dark"] .resizable-panel .card-body::-webkit-scrollbar-thumb {
        background: #464647;
    }
    
    [data-theme="dark"] .resizable-panel .card-body::-webkit-scrollbar-thumb:hover {
        background: var(--btn-primary, #0d6efd);
    }
    
    /* Firefox scrollbar */
    .resizable-panel .card-body {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color, #dee2e6) var(--secondary-bg, #f8f9fa);
    }
    
    [data-theme="dark"] .resizable-panel .card-body {
        scrollbar-color: #464647 #2d2d30;
    }
    
    /* Test results specific scrollbar styling */
    #testResults .card-body::-webkit-scrollbar {
        width: 6px;
    }
    
    #testResults .card-body::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #testResults .card-body::-webkit-scrollbar-thumb {
        background: rgba(0, 123, 255, 0.3);
        border-radius: 3px;
    }
    
    #testResults .card-body::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 123, 255, 0.6);
    }
    
    [data-theme="dark"] #testResults .card-body::-webkit-scrollbar-thumb {
        background: rgba(13, 110, 253, 0.4);
    }
    
    [data-theme="dark"] #testResults .card-body::-webkit-scrollbar-thumb:hover {
        background: rgba(13, 110, 253, 0.7);
    }

    /* Responsive behavior */
    @media (max-width: 768px) {
        .resizable-container {
            flex-direction: column;
            height: auto;
            max-height: none;
            min-height: auto;
        }
        
        .resizable-panel-left,
        .resizable-panel-right {
            flex: none;
            min-width: auto;
            max-width: none;
            height: auto;
        }
        
        .resizable-panel-left .card,
        .resizable-panel-right .card {
            height: auto;
            min-height: 400px;
        }
        
        .resizable-panel-right .card-body {
            padding: 1rem;
            overflow-y: auto;
        }
        
        .resizable-panel-right .editor-resize-container {
            min-height: 300px;
        }
        
        .resizable-panel-right #testResults {
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        
        .resize-divider,
        .resize-divider-bottom {
            display: none;
        }
    }

    /* Custom Input Modal Styling */
    .modal-xl {
        max-width: 95vw;
    }
    
    @media (min-width: 1200px) {
        .modal-xl {
            max-width: 1400px;
        }
    }
    
    #customInputModal .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    #customInputModal .modal-header {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }
    
    #customInputModal .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    #customInputModal .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    
    #customInputModal .btn-close:hover {
        opacity: 1;
    }
    
    #customInputModal .modal-body {
        padding: 2rem;
        background: var(--card-bg);
    }
    
    #customInputModal .form-label {
        color: var(--text-primary);
        font-size: 1rem;
        margin-bottom: 0.75rem;
    }
    
    #customInputModal #customInput {
        background: var(--input-bg, #f8f9fa) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.95rem;
        line-height: 1.4;
        resize: vertical;
        min-height: 300px;
        height: 90%;
        width: 100%;
        display: block;
        transition: border-color 0.3s ease;
    }
    
    #customInputModal #customInput:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
        outline: none;
    }
    
    #customInputModal #customInput::placeholder {
        color: var(--text-muted, #6c757d);
        opacity: 0.7;
    }
    
    #customInputModal #customOutput {
        background: var(--code-bg, #f8f9fa) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.9rem;
        line-height: 1.4;
        min-height: 300px;
        height: 90%;
        width: 100%;
        display: block;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    #customInputModal .modal-footer {
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 12px 12px;
        padding: 1.5rem;
    }
    
    #customInputModal .btn-primary {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    #customInputModal .btn-primary:hover {
        background: linear-gradient(135deg, #5a32a3, #4c2a85);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
    }
    
    #customInputModal .btn-secondary {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    #customInputModal .btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-1px);
    }
    
    /* Dark mode specific styles */
    [data-theme="dark"] #customInputModal .modal-content {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    [data-theme="dark"] #customInputModal .modal-header {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    [data-theme="dark"] #customInputModal #customInput {
        background: var(--input-bg, #2d3748) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] #customInputModal #customInput:focus {
        border-color: #8b5cf6 !important;
        box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25) !important;
    }
    
    [data-theme="dark"] #customInputModal #customOutput {
        background: var(--code-bg, #1a202c) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] #customInputModal .btn-primary {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    [data-theme="dark"] #customInputModal .btn-primary:hover {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    [data-theme="dark"] #customInputModal .btn-secondary {
        background: var(--secondary-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
    
    [data-theme="dark"] #customInputModal .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: var(--border-color);
    }

    /* Markdown Content Styling */
    .markdown-content {
        line-height: 1.6;
        color: var(--text-primary);
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: var(--text-primary);
        font-weight: 600;
    }

    .markdown-content h1 { border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }

    .markdown-content h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem; }

    .markdown-content code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background-color: var(--secondary-bg) !important;
        border: 1px solid var(--border-color) !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        overflow-x: auto;
    }

    /* Code blocks styling - override Bootstrap's bg-light in dark mode */
    .code-block-container pre {
        background-color: var(--code-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .code-block-container pre.bg-light {
        background-color: #2d2d30 !important;
        border-color: #3e3e42 !important;
        color: #cccccc !important;
    }
    
    [data-theme="dark"] .code-block-container pre code {
        color: #cccccc !important;
        background: transparent !important;
    }

    .markdown-content ul,
    .markdown-content ol {
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content blockquote {
        border-left: 4px solid #007bff;
        padding-left: 1rem;
        margin-left: 0;
        color: #6c757d;
        font-style: italic;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-content th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    /* KaTeX Block Math Centering - Using our custom container */
    .markdown-content .math-display-container {
        text-align: center !important;
        margin: 1rem 0 !important;
        display: block !important;
        width: 100% !important;
    }
    
    .markdown-content .math-display-container .katex {
        display: inline-block !important;
    }

    .btn-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .card-header {
        background: var(--secondary-bg);
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
    }

    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        background: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        transition: var(--transition);
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        background: none;
    }

    .tab-content {
        background: var(--card-bg);
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: var(--box-shadow);
        color: var(--text-primary);
    }

    /* File Status list-group styling */
    .list-group-item {
        background-color: var(--card-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    .list-group.list-group-flush .list-group-item {
        background-color: var(--card-bg) !important;
    }
    .list-group-item .text-muted { color: var(--text-secondary) !important; }
    [data-theme="dark"] .badge.bg-light { background-color: #3c3c3c !important; color: #cccccc !important; border: 1px solid var(--border-color) !important; }

    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        color: var(--dark-color);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-content pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }

    .markdown-content code {
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* Code block copy button styling */
    .code-block-container {
        position: relative;
    }

    .copy-btn {
        opacity: 1;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        background: #fff;
        border-color: #007bff;
        color: #007bff;
    }

    .copy-btn.copied {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }

    /* Side-by-side layout enhancements */
    .editor-resize-container {
        min-height: 400px;
    }

    .monaco-editor-container {
        height: 400px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
    }

    /* Enhanced Code Editor Container (from test-solution.html) */
    .code-editor-container { 
        background: var(--secondary-bg); 
        border-radius: var(--border-radius); 
        padding: 0; 
        overflow: hidden; 
    }

    .code-editor-container textarea { 
        background: var(--card-bg); 
        border: none; 
        border-radius: 0; 
        color: var(--text-primary); 
    }

    /* Test results styling */
    #testResults .card {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
    }

    #testResults .card-header {
        background: var(--secondary-bg);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    #testResults pre {
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.8rem;
        margin-bottom: 0;
    }

    /* Verdict styling from test-solution.html */
    .verdict-AC { color: #28a745; font-weight: bold; }
    .verdict-WA { color: #dc3545; font-weight: bold; }
    .verdict-TLE { color: #ffc107; font-weight: bold; }
    .verdict-RTE { color: #fd7e14; font-weight: bold; }
    .verdict-CE { color: #6f42c1; font-weight: bold; }
    .verdict-PE { color: #20c997; font-weight: bold; }
    .verdict-JE { color: #6c757d; font-weight: bold; }
    
    .test-result-card {
        transition: all 0.2s;
    }
    
    .test-result-card:hover {
        transform: translateY(-1px);
    }

    /* Enhanced Recent Submissions Styling */
    #recent-submissions-content .submission-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }

    #recent-submissions-content .submission-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--primary-color);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #recent-submissions-content .submission-item:hover {
        background: var(--secondary-bg);
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    #recent-submissions-content .submission-item:hover::before {
        opacity: 1;
    }

    #recent-submissions-content .submission-meta {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex: 1;
    }

    #recent-submissions-content .verdict-badge {
        min-width: 65px;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 700;
        padding: 0.4rem 0.75rem;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #recent-submissions-content .submission-time {
        color: var(--text-secondary);
        font-size: 0.9rem;
        min-width: 120px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    #recent-submissions-content .submission-time i {
        opacity: 0.7;
        font-size: 0.8rem;
    }

    #recent-submissions-content .execution-time {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.95rem;
        min-width: 80px;
        text-align: right;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
        background: var(--secondary-bg);
        padding: 0.3rem 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    #recent-submissions-content .execution-time i {
        opacity: 0.8;
        font-size: 0.8rem;
    }

    #recent-submissions-content .submission-actions {
        display: flex;
        gap: 0.5rem;
    }

    #recent-submissions-content .submission-actions .btn {
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    #recent-submissions-content .submission-actions .btn-outline-primary:hover {
        background: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }

    #recent-submissions-content .submission-actions .btn-outline-secondary:hover {
        background: var(--secondary-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    [data-theme="dark"] #recent-submissions-content .submission-actions .btn-outline-primary:hover {
        background: var(--btn-primary) !important;
        border-color: var(--btn-primary) !important;
        color: white !important;
    }

    [data-theme="dark"] #recent-submissions-content .submission-actions .btn-outline-secondary:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        color: #cccccc !important;
    }

    #recent-submissions-content .test-stats {
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--secondary-bg);
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    #recent-submissions-content .test-stats i {
        opacity: 0.8;
        font-size: 0.75rem;
    }

    #recent-submissions-content .compile-time {
        color: var(--text-secondary);
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 500;
    }

    #recent-submissions-content .compile-time i {
        opacity: 0.7;
        font-size: 0.75rem;
    }

    /* Empty submissions state */
    #recent-submissions-content .empty-submissions {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-secondary);
    }

    #recent-submissions-content .empty-submissions i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }

    /* Dark mode adjustments */
    [data-theme="dark"] #recent-submissions-content .submission-item {
        border-color: var(--border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    [data-theme="dark"] #recent-submissions-content .submission-item:hover {
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    [data-theme="dark"] #recent-submissions-content .execution-time {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] #recent-submissions-content .test-stats {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* Enhanced Modal Styling - Same as My Submissions */
    .temp-submission-modal .modal-content {
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .temp-submission-modal .modal-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }

    [data-theme="dark"] .temp-submission-modal .modal-header {
        background: linear-gradient(135deg, var(--btn-primary), #094766);
    }

    .temp-submission-modal .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .temp-submission-modal .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }

    .temp-submission-modal .btn-close:hover {
        opacity: 1;
    }

    .temp-submission-modal .modal-body {
        padding: 2rem;
        background: var(--card-bg);
        border-radius: 0 0 12px 12px;
    }

    [data-theme="dark"] .temp-submission-modal .modal-content {
        background: var(--card-bg);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .temp-submission-modal .modal-body {
        background: var(--card-bg);
    }

    /* Enhanced Submission Modal Details */
    .temp-submission-modal .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .temp-submission-modal .meta-card {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        background: var(--secondary-bg);
        transition: all 0.3s ease;
        text-align: center;
    }

    .temp-submission-modal .meta-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .temp-submission-modal .meta-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .temp-submission-modal .meta-value {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .temp-submission-modal .meta-value a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .temp-submission-modal .meta-value a:hover {
        text-decoration: underline;
    }

    .temp-submission-modal .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .temp-submission-modal .section-header h6 {
        margin: 0;
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .temp-submission-modal .btn-copy {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .temp-submission-modal .btn-copy:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }

    .temp-submission-modal pre.code-block {
        max-height: 500px;
        overflow: auto;
        background: var(--code-bg, #f8f9fa);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
    }

    .temp-submission-modal pre.code-block code {
        background: transparent;
        border: none;
        padding: 0;
        color: inherit;
    }

    /* Dark mode for modal details */
    [data-theme="dark"] .temp-submission-modal .meta-card {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .temp-submission-modal .meta-card:hover {
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    [data-theme="dark"] .temp-submission-modal pre.code-block {
        background: #1e1e1e;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-theme="dark"] .temp-submission-modal .btn-copy {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: #cccccc !important;
    }

    [data-theme="dark"] .temp-submission-modal .btn-copy:hover {
        background: var(--btn-primary);
        border-color: var(--btn-primary);
        color: white !important;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .col-lg-6 {
            margin-bottom: 1rem;
        }
        
        .monaco-editor-container {
            height: 300px;
        }

        #recent-submissions-content .submission-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        #recent-submissions-content .submission-time,
        #recent-submissions-content .execution-time {
            min-width: auto;
        }
    }

    /* Floating Scroll Down Button - Fixed to viewport but constrained to section */
    .floating-scroll-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        cursor: pointer;
        z-index: 100;
        transition: opacity 0.3s ease, transform 0.1s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        opacity: 0;
        pointer-events: none;
    }
    
    /* Position left button differently from right button */
    #floatingScrollBtnLeft {
        right: auto;
        /* Left position will be set dynamically by JavaScript based on panel width */
    }

    .floating-scroll-btn.show {
        opacity: 1;
        pointer-events: auto;
    }

    .floating-scroll-btn:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        box-shadow: 0 3px 12px rgba(0, 123, 255, 0.3);
    }

    .floating-scroll-btn:active {
        box-shadow: 0 1px 6px rgba(0, 123, 255, 0.2);
    }

    /* Dark mode for floating button - matches card headers */
    [data-theme="dark"] .floating-scroll-btn {
        background: linear-gradient(135deg, var(--btn-primary), #094766);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .floating-scroll-btn:hover {
        background: linear-gradient(135deg, var(--btn-primary), #0a5878);
        border-color: rgba(255, 255, 255, 0.15);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
    }

    /* Responsive for mobile */
    @media (max-width: 768px) {
        .floating-scroll-btn {
            bottom: 1rem;
            right: 1rem;
            width: 44px;
            height: 44px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pt-4">
    
    <!-- Enhanced Breadcrumb -->
    {{ enhanced_breadcrumb([
        {'text': 'Dashboard', 'url': url_for('dashboard'), 'icon': 'fas fa-home'},
        {'text': problem.config.get('title', problem.slug), 'icon': 'fas fa-file-code'}
    ]) }}



    <!-- Enhanced Problem Header -->
    {{ problem_detail_header(problem, current_user, is_author, problem_data, author) }}

    <!-- Main Content: Resizable Side by Side Layout -->
    <div class="resizable-container-wrapper">
        <div class="resizable-container" id="resizableContainer">
            <!-- Left Panel: Problem Statement -->
            <div class="resizable-panel resizable-panel-left">
                <!-- Floating Scroll Button - Fixed to viewport but constrained to section -->
                <button id="floatingScrollBtnLeft" class="floating-scroll-btn" style="display: none;" title="Scroll to see more">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                {% call enhanced_card("Problem Statement", "fas fa-file-alt", []) %}
                    {% if statement_content %}
                        <!-- Hidden raw markdown for SEO (search engines can read this) -->
                        <div id="statement-content-seo" style="display: none;" aria-hidden="true">
                            {{ statement_content|safe }}
                        </div>
                    {% endif %}
                    
                    <!-- Visible formatted content (JavaScript will render here) -->
                    <div id="problemStatement">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-primary"></i>
                            <p class="mt-2 text-muted">Loading problem statement...</p>
                        </div>
                    </div>
                {% endcall %}
            </div>

            <!-- Resize Divider -->
            <div class="resize-divider" id="resizeDivider"></div>

            <!-- Right Panel: Solution Editor -->
            <div class="resizable-panel resizable-panel-right">
                <!-- Floating Scroll Button - Fixed to viewport but constrained to section -->
                <button id="floatingScrollBtn" class="floating-scroll-btn" style="display: none;" title="Scroll to see results below">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
            {% call enhanced_card("Solution Editor", "fas fa-code", [
                {'text': 'Clear', 'icon': 'fas fa-trash', 'class': 'btn-outline-secondary btn-sm', 'id': 'clearCodeBtn'},
                {'text': 'Template', 'icon': 'fas fa-file-code', 'class': 'btn-outline-info btn-sm', 'id': 'loadTemplateBtn'}
            ]) %}
                <div class="editor-resize-container">
                    <div class="monaco-editor-container" id="cpp-solution-editor"></div>
                    <div class="editor-resize-handle" id="cpp-solution-editor-resize-handle"></div>
                </div>
                
                <!-- Test Solution Controls -->
                <div class="mt-3 pt-3 border-top">
                    {% if current_user %}
                        <div class="d-flex gap-3 flex-wrap justify-content-between">
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn btn-run-samples btn-enhanced" id="runSampleBtn">
                                    <i class="fas fa-vial me-2"></i>Run Samples
                                </button>
                                <button class="btn btn-run-submit btn-enhanced" id="submitCodeBtn">
                                    <i class="fas fa-paper-plane me-2"></i>Submit
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-run-custom btn-enhanced" id="runCustomBtn">
                                    <i class="fas fa-keyboard me-2"></i>Run Custom Input
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            You need to <a href="{{ url_for('auth_login') }}" class="text-decoration-none">sign in</a> to run or submit
                        </div>
                    {% endif %}
                </div>

                <!-- Test Results Section (Inside Editor Card) -->
                <div id="testResults" class="mt-3" style="display: none;">
                    {% call enhanced_card("Test Results", "fas fa-chart-line", []) %}
                        <div id="testResultsContent">
                            <!-- Test results will be populated here -->
                        </div>
                    {% endcall %}
                </div>
                
                <!-- Enhanced Recent Submissions Section -->
                <div id="recentSubmissions" class="mt-3" style="display: none;">
                    {% call enhanced_card("Recent Submissions", "fas fa-history", [
                        {'text': 'View All', 'icon': 'fas fa-external-link-alt', 'class': 'btn-outline-primary btn-sm', 'onclick': 'viewAllSubmissionsForProblem()'}
                    ]) %}
                        <div id="recent-submissions-content">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    {% endcall %}
                </div>
            {% endcall %}
        </div>
    </div>
    
    <!-- Bottom Resize Divider for Height Adjustment -->
    <div class="resize-divider-bottom" id="resizeDividerBottom"></div>
</div>

</div>

<!-- Custom Input Modal -->
<div class="modal fade" id="customInputModal" tabindex="-1" aria-labelledby="customInputModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customInputModalLabel">
                    <i class="fas fa-keyboard me-2"></i>Run Custom Input
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <label for="customInput" class="form-label fw-bold">
                            <i class="fas fa-edit me-2"></i>Input
                        </label>
                        <textarea id="customInput" class="form-control font-monospace" 
                                  placeholder="Enter your test input here...&#10;&#10;Example:&#10;5&#10;1 2 3 4 5&#10;&#10;Tips:&#10; Each line should match your program's expected input format&#10; Use spaces or newlines as separators as needed&#10; Empty input is allowed for programs that don't need input"></textarea>
                    </div>
                    <div class="col-lg-6">
                        <label class="form-label fw-bold">
                            <i class="fas fa-terminal me-2"></i>Output
                        </label>
                        <div id="customOutput" class="font-monospace" style="white-space: pre-wrap;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="runCustomInputBtn">
                        <i class="fas fa-play me-1"></i>Run Code
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load dependencies first -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>

<!-- Monaco Editor JS (load after other dependencies) -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Monaco Editor Component JS -->
<script src="{{ url_for('static', filename='js/monaco-editor-component.js') }}"></script>
<script src="{{ url_for('static', filename='js/monaco-editor-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/submission-modal.js') }}"></script>

<script>
// Global variables
let solutionEditor = null;
let currentTestResults = null;

document.addEventListener('DOMContentLoaded', function() {
    // Load problem statement
    loadProblemStatement();

    // Initialize enhanced buttons
    initializeEnhancedButtons();

    // Initialize solution tester (like test-solution.html)
    setTimeout(() => {
        try {
            window.solutionTester = new SolutionTester();
        } catch (error) {
            console.error('Failed to initialize Solution Tester:', error);
        }
    }, 200);

    // Load recent submissions on page load
    loadRecentSubmissions();
});

function loadProblemStatement() {
    const statementDiv = document.getElementById('problemStatement');
    
    fetch(`/api/problem/{{ problem.slug }}/statement`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Use LaTeX-aware markdown conversion
                const htmlContent = convertMarkdownWithLatex(data.statement);
                statementDiv.innerHTML = htmlContent;
                enhanceCodeBlocks(statementDiv);
                if (window.renderMathInElement) {
                    renderMathInElement(statementDiv, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '\\[', right: '\\]', display: true },
                            { left: '\\(', right: '\\)', display: false },
                            { left: '$', right: '$', display: false }
                        ],
                        throwOnError: false,
                        displayMode: false,
                        output: 'html',
                        strict: false
                    });
                }
            } else {
                statementDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Problem statement could not be loaded. ${data.error || ''}
                    </div>
                    <h4>{{ problem.config.get('title', problem.slug) }}</h4>
                `;
            }
            
            // Update floating scroll button visibility for left panel
            setTimeout(() => {
                if (window.floatingScrollButtonLeft) {
                    window.floatingScrollButtonLeft.updateButtonVisibility();
                }
            }, 200);
        })
        .catch(error => {
            console.error('Statement loading error:', error);
            statementDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Problem statement file not found or could not be loaded.
                </div>
                <h4>{{ problem.config.get('title', problem.slug) }}</h4>
            `;
        });
}

function convertMarkdownWithLatex(markdown) {
    // Store LaTeX expressions with their placeholders
    const latexMap = new Map();
    let text = markdown;
    
    // Protect block math $$...$$
    text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
        const placeholder = `LATEXBLOCK${Date.now()}${Math.random()}LATEXBLOCK`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Protect inline math $...$
    text = text.replace(/\$([^$\n]+?)\$/g, (match) => {
        const placeholder = `LATEXINLINE${Date.now()}${Math.random()}LATEXINLINE`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Protect LaTeX delimited expressions \(...\) and \[...\]
    text = text.replace(/\\\([\s\S]*?\\\)/g, (match) => {
        const placeholder = `LATEXDELIM${Date.now()}${Math.random()}LATEXDELIM`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    text = text.replace(/\\\[[\s\S]*?\\\]/g, (match) => {
        const placeholder = `LATEXDELIM${Date.now()}${Math.random()}LATEXDELIM`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Process markdown with marked.js
    let html = marked.parse(text);
    
    // Restore LaTeX expressions with proper wrapping
    for (const [placeholder, latexContent] of latexMap) {
        let replacement = latexContent;
        
        // Wrap block math ($$...$$ and \[...\]) in a centering container
        if (latexContent.startsWith('$$') || latexContent.startsWith('\\[')) {
            replacement = `<div class="math-display-container">${latexContent}</div>`;
        }
        
        html = html.replace(new RegExp(placeholder, 'g'), replacement);
    }
    
    return `<div class="markdown-content">${html}</div>`;
}

function enhanceCodeBlocks(container) {
    container.querySelectorAll('pre > code').forEach(codeBlock => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-container position-relative mb-3';
        const pre = codeBlock.parentNode;
        pre.classList.add('bg-light', 'border', 'rounded', 'p-3', 'mb-0');
        pre.parentNode.replaceChild(wrapper, pre);
        wrapper.appendChild(pre);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-outline-secondary copy-btn position-absolute';
        copyBtn.style.top = '8px';
        copyBtn.style.right = '8px';
        copyBtn.style.padding = '4px 8px';
        copyBtn.style.fontSize = '12px';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.addEventListener('click', () => copyCodeBlock(codeBlock, copyBtn));
        wrapper.appendChild(copyBtn);
    });
}

function copyCodeBlock(codeElement, button) {
    const text = codeElement.textContent;
    navigator.clipboard.writeText(text).then(() => {
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i>';
        }, 2000);
    });
}

// Solution Test Page with Reusable Monaco Editor Component (from test-solution.html)
class SolutionTester {
    constructor() {
        this.cppEditor = null;
        this.init();
    }
    
    async init() {
        try {
            // Set up event listeners after a small delay to ensure DOM is ready
            setTimeout(() => {
                this.setupEventListeners();
            }, 100);
            
            // Create C++ Solution Editor using our reusable component
            this.cppEditor = MonacoEditorPresets.createCppSolutionEditor('cpp-solution-editor');
            solutionEditor = this.cppEditor; // Set global reference
            
            // Enable scroll propagation from Monaco to parent container
            setTimeout(() => {
                this.enableScrollPropagation();
            }, 300);
            
        } catch (error) {
            console.error('Failed to initialize Solution Tester:', error);
        }
    }
    
    enableScrollPropagation() {
        // Enable scroll propagation from Monaco editor to parent when at boundaries
        if (!this.cppEditor) {
            console.log(' Editor not ready for scroll propagation');
            return;
        }
        
        const editorContainer = document.getElementById('cpp-solution-editor');
        const scrollableParent = document.querySelector('.resizable-panel-right .card-body');
        
        if (!editorContainer || !scrollableParent) {
            console.log(' Container or parent not found');
            return;
        }
        
        console.log(' Setting up Monaco scroll propagation...');
        
        // Store editor reference for closure
        const editor = this.cppEditor;
        
        // Wheel event handler for scroll propagation
        const wheelHandler = (e) => {
            try {
                // Get current scroll position in editor
                const scrollTop = editor.getScrollTop();
                const scrollHeight = editor.getScrollHeight();
                const visibleHeight = editorContainer.offsetHeight;
                
                const atTop = scrollTop === 0;
                const atBottom = scrollTop + visibleHeight >= scrollHeight - 1;
                const scrollDown = e.deltaY > 0;
                const scrollUp = e.deltaY < 0;
                
                // Propagate scroll to parent when at boundaries
                if ((atBottom && scrollDown) || (atTop && scrollUp)) {
                    e.preventDefault();
                    e.stopPropagation();
                    scrollableParent.scrollBy({
                        top: e.deltaY,
                        behavior: 'auto'
                    });
                    console.log(' Boundary detected - propagating scroll to parent');
                }
            } catch (error) {
                console.error('Scroll propagation error:', error);
            }
        };
        
        // Attach to editor container and Monaco internal elements
        editorContainer.addEventListener('wheel', wheelHandler, { 
            passive: false, 
            capture: true 
        });
        
        // Also attach to Monaco's internal scrollable element after delay
        setTimeout(() => {
            const monacoScrollable = editorContainer.querySelector('.monaco-scrollable-element');
            if (monacoScrollable) {
                monacoScrollable.addEventListener('wheel', wheelHandler, { 
                    passive: false, 
                    capture: true 
                });
                console.log(' Scroll propagation enabled on Monaco internal elements');
            }
        }, 500);
        
        console.log(' Scroll propagation setup complete');
    }
    
    setupEventListeners() {
        // Load C++ template
        document.getElementById('loadTemplateBtn')?.addEventListener('click', () => {
            if (this.cppEditor) {
                // Get the default template from the preset and reload it
                const defaultTemplate = `#include <bits/stdc++.h>
using namespace std;
#define int long long
#define all(x) x.begin(), x.end()
#define pb push_back
const int MOD = 1000000007;
int n, m, k;
vector<int> a;

void solve()
{
    cin >> n;
    a.resize(n);
    for (auto &i : a)
        cin >> i;
}

signed main()
{
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cout.tie(nullptr);
    int t;
    cin >> t;
    while (t--)
        solve();
    return 0;
}`;
                this.cppEditor.setValue(defaultTemplate);
            }
        });
        
        // Clear code
        document.getElementById('clearCodeBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the code?')) {
                if (this.cppEditor) {
                    this.cppEditor.setValue('');
                }
            }
        });
        
        // Run samples only
        document.getElementById('runSampleBtn')?.addEventListener('click', () => {
            // Check if user is authenticated
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to run tests on problems.');
                return;
            }
            
            const code = this.getCode();
            
            if (!code.trim()) {
                alert('Please enter C++ code to test');
                return;
            }
            
            // Run only samples
            const categories = ['samples'];
            this.runAllTests(code, categories);
        });

        // Run custom input
        document.getElementById('runCustomBtn')?.addEventListener('click', () => {
            // Check if user is authenticated
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to run tests on problems.');
                return;
            }
            
            // Show the custom input modal
            const modal = new bootstrap.Modal(document.getElementById('customInputModal'));
            modal.show();
        });

        // Run custom input button in modal
        document.getElementById('runCustomInputBtn')?.addEventListener('click', () => {
            this.runCustomInput();
        });

        // Submit code - Enhanced to show full test results
        document.getElementById('submitCodeBtn')?.addEventListener('click', async () => {
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to submit.');
                return;
            }
            const btn = document.getElementById('submitCodeBtn');
            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            try {
                const code = this.getCode();
                if (!code.trim()) { 
                    alert('Please enter C++ code to submit'); 
                    return; 
                }
                
                // Use new endpoint that returns detailed results
                const res = await fetch(`/api/problem/{{ problem.slug }}/submit-with-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: 'cpp', code })
                });
                const data = await res.json();
                
                if (res.status === 409) {
                    // Duplicate submission
                    if (this.cppEditor && this.cppEditor.showAutoSaveNotification) {
                        this.cppEditor.showAutoSaveNotification('Duplicate submission: same code already submitted', 'info');
                    } else {
                        alert('Duplicate submission: same code already submitted.');
                    }
                } else if (data.success) {
                    // Display full test results if available
                    if (data.detailed_results) {
                        displayTestResults(data.detailed_results);
                        
                        // Scroll to results section
                        setTimeout(() => {
                            document.getElementById('testResults')?.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }, 100);
                    }
                    
                    // Show enhanced notification
                    const passRate = data.statistics?.pass_rate || 0;
                    const totalTests = data.statistics?.total_tests || 0;
                    const passed = data.statistics?.passed || 0;
                    const verdictEmoji = data.verdict === 'AC' ? '' : '';
                    const submissionIdShort = data.submission_id ? data.submission_id.slice(0, 8) : 'unknown';
                    const message = `${verdictEmoji} Submission #${submissionIdShort}... - ${data.verdict} (${passed}/${totalTests} tests passed, ${passRate}%)`;
                    
                    if (this.cppEditor && this.cppEditor.showAutoSaveNotification) {
                        this.cppEditor.showAutoSaveNotification(message, data.verdict === 'AC' ? 'success' : 'info');
                    } else {
                        alert(message);
                    }
                    
                    // Refresh submissions list
                    loadRecentSubmissions();
                } else {
                    // Error
                    if (this.cppEditor && this.cppEditor.showAutoSaveNotification) {
                        this.cppEditor.showAutoSaveNotification(data.error || 'Submission failed', 'info');
                    } else {
                        alert(data.error || 'Submission failed');
                    }
                }
            } catch (e) {
                console.error('Submission error:', e);
                if (this.cppEditor && this.cppEditor.showAutoSaveNotification) {
                    this.cppEditor.showAutoSaveNotification('Network error while submitting', 'info');
                } else {
                    alert('Network error while submitting');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = original;
            }
        });
    }
    
    getCode() {
        return this.cppEditor ? this.cppEditor.getValue() : '';
    }
    
    runAllTests(code, categories) {
        // Disable run button (only samples button exists now)
        const runBtn = document.getElementById('runSampleBtn');
        const originalText = runBtn.innerHTML;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        runBtn.disabled = true;
        
        fetch(`/api/problem/{{ problem.slug }}/test-solution`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                categories: categories
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTestResults(data.results);
            } else {
                displayError(data.error);
            }
        })
        .catch(error => {
            displayError(`Network error: ${error.message}`);
        })
        .finally(() => {
            // Restore run button
            runBtn.innerHTML = originalText;
            runBtn.disabled = false;
        });
    }

    runCustomInput() {
        const code = this.getCode();
        const customInput = document.getElementById('customInput').value;
        
        if (!code.trim()) {
            alert('Please enter C++ code to test');
            return;
        }
        
        if (!customInput.trim()) {
            alert('Please enter some input to test with');
            return;
        }
        
        // Disable run button and show loading
        const runBtn = document.getElementById('runCustomInputBtn');
        const originalText = runBtn.innerHTML;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
        runBtn.disabled = true;
        
        // Clear previous output
        const outputDiv = document.getElementById('customOutput');
        outputDiv.innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><div>Running your code...</div></div>';
        
        
        fetch(`/api/quick-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                input: customInput
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display output
                outputDiv.innerHTML = data.output || '<div class="text-muted">No output</div>';
                
            } else {
                // Display error
                outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i><strong>Error:</strong><br><pre>${data.error || 'Unknown error occurred'}</pre></div>`;
            }
        })
        .catch(error => {
            outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i><strong>Network Error:</strong><br>${error.message}</div>`;
        })
        .finally(() => {
            // Restore run button
            runBtn.innerHTML = originalText;
            runBtn.disabled = false;
        });
    }
}

// Helper function to safely escape strings for JavaScript template literals (from test-solution.html)
function escapeForJs(str) {
    if (!str) return '';
    return str
        .replace(/\\/g, '\\\\')   // Escape backslashes
        .replace(/`/g, '\\`')     // Escape backticks  
        .replace(/\$/g, '\\$')    // Escape dollar signs
        .replace(/"/g, '\\"')     // Escape double quotes
        .replace(/'/g, "\\'")     // Escape single quotes
        .replace(/\n/g, '\\n')    // Escape newlines
        .replace(/\r/g, '\\r')    // Escape carriage returns
        .replace(/\t/g, '\\t');   // Escape tabs
}

// Display test results (from test-solution.html)
function displayTestResults(results) {
    const testResultsDiv = document.getElementById('testResults');
    const testResultsContent = document.getElementById('testResultsContent');
    
    // Build results HTML
    let html = '';
    
    // Compilation result
    if (results.compilation.success) {
        html += `<div class="alert alert-success">
            <i class="fas fa-check-circle"></i> <strong>Compilation Successful</strong> 
            (${results.compilation.time_ms.toFixed(1)}ms)
        </div>`;
    } else {
        html += `<div class="alert alert-danger">
            <i class="fas fa-times-circle"></i> <strong>Compilation Failed</strong><br>
            <pre class="mt-2">${results.compilation.errors}</pre>
        </div>`;
        testResultsContent.innerHTML = html;
        testResultsDiv.style.display = 'block';
        return;
    }
    
    // Overall statistics
    const stats = results.statistics;
    html += `<div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">${stats.passed}</h4>
                    <small>Passed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-danger">${stats.failed}</h4>
                    <small>Failed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4>${stats.total_tests}</h4>
                    <small>Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4>${stats.pass_rate}%</h4>
                    <small>Pass Rate</small>
                </div>
            </div>
        </div>
    </div>`;
    
    // Enhanced category results with detailed failure information
    for (const [category, categoryResults] of Object.entries(results.test_results)) {
        if (categoryResults.length === 0) continue;
        
        const categoryStats = results.categories[category];
        const categoryClass = categoryStats.failed === 0 ? 'success' : 'danger';
        
        html += `<div class="card mb-3">
            <div class="card-header bg-${categoryClass} text-white">
                <h6 class="mb-0">
                    <i class="fas fa-vial"></i> ${category.charAt(0).toUpperCase() + category.slice(1)} 
                    (${categoryStats.passed}/${categoryStats.count} passed, ${categoryStats.avg_time_ms}ms avg)
                </h6>
            </div>
            <div class="card-body">`;
        
        // Show individual test results with enhanced debugging
        categoryResults.forEach(result => {
            const verdictClass = `verdict-${result.verdict}`;
            
            if (result.verdict === 'AC') {
                // Simple badge for passing tests
                html += `<span class="badge bg-success me-2 mb-2">
                    Test ${String(result.test_num).padStart(2, '0')}: ${result.verdict} (${result.time_ms.toFixed(1)}ms)
                </span>`;
            } else {
                // Enhanced failure display with all debugging info
                html += `<div class="border border-danger rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-danger mb-3">
                                <span class="${verdictClass}">Test ${String(result.test_num).padStart(2, '0')}: ${result.verdict}</span>
                                <small class="text-muted ms-2">(${result.time_ms.toFixed(1)}ms)</small>
                            </h6>
                            
                            <div class="row">
                                <!-- Input Column -->
                                <div class="col-md-4">
                                    <h6 class="text-info mb-2"> Input:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small">${result.input_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.input_full && result.input_full.length > 50 ? 
                                        `<button class="btn btn-sm btn-outline-info mt-2" onclick="showFullContent('Test ${result.test_num} Input', \`${escapeForJs(result.input_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full Input
                                        </button>` : ''}
                                </div>
                                
                                <!-- Expected Column -->
                                <div class="col-md-4">
                                    <h6 class="text-success mb-2"> Expected:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small text-success">${result.expected_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.expected_full && result.expected_full.length > 20 ? 
                                        `<button class="btn btn-sm btn-outline-success mt-2" onclick="showFullContent('Test ${result.test_num} Expected Output', \`${escapeForJs(result.expected_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full
                                        </button>` : ''}
                                </div>
                                
                                <!-- Actual Column -->
                                <div class="col-md-4">
                                    <h6 class="text-danger mb-2"> Your Output:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small text-danger">${result.actual_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.actual_full && result.actual_full.length > 20 ? 
                                        `<button class="btn btn-sm btn-outline-danger mt-2" onclick="showFullContent('Test ${result.test_num} Your Output', \`${escapeForJs(result.actual_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full
                                        </button>` : ''}
                                </div>
                            </div>
                            
                            <!-- Details and Actions -->
                            <div class="row mt-3">
                                <div class="col-md-8">
                                    ${result.details ? `<small class="text-muted"><i class="fas fa-info-circle"></i> <strong>Details:</strong> ${result.details}</small>` : ''}
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyTestCase(\`${escapeForJs(result.input_full || '')}\`)">
                                        <i class="fas fa-copy"></i> Copy Input
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        });
        
        html += '</div></div>';
    }
    
    testResultsContent.innerHTML = html;
    testResultsDiv.style.display = 'block';
    
    // Scroll to results
    testResultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Update floating scroll button visibility
    setTimeout(() => {
        if (window.floatingScrollButton) {
            window.floatingScrollButton.updateButtonVisibility();
        }
    }, 100);
}


function initializeEnhancedButtons() {
    // Add hover effects to enhanced buttons
    document.querySelectorAll('.btn-enhanced').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

// Toggle problem visibility in header
async function toggleVisibilityInHeader(slug, isCurrentlyPublic) {
    try {
        const response = await fetch(`/api/problems/${slug}/toggle-visibility`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the toggle button in header
            const toggleBtn = document.getElementById(`toggle-visibility-btn-${slug}`);
            
            if (result.is_public) {
                // Problem is now public, button should show "Make Private" (warning style)
                toggleBtn.innerHTML = '<i class="fas fa-lock me-1"></i>Make Private';
                toggleBtn.className = 'btn btn-warning btn-enhanced';
                toggleBtn.setAttribute('onclick', `toggleVisibilityInHeader('${slug}', true)`);
                toggleBtn.title = 'Make Private';
            } else {
                // Problem is now private, button should show "Make Public" (success style)
                toggleBtn.innerHTML = '<i class="fas fa-globe me-1"></i>Make Public';
                toggleBtn.className = 'btn btn-success btn-enhanced';
                toggleBtn.setAttribute('onclick', `toggleVisibilityInHeader('${slug}', false)`);
                toggleBtn.title = 'Make Public';
            }
            
            // Success - no message needed, button change is enough feedback
        } else {
            console.error('Failed to update visibility:', result.error);
        }
    } catch (error) {
        console.error('Error toggling visibility:', error);
    }
}

function deleteProblem(slug) {
    if (confirm('Are you sure you want to delete this problem? This action cannot be undone.')) {
        fetch(`/api/problems/${slug}/delete`, { method: 'DELETE' })
            .then(async response => {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (err) {
                    throw new Error(text);
                }
            })
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ url_for('dashboard') }}';
                } else {
                    alert(data.error || 'Failed to delete problem');
                }
            })
            .catch(error => {
                alert('Error deleting problem: ' + error);
            });
    }
}

function exportProblem(slug) {
    // Placeholder for export functionality
    alert('Export functionality will be implemented soon!');
}

// Multi-user functionality
async function toggleVisibility() {
    try {
        const response = await fetch(`/api/problems/{{ problem.slug }}/toggle-visibility`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the page to reflect changes
            location.reload();
        } else {
            alert(result.error || 'Failed to update visibility');
        }
    } catch (error) {
        console.error('Error toggling visibility:', error);
        alert('Failed to update visibility');
    }
}

// Copy problem link to clipboard
function copyProblemLink(slug) {
    const problemUrl = window.location.origin + '/problem/' + slug;
    
    // Use the modern Clipboard API if available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(problemUrl).then(() => {
            showLinkCopiedNotification();
        }).catch(err => {
            console.error('Failed to copy link: ', err);
            fallbackCopyTextToClipboard(problemUrl);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(problemUrl);
    }
}

// Fallback copy method for older browsers
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showLinkCopiedNotification();
        } else {
            console.error('Fallback: Copying text command was unsuccessful');
        }
    } catch (err) {
        console.error('Fallback: Unable to copy', err);
    }
    
    document.body.removeChild(textArea);
}

// Show notification when link is copied
function showLinkCopiedNotification() {
    // Create or update notification element
    let notification = document.getElementById('link-copied-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'link-copied-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;
        document.body.appendChild(notification);
    }
    
    // Set message and show notification
    notification.innerHTML = '<i class="fas fa-check me-2"></i>Problem link copied to clipboard!';
    notification.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
    }, 3000);
}

// Resizable panels functionality
class ResizablePanels {
    constructor() {
        this.isDragging = false;
        this.isHeightDragging = false;
        this.startX = 0;
        this.startY = 0;
        this.startLeftWidth = 0;
        this.startContainerHeight = 0;
        this.container = null;
        this.leftPanel = null;
        this.rightPanel = null;
        this.divider = null;
        this.bottomDivider = null;
        
        this.init();
    }
    
    init() {
        this.container = document.querySelector('.resizable-container');
        this.leftPanel = document.querySelector('.resizable-panel-left');
        this.rightPanel = document.querySelector('.resizable-panel-right');
        this.divider = document.getElementById('resizeDivider');
        this.bottomDivider = document.getElementById('resizeDividerBottom');
        
        if (!this.container || !this.leftPanel || !this.rightPanel || !this.divider || !this.bottomDivider) {
            return;
        }
        
        // Load saved panel sizes from localStorage
        this.loadPanelSizes();
        
        // Add event listeners for width resizing
        this.divider.addEventListener('mousedown', this.startDrag.bind(this));
        
        // Add event listeners for height resizing
        this.bottomDivider.addEventListener('mousedown', this.startHeightDrag.bind(this));
        
        // Global mouse events
        document.addEventListener('mousemove', this.drag.bind(this));
        document.addEventListener('mouseup', this.stopDrag.bind(this));
        
        // Handle window resize
        window.addEventListener('resize', this.handleWindowResize.bind(this));
        
        // Prevent text selection during drag
        document.addEventListener('selectstart', this.preventSelection.bind(this));
    }
    
    startDrag(e) {
        this.isDragging = true;
        this.startX = e.clientX;
        this.startLeftWidth = this.leftPanel.offsetWidth;
        
        this.divider.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    }
    
    startHeightDrag(e) {
        this.isHeightDragging = true;
        this.startY = e.clientY;
        this.startContainerHeight = this.container.offsetHeight;
        
        this.bottomDivider.classList.add('dragging');
        document.body.style.cursor = 'row-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    }
    
    drag(e) {
        if (this.isDragging) {
            this.dragWidth(e);
        } else if (this.isHeightDragging) {
            this.dragHeight(e);
        }
    }
    
    dragWidth(e) {
        const deltaX = e.clientX - this.startX;
        const containerWidth = this.container.offsetWidth;
        const dividerWidth = this.divider.offsetWidth;
        
        let newLeftWidth = this.startLeftWidth + deltaX;
        
        // Enforce minimum and maximum widths
        const minWidth = 300;
        const maxLeftWidth = containerWidth * 0.8 - dividerWidth;
        const maxRightWidth = containerWidth - minWidth - dividerWidth;
        
        newLeftWidth = Math.max(minWidth, Math.min(newLeftWidth, maxLeftWidth));
        newLeftWidth = Math.min(newLeftWidth, maxRightWidth);
        
        // Calculate percentage for flex-basis
        const leftPercentage = (newLeftWidth / containerWidth) * 100;
        
        this.leftPanel.style.flexBasis = `${leftPercentage}%`;
        
        // Update left button position during drag (smooth repositioning)
        if (window.floatingScrollButtonLeft) {
            window.floatingScrollButtonLeft.updateButtonVisibility();
        }
        
        e.preventDefault();
    }
    
    dragHeight(e) {
        const deltaY = e.clientY - this.startY;
        let newHeight = this.startContainerHeight + deltaY;
        
        // Enforce minimum and maximum heights
        const minHeight = 400;
        const maxHeight = window.innerHeight * 10; // Remove practical limit - allow very large heights
        
        newHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
        
        // Apply the new height with !important to override any CSS
        this.container.style.setProperty('height', `${newHeight}px`, 'important');
        this.container.style.setProperty('max-height', 'none', 'important');
        this.container.style.setProperty('min-height', 'auto', 'important');
        
        e.preventDefault();
    }
    
    stopDrag() {
        if (!this.isDragging && !this.isHeightDragging) return;
        
        if (this.isDragging) {
            this.isDragging = false;
            this.divider.classList.remove('dragging');
        }
        
        if (this.isHeightDragging) {
            this.isHeightDragging = false;
            this.bottomDivider.classList.remove('dragging');
        }
        
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save the current panel sizes
        this.savePanelSizes();
        
        // Trigger Monaco editor resize if it exists
        this.triggerEditorResize();
        
        // Update floating button positions after resize
        if (window.floatingScrollButtonLeft) {
            window.floatingScrollButtonLeft.updateButtonVisibility();
        }
        if (window.floatingScrollButton) {
            window.floatingScrollButton.updateButtonVisibility();
        }
    }
    
    preventSelection(e) {
        if (this.isDragging || this.isHeightDragging) {
            e.preventDefault();
        }
    }
    
    handleWindowResize() {
        // Recalculate panel sizes on window resize
        const containerWidth = this.container.offsetWidth;
        const currentLeftWidth = this.leftPanel.offsetWidth;
        const leftPercentage = (currentLeftWidth / containerWidth) * 100;
        
        // Ensure panels stay within bounds
        const clampedPercentage = Math.max(20, Math.min(80, leftPercentage));
        this.leftPanel.style.flexBasis = `${clampedPercentage}%`;
        
        // Trigger editor resize
        setTimeout(() => this.triggerEditorResize(), 100);
    }
    
    savePanelSizes() {
        const containerWidth = this.container.offsetWidth;
        const leftWidth = this.leftPanel.offsetWidth;
        const leftPercentage = (leftWidth / containerWidth) * 100;
        const containerHeight = this.container.offsetHeight;
        
        localStorage.setItem('problemPageLeftPanelWidth', leftPercentage.toString());
        localStorage.setItem('problemPageContainerHeight', containerHeight.toString());
    }
    
    loadPanelSizes() {
        // Load width
        const savedWidth = localStorage.getItem('problemPageLeftPanelWidth');
        if (savedWidth) {
            const percentage = parseFloat(savedWidth);
            if (percentage >= 20 && percentage <= 80) {
                this.leftPanel.style.flexBasis = `${percentage}%`;
            }
        }
        
        // Load height
        const savedHeight = localStorage.getItem('problemPageContainerHeight');
        if (savedHeight) {
            const height = parseFloat(savedHeight);
            const minHeight = 400;
            const maxHeight = window.innerHeight * 2; // Remove practical limit - allow very large heights
            
            if (height >= minHeight && height <= maxHeight) {
                this.container.style.setProperty('height', `${height}px`, 'important');
                this.container.style.setProperty('max-height', 'none', 'important');
                this.container.style.setProperty('min-height', 'auto', 'important');
            }
        }
    }
    
    triggerEditorResize() {
        // Trigger Monaco editor resize if it exists
        if (window.cppEditor && typeof window.cppEditor.layout === 'function') {
            setTimeout(() => {
                window.cppEditor.layout();
            }, 50);
        }
        
        // Also trigger resize event for other components that might need it
        window.dispatchEvent(new Event('resize'));
    }
}

// Initialize resizable panels when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize on desktop (not mobile)
    if (window.innerWidth > 768) {
        new ResizablePanels();
    }
});

// Helper functions for displaying results (from test-solution.html)
function showFullContent(title, content) {
    // Create a simple modal for viewing full content
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(\`${escapeForJs(content)}\`)">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                    </div>
                    <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"><code>${content}</code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Remove modal from DOM when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function copyTestCase(content) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
            // Could add a toast notification here
        });
    }
}

function copyToClipboard(content) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
            // Could add a toast notification here
        });
    }
}

function displayError(error) {
    const testResultsDiv = document.getElementById('testResults');
    const testResultsContent = document.getElementById('testResultsContent');
    testResultsContent.innerHTML = `<div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${error}
    </div>`;
    
    testResultsDiv.style.display = 'block';
}

function normalizeTimestamp(ts) {
    if (!ts) return '';
    let value = String(ts).trim();
    if (!value) return '';
    if (value.includes(' ')) {
        value = value.replace(' ', 'T');
    }
    if (!/[zZ]|[+-]\d{2}:\d{2}$/.test(value)) {
        value = `${value}Z`;
    }
    return value;
}

async function loadRecentSubmissions() {
    try {
        const res = await fetch(`/api/problem/{{ problem.slug }}/submissions?page=1&limit=8`);
        const data = await res.json();
        const section = document.getElementById('recentSubmissions');
        const content = document.getElementById('recent-submissions-content');
        
        if (!data.success || !data.items || data.items.length === 0) {
            if (section) section.style.display = 'none';
            return;
        }
        
        if (section) section.style.display = '';
        
        let html = '';
        data.items.forEach((submission, index) => {
            const verdict = (submission.verdict || submission.status || '').toUpperCase();
            const normalizedCreated = normalizeTimestamp(submission.created_at);
            const when = normalizedCreated
                ? new Date(normalizedCreated).toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                })
                : 'Recently';
            const timeAgo = normalizedCreated ? getTimeAgo(normalizedCreated) : '';
            
            // Verdict badge styling
            let badgeClass = 'bg-secondary';
            if (verdict === 'AC') badgeClass = 'bg-success';
            else if (verdict === 'WA') badgeClass = 'bg-danger';
            else if (verdict === 'TLE') badgeClass = 'bg-warning text-dark';
            else if (verdict === 'RTE') badgeClass = 'bg-warning';
            else if (verdict === 'CE') badgeClass = 'bg-secondary';
            else if (verdict === 'PE') badgeClass = 'bg-info';
            
            // Parse summary for additional info
            let summary = null;
            let testStats = '';
            try {
                if (submission.result_summary_json) {
                    summary = JSON.parse(submission.result_summary_json);
                    if (summary.statistics) {
                        const s = summary.statistics;
                        testStats = `${s.passed}/${s.total_tests} passed`;
                    }
                }
            } catch(e) {
                // Try to extract basic stats from corrupted JSON if possible
                if (submission.result_summary_json && submission.result_summary_json.includes('"statistics"')) {
                    try {
                        const match = submission.result_summary_json.match(/"statistics":\s*{[^}]*"total_tests":\s*(\d+)[^}]*"passed":\s*(\d+)[^}]*"failed":\s*(\d+)/);
                        if (match) {
                            const total = parseInt(match[1]);
                            const passed = parseInt(match[2]);
                            testStats = `${passed}/${total} passed`;
                        }
                    } catch(e2) {
                        // If even regex parsing fails, continue without stats
                    }
                }
            }

            // Determine status indicator
            let statusIcon = 'fas fa-question-circle';
            let statusColor = 'text-muted';
            if (verdict === 'AC') {
                statusIcon = 'fas fa-check-circle';
                statusColor = 'text-success';
            } else if (verdict === 'WA') {
                statusIcon = 'fas fa-times-circle';
                statusColor = 'text-danger';
            } else if (verdict === 'TLE') {
                statusIcon = 'fas fa-clock';
                statusColor = 'text-warning';
            } else if (verdict === 'CE') {
                statusIcon = 'fas fa-exclamation-triangle';
                statusColor = 'text-secondary';
            }

            html += `
                <div class="submission-item">
                    <div class="submission-meta">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge ${badgeClass} verdict-badge">${verdict || ''}</span>
                            <i class="${statusIcon} ${statusColor}"></i>
                        </div>
                        <div class="submission-time">
                            <i class="fas fa-clock me-1"></i>
                            <span title="${when}">${timeAgo || when}</span>
                        </div>
                        ${testStats ? `
                            <div class="test-stats">
                                <i class="fas fa-vial me-1"></i>
                                <span>${testStats}</span>
                            </div>
                        ` : ''}
                        <div class="execution-time">
                            <i class="fas fa-stopwatch me-1"></i>
                            <span>${submission.time_ms ? submission.time_ms + 'ms' : ''}</span>
                        </div>
                        ${submission.compile_time_ms ? `
                            <div class="compile-time">
                                <i class="fas fa-hammer me-1"></i>
                                <span>${submission.compile_time_ms}ms</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="submission-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="SubmissionModal.show('${submission.id}')" title="View Details">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        ${submission.source_code ? `
                            <button class="btn btn-sm btn-outline-secondary" onclick="copySubmissionCode('${submission.id}')" title="Copy Code">
                                <i class="fas fa-copy"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        // Add info text if there are more submissions (no button)
        if (data.total > data.items.length) {
            html += `
                <div class="text-center mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="fas fa-info-circle text-muted"></i>
                        <small class="text-muted">Showing ${data.items.length} of ${data.total} submissions</small>
                    </div>
                </div>
            `;
        }
        
        content.innerHTML = html;
        
        // Update floating scroll button visibility
        setTimeout(() => {
            if (window.floatingScrollButton) {
                window.floatingScrollButton.updateButtonVisibility();
            }
        }, 100);
        
    } catch (e) {
        const section = document.getElementById('recentSubmissions');
        if (section) section.style.display = 'none';
    }
}

function getTimeAgo(dateString) {
    try {
        const normalized = normalizeTimestamp(dateString);
        if (!normalized) return '';
        const date = new Date(normalized);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return '';
    }
}

// Copy submission code directly
async function copySubmissionCode(submissionId) {
    try {
        const res = await fetch(`/api/submissions/${submissionId}`);
        const data = await res.json();
        if (data.success && data.submission.source_code) {
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(data.submission.source_code);
                // Show temporary feedback
                const btn = event.target.closest('button');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 1000);
            }
        }
    } catch (e) {
        console.error('Failed to copy code:', e);
    }
}

// Navigate to My Submissions with current problem as search filter
function viewAllSubmissionsForProblem() {
    const problemSlug = '{{ problem.slug }}';
    window.location.href = `/my-submissions?search=${encodeURIComponent(problemSlug)}`;
}

// Floating Scroll Button Handler
class FloatingScrollButton {
    constructor() {
        this.button = document.getElementById('floatingScrollBtn');
        this.rightPanel = document.querySelector('.resizable-panel-right .card-body');
        
        if (!this.button || !this.rightPanel) {
            console.log('Floating scroll button not initialized - elements missing');
            return;
        }
        
        this.init();
    }
    
    init() {
        // Show/hide button based on scroll position
        this.rightPanel.addEventListener('scroll', () => {
            this.updateButtonVisibility();
        });
        
        // Update on window scroll (for section visibility check)
        window.addEventListener('scroll', () => {
            this.updateButtonVisibility();
        }, { passive: true });
        
        // Click handler - scroll to next section (test results or submissions)
        this.button.addEventListener('click', () => {
            this.scrollToNextSection();
        });
        
        // Initial check
        setTimeout(() => {
            this.updateButtonVisibility();
        }, 500);
        
        console.log(' Floating scroll button initialized');
    }
    
    updateButtonVisibility() {
        const scrollTop = this.rightPanel.scrollTop;
        const scrollHeight = this.rightPanel.scrollHeight;
        const clientHeight = this.rightPanel.clientHeight;
        
        // Calculate how much room is left to scroll
        const scrollRemaining = scrollHeight - (scrollTop + clientHeight);
        
        // Check if section is in viewport (constrain button to section)
        const panel = document.querySelector('.resizable-panel-right');
        const panelRect = panel.getBoundingClientRect();
        const inViewport = panelRect.top < window.innerHeight && panelRect.bottom > 0;
        
        // Show button only if: has scrollable content AND section is in viewport
        if (scrollHeight > clientHeight + 50 && inViewport) {
            this.button.style.display = 'flex';
            this.button.classList.add('show');
            
            // Constrain button to stay within section bounds
            const sectionBottom = panelRect.bottom;
            const buttonNaturalBottom = window.innerHeight - 32; // bottom: 2rem from viewport
            
            // If section bottom is above where button would naturally be
            if (sectionBottom < buttonNaturalBottom) {
                // Calculate offset to keep button inside section (with padding)
                const offset = buttonNaturalBottom - sectionBottom + 16;
                this.button.style.transform = `translateY(-${offset}px)`;
            } else {
                // Section extends below button position, use natural position
                this.button.style.transform = 'translateY(0)';
            }
            
            // Change icon based on position
            const icon = this.button.querySelector('i');
            if (scrollRemaining < 100) {
                // At or near bottom - show up arrow
                icon.className = 'fas fa-chevron-up';
                this.button.title = 'Scroll to top';
            } else {
                // Not at bottom - show down arrow
                icon.className = 'fas fa-chevron-down';
                this.button.title = 'Scroll to bottom';
            }
        } else {
            // No scrollable content or section out of viewport - hide button
            this.button.classList.remove('show');
            setTimeout(() => {
                if (!this.button.classList.contains('show')) {
                    this.button.style.display = 'none';
                }
            }, 300);
        }
    }
    
    scrollToNextSection() {
        const scrollTop = this.rightPanel.scrollTop;
        const scrollHeight = this.rightPanel.scrollHeight;
        const clientHeight = this.rightPanel.clientHeight;
        const scrollRemaining = scrollHeight - (scrollTop + clientHeight);
        
        if (scrollRemaining < 100) {
            // At bottom - scroll to top
            this.rightPanel.scrollTo({ 
                top: 0, 
                behavior: 'smooth' 
            });
        } else {
            // Not at bottom - scroll to bottom
            const targetScroll = scrollHeight - clientHeight;
            this.rightPanel.scrollTo({ 
                top: targetScroll, 
                behavior: 'smooth' 
            });
        }
    }
}

// Floating Scroll Button for Problem Statement (Left Panel)
class FloatingScrollButtonLeft {
    constructor() {
        this.button = document.getElementById('floatingScrollBtnLeft');
        this.leftPanel = document.querySelector('.resizable-panel-left .card-body');
        
        if (!this.button || !this.leftPanel) {
            console.log('Floating scroll button (left) not initialized - elements missing');
            return;
        }
        
        this.init();
    }
    
    init() {
        // Show/hide button based on scroll position
        this.leftPanel.addEventListener('scroll', () => {
            this.updateButtonVisibility();
        });
        
        // Update on window scroll (for section visibility check)
        window.addEventListener('scroll', () => {
            this.updateButtonVisibility();
        }, { passive: true });
        
        // Click handler - scroll to bottom
        this.button.addEventListener('click', () => {
            this.scrollToBottom();
        });
        
        // Initial check
        setTimeout(() => {
            this.updateButtonVisibility();
        }, 500);
        
        console.log(' Floating scroll button (left) initialized');
    }
    
    updateButtonVisibility() {
        const scrollTop = this.leftPanel.scrollTop;
        const scrollHeight = this.leftPanel.scrollHeight;
        const clientHeight = this.leftPanel.clientHeight;
        
        // Calculate how much room is left to scroll
        const scrollRemaining = scrollHeight - (scrollTop + clientHeight);
        
        // Check if section is in viewport (constrain button to section)
        const panel = document.querySelector('.resizable-panel-left');
        const panelRect = panel.getBoundingClientRect();
        const inViewport = panelRect.top < window.innerHeight && panelRect.bottom > 0;
        
        // Show button only if: has scrollable content AND section is in viewport
        if (scrollHeight > clientHeight + 50 && inViewport) {
            this.button.style.display = 'flex';
            this.button.classList.add('show');
            
            // Dynamically position button based on left panel width (adjusts with resizer)
            const leftPanelWidth = panel.offsetWidth;
            this.button.style.left = `${leftPanelWidth - 66}px`; // 66px = margin + half button
            
            // Constrain button to stay within section bounds
            const sectionBottom = panelRect.bottom;
            const buttonNaturalBottom = window.innerHeight - 32; // bottom: 2rem from viewport
            
            // If section bottom is above where button would naturally be
            if (sectionBottom < buttonNaturalBottom) {
                // Calculate offset to keep button inside section (with padding)
                const offset = buttonNaturalBottom - sectionBottom + 16;
                this.button.style.transform = `translateY(-${offset}px)`;
            } else {
                // Section extends below button position, use natural position
                this.button.style.transform = 'translateY(0)';
            }
            
            // Change icon based on position
            const icon = this.button.querySelector('i');
            if (scrollRemaining < 100) {
                // At or near bottom - show up arrow
                icon.className = 'fas fa-chevron-up';
                this.button.title = 'Scroll to top';
            } else {
                // Not at bottom - show down arrow
                icon.className = 'fas fa-chevron-down';
                this.button.title = 'Scroll to bottom';
            }
        } else {
            // No scrollable content or section out of viewport - hide button
            this.button.classList.remove('show');
            setTimeout(() => {
                if (!this.button.classList.contains('show')) {
                    this.button.style.display = 'none';
                }
            }, 300);
        }
    }
    
    scrollToBottom() {
        const scrollTop = this.leftPanel.scrollTop;
        const scrollHeight = this.leftPanel.scrollHeight;
        const clientHeight = this.leftPanel.clientHeight;
        const scrollRemaining = scrollHeight - (scrollTop + clientHeight);
        
        if (scrollRemaining < 100) {
            // At bottom - scroll to top
            this.leftPanel.scrollTo({ 
                top: 0, 
                behavior: 'smooth' 
            });
        } else {
            // Not at bottom - scroll to bottom
            const targetScroll = scrollHeight - clientHeight;
            this.leftPanel.scrollTo({ 
                top: targetScroll, 
                behavior: 'smooth' 
            });
        }
    }
}

// Initialize floating scroll buttons for both panels
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        window.floatingScrollButtonLeft = new FloatingScrollButtonLeft();
        window.floatingScrollButton = new FloatingScrollButton();
    }, 1000);
});

// Use shared submission modal component
</script>
{% endblock %}
