{% extends "layouts/base.html" %}
{% from "layouts/components.html" import enhanced_breadcrumb, problem_detail_header, enhanced_card, file_status_indicator, test_case_summary %}

{% block title %}{{ problem.config.get('title', problem.slug) }} - ShahOJ{% endblock %}

{% block extra_css %}
<!-- Monaco Editor Component CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/monaco-editor-component.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body { background-color: var(--primary-bg); }

    /* Enhanced Layout */
    .edit-container {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    /* Progress Bar */
    .progress-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    /* Enhanced Buttons */
    .btn-enhanced {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    /* Enhanced Run Test Buttons */
    .btn-run-all {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-run-all:hover {
        background: linear-gradient(135deg, #218838, #1ea085);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
    }

    .btn-run-all:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .btn-run-samples {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-run-samples:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        color: white;
    }

    .btn-run-samples:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .btn-run-custom {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-run-custom:hover {
        background: linear-gradient(135deg, #5a32a3, #4c2a85);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        color: white;
    }

    .btn-run-custom:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .btn-run-all {
        background: linear-gradient(135deg, #198754, #157347);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
    }

    [data-theme="dark"] .btn-run-all:hover {
        background: linear-gradient(135deg, #146c43, #0f5132);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.5);
    }

    [data-theme="dark"] .btn-run-samples {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    }

    [data-theme="dark"] .btn-run-samples:hover {
        background: linear-gradient(135deg, #0a58ca, #084298);
        box-shadow: 0 6px 20px rgba(13, 110, 253, 0.5);
    }

    [data-theme="dark"] .btn-run-custom {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    [data-theme="dark"] .btn-run-custom:hover {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
    }

    /* Button loading state */
    .btn-run-all:disabled,
    .btn-run-samples:disabled,
    .btn-run-custom:disabled {
        opacity: 0.7;
        transform: none;
        cursor: not-allowed;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .btn-run-all,
        .btn-run-samples,
        .btn-run-custom {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }
    }

    /* Custom Input Modal Styling */
    .modal-xl {
        max-width: 95vw;
    }
    
    @media (min-width: 1200px) {
        .modal-xl {
            max-width: 1400px;
        }
    }
    
    #customInputModal .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    #customInputModal .modal-header {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }
    
    #customInputModal .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    #customInputModal .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    
    #customInputModal .btn-close:hover {
        opacity: 1;
    }
    
    #customInputModal .modal-body {
        padding: 2rem;
        background: var(--card-bg);
    }
    
    #customInputModal .form-label {
        color: var(--text-primary);
        font-size: 1rem;
        margin-bottom: 0.75rem;
    }
    
    #customInputModal #customInput {
        background: var(--input-bg, #f8f9fa) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.95rem;
        line-height: 1.4;
        resize: vertical;
        min-height: 300px;
        height: 90%;
        width: 100%;
        display: block;
        transition: border-color 0.3s ease;
    }
    
    #customInputModal #customInput:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
        outline: none;
    }
    
    #customInputModal #customInput::placeholder {
        color: var(--text-muted, #6c757d);
        opacity: 0.7;
    }
    
    #customInputModal #customOutput {
        background: var(--code-bg, #f8f9fa) !important;
        border: 2px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.9rem;
        line-height: 1.4;
        min-height: 300px;
        height: 90%;
        width: 100%;
        display: block;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    #customInputModal .modal-footer {
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 12px 12px;
        padding: 1.5rem;
    }
    
    #customInputModal .btn-primary {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    #customInputModal .btn-primary:hover {
        background: linear-gradient(135deg, #5a32a3, #4c2a85);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
    }
    
    #customInputModal .btn-secondary {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    #customInputModal .btn-secondary:hover {
        background: var(--hover-bg);
        transform: translateY(-1px);
    }
    
    /* Dark mode specific styles */
    [data-theme="dark"] #customInputModal .modal-content {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    [data-theme="dark"] #customInputModal .modal-header {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    [data-theme="dark"] #customInputModal #customInput {
        background: var(--input-bg, #2d3748) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] #customInputModal #customInput:focus {
        border-color: #8b5cf6 !important;
        box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25) !important;
    }
    
    [data-theme="dark"] #customInputModal #customOutput {
        background: var(--code-bg, #1a202c) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] #customInputModal .btn-primary {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    [data-theme="dark"] #customInputModal .btn-primary:hover {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    [data-theme="dark"] #customInputModal .btn-secondary {
        background: var(--secondary-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
    
    [data-theme="dark"] #customInputModal .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: var(--border-color);
    }

    /* Markdown Content Styling */
    .markdown-content {
        line-height: 1.6;
        color: var(--text-primary);
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: var(--text-primary);
        font-weight: 600;
    }

    .markdown-content h1 { border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }

    .markdown-content h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem; }

    .markdown-content code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background-color: var(--secondary-bg) !important;
        border: 1px solid var(--border-color) !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        overflow-x: auto;
    }

    /* Code blocks styling - override Bootstrap's bg-light in dark mode */
    .code-block-container pre {
        background-color: var(--code-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .code-block-container pre.bg-light {
        background-color: #2d2d30 !important;
        border-color: #3e3e42 !important;
        color: #cccccc !important;
    }
    
    [data-theme="dark"] .code-block-container pre code {
        color: #cccccc !important;
        background: transparent !important;
    }

    .markdown-content ul,
    .markdown-content ol {
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content blockquote {
        border-left: 4px solid #007bff;
        padding-left: 1rem;
        margin-left: 0;
        color: #6c757d;
        font-style: italic;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-content th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    /* KaTeX Block Math Centering - Using our custom container */
    .markdown-content .math-display-container {
        text-align: center !important;
        margin: 1rem 0 !important;
        display: block !important;
        width: 100% !important;
    }
    
    .markdown-content .math-display-container .katex {
        display: inline-block !important;
    }

    .btn-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .card-header {
        background: var(--secondary-bg);
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
    }

    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        background: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        transition: var(--transition);
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        background: none;
    }

    .tab-content {
        background: var(--card-bg);
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: var(--box-shadow);
        color: var(--text-primary);
    }

    /* File Status list-group styling */
    .list-group-item {
        background-color: var(--card-bg) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    .list-group.list-group-flush .list-group-item {
        background-color: var(--card-bg) !important;
    }
    .list-group-item .text-muted { color: var(--text-secondary) !important; }
    [data-theme="dark"] .badge.bg-light { background-color: #3c3c3c !important; color: #cccccc !important; border: 1px solid var(--border-color) !important; }

    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        color: var(--dark-color);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-content pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }

    .markdown-content code {
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* Code block copy button styling */
    .code-block-container {
        position: relative;
    }

    .copy-btn {
        opacity: 1;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        background: #fff;
        border-color: #007bff;
        color: #007bff;
    }

    .copy-btn.copied {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }

    /* Side-by-side layout enhancements */
    .editor-resize-container {
        min-height: 400px;
    }

    .monaco-editor-container {
        height: 400px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
    }

    /* Enhanced Code Editor Container (from test-solution.html) */
    .code-editor-container { 
        background: var(--secondary-bg); 
        border-radius: var(--border-radius); 
        padding: 0; 
        overflow: hidden; 
    }

    .code-editor-container textarea { 
        background: var(--card-bg); 
        border: none; 
        border-radius: 0; 
        color: var(--text-primary); 
    }

    /* Test results styling */
    #testResults .card {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
    }

    #testResults .card-header {
        background: var(--secondary-bg);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    #testResults pre {
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.8rem;
        margin-bottom: 0;
    }

    /* Verdict styling from test-solution.html */
    .verdict-AC { color: #28a745; font-weight: bold; }
    .verdict-WA { color: #dc3545; font-weight: bold; }
    .verdict-TLE { color: #ffc107; font-weight: bold; }
    .verdict-RTE { color: #fd7e14; font-weight: bold; }
    .verdict-CE { color: #6f42c1; font-weight: bold; }
    .verdict-PE { color: #20c997; font-weight: bold; }
    .verdict-JE { color: #6c757d; font-weight: bold; }
    
    .test-result-card {
        transition: all 0.2s;
    }
    
    .test-result-card:hover {
        transform: translateY(-1px);
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .col-lg-6 {
            margin-bottom: 1rem;
        }
        
        .monaco-editor-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Enhanced Breadcrumb -->
    {{ enhanced_breadcrumb([
        {'text': 'Dashboard', 'url': url_for('dashboard'), 'icon': 'fas fa-home'},
        {'text': problem.config.get('title', problem.slug), 'icon': 'fas fa-file-code'}
    ]) }}



    <!-- Enhanced Problem Header -->
    {{ problem_detail_header(problem, current_user, is_author, problem_data, author) }}

    <!-- Main Content: Side by Side Layout -->
    <div class="row">
        <!-- Left Column: Problem Statement -->
        <div class="col-lg-6 col-md-12">
            {% call enhanced_card("Problem Statement", "fas fa-file-alt", []) %}
                <div id="problemStatement">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <p class="mt-2 text-muted">Loading problem statement...</p>
                    </div>
                </div>
            {% endcall %}
        </div>

        <!-- Right Column: Solution Editor -->
        <div class="col-lg-6 col-md-12">
            {% call enhanced_card("Solution Editor", "fas fa-code", [
                {'text': 'Clear', 'icon': 'fas fa-trash', 'class': 'btn-outline-secondary btn-sm', 'id': 'clearCodeBtn'},
                {'text': 'Template', 'icon': 'fas fa-file-code', 'class': 'btn-outline-info btn-sm', 'id': 'loadTemplateBtn'}
            ]) %}
                <div class="editor-resize-container">
                    <div class="monaco-editor-container" id="cpp-solution-editor"></div>
                    <div class="editor-resize-handle" id="cpp-solution-editor-resize-handle"></div>
                </div>
                
                <!-- Test Solution Controls -->
                <div class="mt-3 pt-3 border-top">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            {% if current_user %}
                                <div class="d-flex gap-3 flex-wrap">
                                    <button class="btn btn-run-all btn-enhanced" id="runTestsBtn">
                                        <i class="fas fa-play me-2"></i>Run All Tests
                                    </button>
                                    <button class="btn btn-run-samples btn-enhanced" id="runSampleBtn">
                                        <i class="fas fa-vial me-2"></i>Run Samples
                                    </button>
                                    <button class="btn btn-run-custom btn-enhanced" id="runCustomBtn">
                                        <i class="fas fa-keyboard me-2"></i>Run Custom Input
                                    </button>
                                </div>
                            {% else %}
                                <div class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You need to <a href="{{ url_for('auth_login') }}" class="text-decoration-none">sign in</a> to run or submit
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="fas fa-cog"></i> Compile with: <code>g++ -std=c++17 -O2</code>
                            </small>
                        </div>
                    </div>
                </div>
            {% endcall %}

            <!-- Test Results Section -->
            <div id="testResults" class="mt-3" style="display: none;">
                {% call enhanced_card("Test Results", "fas fa-chart-line", []) %}
                    <div id="testResultsContent">
                        <!-- Test results will be populated here -->
                    </div>
                {% endcall %}
            </div>
        </div>
    </div>

</div>

<!-- Custom Input Modal -->
<div class="modal fade" id="customInputModal" tabindex="-1" aria-labelledby="customInputModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customInputModalLabel">
                    <i class="fas fa-keyboard me-2"></i>Run Custom Input
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <label for="customInput" class="form-label fw-bold">
                            <i class="fas fa-edit me-2"></i>Input
                        </label>
                        <textarea id="customInput" class="form-control font-monospace" 
                                  placeholder="Enter your test input here...&#10;&#10;Example:&#10;5&#10;1 2 3 4 5&#10;&#10;Tips:&#10;‚Ä¢ Each line should match your program's expected input format&#10;‚Ä¢ Use spaces or newlines as separators as needed&#10;‚Ä¢ Empty input is allowed for programs that don't need input"></textarea>
                    </div>
                    <div class="col-lg-6">
                        <label class="form-label fw-bold">
                            <i class="fas fa-terminal me-2"></i>Output
                        </label>
                        <div id="customOutput" class="font-monospace" style="white-space: pre-wrap;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="runCustomInputBtn">
                        <i class="fas fa-play me-1"></i>Run Code
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load dependencies first -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>

<!-- Monaco Editor JS (load after other dependencies) -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Monaco Editor Component JS -->
<script src="{{ url_for('static', filename='js/monaco-editor-component.js') }}"></script>
<script src="{{ url_for('static', filename='js/monaco-editor-presets.js') }}"></script>

<script>
// Global variables
let solutionEditor = null;
let currentTestResults = null;

document.addEventListener('DOMContentLoaded', function() {
    // Load problem statement
    loadProblemStatement();

    // Initialize enhanced buttons
    initializeEnhancedButtons();

    // Initialize solution tester (like test-solution.html)
    setTimeout(() => {
        try {
            window.solutionTester = new SolutionTester();
        } catch (error) {
            console.error('Failed to initialize Solution Tester:', error);
        }
    }, 200);
});

function loadProblemStatement() {
    fetch(`/api/problem/{{ problem.slug }}/statement`)
        .then(response => response.json())
        .then(data => {
            const statementDiv = document.getElementById('problemStatement');
            if (data.success) {
                // Use LaTeX-aware markdown conversion
                const htmlContent = convertMarkdownWithLatex(data.statement);
                statementDiv.innerHTML = htmlContent;
                enhanceCodeBlocks(statementDiv);
                if (window.renderMathInElement) {
                    renderMathInElement(statementDiv, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '\\[', right: '\\]', display: true },
                            { left: '\\(', right: '\\)', display: false },
                            { left: '$', right: '$', display: false }
                        ],
                        throwOnError: false,
                        displayMode: false,
                        output: 'html',
                        strict: false
                    });
                    
                }
            } else {
                statementDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Problem statement could not be loaded. ${data.error || ''}
                    </div>
                    <h4>{{ problem.config.get('title', problem.slug) }}</h4>
                `;
            }
        })
        .catch(error => {
            console.error('Statement loading error:', error);
            const statementDiv = document.getElementById('problemStatement');
            statementDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Problem statement file not found or could not be loaded.
                </div>
                <h4>{{ problem.config.get('title', problem.slug) }}</h4>
            `;
        });
}

function convertMarkdownWithLatex(markdown) {
    // Store LaTeX expressions with their placeholders
    const latexMap = new Map();
    let text = markdown;
    
    // Protect block math $$...$$
    text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
        const placeholder = `LATEXBLOCK${Date.now()}${Math.random()}LATEXBLOCK`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Protect inline math $...$
    text = text.replace(/\$([^$\n]+?)\$/g, (match) => {
        const placeholder = `LATEXINLINE${Date.now()}${Math.random()}LATEXINLINE`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Protect LaTeX delimited expressions \(...\) and \[...\]
    text = text.replace(/\\\([\s\S]*?\\\)/g, (match) => {
        const placeholder = `LATEXDELIM${Date.now()}${Math.random()}LATEXDELIM`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    text = text.replace(/\\\[[\s\S]*?\\\]/g, (match) => {
        const placeholder = `LATEXDELIM${Date.now()}${Math.random()}LATEXDELIM`;
        latexMap.set(placeholder, match);
        return placeholder;
    });
    
    // Process markdown with marked.js
    let html = marked.parse(text);
    
    // Restore LaTeX expressions with proper wrapping
    for (const [placeholder, latexContent] of latexMap) {
        let replacement = latexContent;
        
        // Wrap block math ($$...$$ and \[...\]) in a centering container
        if (latexContent.startsWith('$$') || latexContent.startsWith('\\[')) {
            replacement = `<div class="math-display-container">${latexContent}</div>`;
        }
        
        html = html.replace(new RegExp(placeholder, 'g'), replacement);
    }
    
    return `<div class="markdown-content">${html}</div>`;
}

function enhanceCodeBlocks(container) {
    container.querySelectorAll('pre > code').forEach(codeBlock => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-container position-relative mb-3';
        const pre = codeBlock.parentNode;
        pre.classList.add('bg-light', 'border', 'rounded', 'p-3', 'mb-0');
        pre.parentNode.replaceChild(wrapper, pre);
        wrapper.appendChild(pre);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-outline-secondary copy-btn position-absolute';
        copyBtn.style.top = '8px';
        copyBtn.style.right = '8px';
        copyBtn.style.padding = '4px 8px';
        copyBtn.style.fontSize = '12px';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.addEventListener('click', () => copyCodeBlock(codeBlock, copyBtn));
        wrapper.appendChild(copyBtn);
    });
}

function copyCodeBlock(codeElement, button) {
    const text = codeElement.textContent;
    navigator.clipboard.writeText(text).then(() => {
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i>';
        }, 2000);
    });
}

// Solution Test Page with Reusable Monaco Editor Component (from test-solution.html)
class SolutionTester {
    constructor() {
        this.cppEditor = null;
        this.init();
    }
    
    async init() {
        try {
            // Set up event listeners after a small delay to ensure DOM is ready
            setTimeout(() => {
                this.setupEventListeners();
            }, 100);
            
            // Create C++ Solution Editor using our reusable component
            this.cppEditor = MonacoEditorPresets.createCppSolutionEditor('cpp-solution-editor');
            solutionEditor = this.cppEditor; // Set global reference
            
        } catch (error) {
            console.error('Failed to initialize Solution Tester:', error);
        }
    }
    
    setupEventListeners() {
        // Load C++ template
        document.getElementById('loadTemplateBtn')?.addEventListener('click', () => {
            if (this.cppEditor) {
                // Get the default template from the preset and reload it
                const defaultTemplate = `#include <bits/stdc++.h>
using namespace std;
#define int long long
#define all(x) x.begin(), x.end()
#define pb push_back
const int MOD = 1000000007;
int n, m, k;
vector<int> a;

void solve()
{
    cin >> n;
    a.resize(n);
    for (auto &i : a)
        cin >> i;
}

signed main()
{
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cout.tie(nullptr);
    int t;
    cin >> t;
    while (t--)
        solve();
    return 0;
}`;
                this.cppEditor.setValue(defaultTemplate);
            }
        });
        
        // Clear code
        document.getElementById('clearCodeBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the code?')) {
                if (this.cppEditor) {
                    this.cppEditor.setValue('');
                }
            }
        });
        
        // Run all tests
        document.getElementById('runTestsBtn')?.addEventListener('click', () => {
            // Check if user is authenticated
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to run tests on problems.');
                return;
            }
            
            const code = this.getCode();
            
            if (!code.trim()) {
                alert('Please enter C++ code to test');
                return;
            }
            
            // Run both samples and system tests
            const categories = ['samples', 'system'];
            this.runAllTests(code, categories);
        });

        // Run samples only
        document.getElementById('runSampleBtn')?.addEventListener('click', () => {
            // Check if user is authenticated
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to run tests on problems.');
                return;
            }
            
            const code = this.getCode();
            
            if (!code.trim()) {
                alert('Please enter C++ code to test');
                return;
            }
            
            // Run only samples
            const categories = ['samples'];
            this.runAllTests(code, categories);
        });

        // Run custom input
        document.getElementById('runCustomBtn')?.addEventListener('click', () => {
            // Check if user is authenticated
            const isAuthenticated = {{ 'true' if current_user else 'false' }};
            if (!isAuthenticated) {
                alert('Please sign in to run tests on problems.');
                return;
            }
            
            // Show the custom input modal
            const modal = new bootstrap.Modal(document.getElementById('customInputModal'));
            modal.show();
        });

        // Run custom input button in modal
        document.getElementById('runCustomInputBtn')?.addEventListener('click', () => {
            this.runCustomInput();
        });
    }
    
    getCode() {
        return this.cppEditor ? this.cppEditor.getValue() : '';
    }
    
    runAllTests(code, categories) {
        // Disable run button
        const runBtn = categories.includes('system') ? 
            document.getElementById('runTestsBtn') : 
            document.getElementById('runSampleBtn');
        const originalText = runBtn.innerHTML;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        runBtn.disabled = true;
        
        fetch(`/api/problem/{{ problem.slug }}/test-solution`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                categories: categories
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTestResults(data.results);
            } else {
                displayError(data.error);
            }
        })
        .catch(error => {
            displayError(`Network error: ${error.message}`);
        })
        .finally(() => {
            // Restore run button
            runBtn.innerHTML = originalText;
            runBtn.disabled = false;
        });
    }

    runCustomInput() {
        const code = this.getCode();
        const customInput = document.getElementById('customInput').value;
        
        if (!code.trim()) {
            alert('Please enter C++ code to test');
            return;
        }
        
        if (!customInput.trim()) {
            alert('Please enter some input to test with');
            return;
        }
        
        // Disable run button and show loading
        const runBtn = document.getElementById('runCustomInputBtn');
        const originalText = runBtn.innerHTML;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
        runBtn.disabled = true;
        
        // Clear previous output
        const outputDiv = document.getElementById('customOutput');
        outputDiv.innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><div>Running your code...</div></div>';
        
        
        fetch(`/api/quick-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                input: customInput
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display output
                outputDiv.innerHTML = data.output || '<div class="text-muted">No output</div>';
                
            } else {
                // Display error
                outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i><strong>Error:</strong><br><pre>${data.error || 'Unknown error occurred'}</pre></div>`;
            }
        })
        .catch(error => {
            outputDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i><strong>Network Error:</strong><br>${error.message}</div>`;
        })
        .finally(() => {
            // Restore run button
            runBtn.innerHTML = originalText;
            runBtn.disabled = false;
        });
    }
}

// Helper function to safely escape strings for JavaScript template literals (from test-solution.html)
function escapeForJs(str) {
    if (!str) return '';
    return str
        .replace(/\\/g, '\\\\')   // Escape backslashes
        .replace(/`/g, '\\`')     // Escape backticks  
        .replace(/\$/g, '\\$')    // Escape dollar signs
        .replace(/"/g, '\\"')     // Escape double quotes
        .replace(/'/g, "\\'")     // Escape single quotes
        .replace(/\n/g, '\\n')    // Escape newlines
        .replace(/\r/g, '\\r')    // Escape carriage returns
        .replace(/\t/g, '\\t');   // Escape tabs
}

// Display test results (from test-solution.html)
function displayTestResults(results) {
    const testResultsDiv = document.getElementById('testResults');
    const testResultsContent = document.getElementById('testResultsContent');
    
    // Build results HTML
    let html = '';
    
    // Compilation result
    if (results.compilation.success) {
        html += `<div class="alert alert-success">
            <i class="fas fa-check-circle"></i> <strong>Compilation Successful</strong> 
            (${results.compilation.time_ms.toFixed(1)}ms)
        </div>`;
    } else {
        html += `<div class="alert alert-danger">
            <i class="fas fa-times-circle"></i> <strong>Compilation Failed</strong><br>
            <pre class="mt-2">${results.compilation.errors}</pre>
        </div>`;
        testResultsContent.innerHTML = html;
        testResultsDiv.style.display = 'block';
        return;
    }
    
    // Overall statistics
    const stats = results.statistics;
    html += `<div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">${stats.passed}</h4>
                    <small>Passed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-danger">${stats.failed}</h4>
                    <small>Failed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4>${stats.total_tests}</h4>
                    <small>Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4>${stats.pass_rate}%</h4>
                    <small>Pass Rate</small>
                </div>
            </div>
        </div>
    </div>`;
    
    // Enhanced category results with detailed failure information
    for (const [category, categoryResults] of Object.entries(results.test_results)) {
        if (categoryResults.length === 0) continue;
        
        const categoryStats = results.categories[category];
        const categoryClass = categoryStats.failed === 0 ? 'success' : 'danger';
        
        html += `<div class="card mb-3">
            <div class="card-header bg-${categoryClass} text-white">
                <h6 class="mb-0">
                    <i class="fas fa-vial"></i> ${category.charAt(0).toUpperCase() + category.slice(1)} 
                    (${categoryStats.passed}/${categoryStats.count} passed, ${categoryStats.avg_time_ms}ms avg)
                </h6>
            </div>
            <div class="card-body">`;
        
        // Show individual test results with enhanced debugging
        categoryResults.forEach(result => {
            const verdictClass = `verdict-${result.verdict}`;
            
            if (result.verdict === 'AC') {
                // Simple badge for passing tests
                html += `<span class="badge bg-success me-2 mb-2">
                    Test ${String(result.test_num).padStart(2, '0')}: ${result.verdict} (${result.time_ms.toFixed(1)}ms)
                </span>`;
            } else {
                // Enhanced failure display with all debugging info
                html += `<div class="border border-danger rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-danger mb-3">
                                <span class="${verdictClass}">Test ${String(result.test_num).padStart(2, '0')}: ${result.verdict}</span>
                                <small class="text-muted ms-2">(${result.time_ms.toFixed(1)}ms)</small>
                            </h6>
                            
                            <div class="row">
                                <!-- Input Column -->
                                <div class="col-md-4">
                                    <h6 class="text-info mb-2">üì• Input:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small">${result.input_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.input_full && result.input_full.length > 50 ? 
                                        `<button class="btn btn-sm btn-outline-info mt-2" onclick="showFullContent('Test ${result.test_num} Input', \`${escapeForJs(result.input_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full Input
                                        </button>` : ''}
                                </div>
                                
                                <!-- Expected Column -->
                                <div class="col-md-4">
                                    <h6 class="text-success mb-2">‚úÖ Expected:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small text-success">${result.expected_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.expected_full && result.expected_full.length > 20 ? 
                                        `<button class="btn btn-sm btn-outline-success mt-2" onclick="showFullContent('Test ${result.test_num} Expected Output', \`${escapeForJs(result.expected_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full
                                        </button>` : ''}
                                </div>
                                
                                <!-- Actual Column -->
                                <div class="col-md-4">
                                    <h6 class="text-danger mb-2">‚ùå Your Output:</h6>
                                    <div class="bg-light p-2 rounded">
                                        <code class="small text-danger">${result.actual_truncated || 'N/A'}</code>
                                    </div>
                                    ${result.actual_full && result.actual_full.length > 20 ? 
                                        `<button class="btn btn-sm btn-outline-danger mt-2" onclick="showFullContent('Test ${result.test_num} Your Output', \`${escapeForJs(result.actual_full)}\`)">
                                            <i class="fas fa-eye"></i> View Full
                                        </button>` : ''}
                                </div>
                            </div>
                            
                            <!-- Details and Actions -->
                            <div class="row mt-3">
                                <div class="col-md-8">
                                    ${result.details ? `<small class="text-muted"><i class="fas fa-info-circle"></i> <strong>Details:</strong> ${result.details}</small>` : ''}
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyTestCase(\`${escapeForJs(result.input_full || '')}\`)">
                                        <i class="fas fa-copy"></i> Copy Input
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        });
        
        html += '</div></div>';
    }
    
    testResultsContent.innerHTML = html;
    testResultsDiv.style.display = 'block';
    
    // Scroll to results
    testResultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}


function initializeEnhancedButtons() {
    // Add hover effects to enhanced buttons
    document.querySelectorAll('.btn-enhanced').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

// Toggle problem visibility in header
async function toggleVisibilityInHeader(slug, isCurrentlyPublic) {
    try {
        const response = await fetch(`/api/problems/${slug}/toggle-visibility`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the toggle button in header
            const toggleBtn = document.getElementById(`toggle-visibility-btn-${slug}`);
            
            if (result.is_public) {
                // Problem is now public, button should show "Make Private" (warning style)
                toggleBtn.innerHTML = '<i class="fas fa-lock me-1"></i>Make Private';
                toggleBtn.className = 'btn btn-warning btn-enhanced';
                toggleBtn.setAttribute('onclick', `toggleVisibilityInHeader('${slug}', true)`);
                toggleBtn.title = 'Make Private';
            } else {
                // Problem is now private, button should show "Make Public" (success style)
                toggleBtn.innerHTML = '<i class="fas fa-globe me-1"></i>Make Public';
                toggleBtn.className = 'btn btn-success btn-enhanced';
                toggleBtn.setAttribute('onclick', `toggleVisibilityInHeader('${slug}', false)`);
                toggleBtn.title = 'Make Public';
            }
            
            // Success - no message needed, button change is enough feedback
        } else {
            console.error('Failed to update visibility:', result.error);
        }
    } catch (error) {
        console.error('Error toggling visibility:', error);
    }
}

function deleteProblem(slug) {
    if (confirm('Are you sure you want to delete this problem? This action cannot be undone.')) {
        fetch(`/api/problems/${slug}/delete`, { method: 'DELETE' })
            .then(async response => {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (err) {
                    throw new Error(text);
                }
            })
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ url_for('dashboard') }}';
                } else {
                    alert(data.error || 'Failed to delete problem');
                }
            })
            .catch(error => {
                alert('Error deleting problem: ' + error);
            });
    }
}

function exportProblem(slug) {
    // Placeholder for export functionality
    alert('Export functionality will be implemented soon!');
}

// Multi-user functionality
async function toggleVisibility() {
    try {
        const response = await fetch(`/api/problems/{{ problem.slug }}/toggle-visibility`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the page to reflect changes
            location.reload();
        } else {
            alert(result.error || 'Failed to update visibility');
        }
    } catch (error) {
        console.error('Error toggling visibility:', error);
        alert('Failed to update visibility');
    }
}

// Copy problem link to clipboard
function copyProblemLink(slug) {
    const problemUrl = window.location.origin + '/problem/' + slug;
    
    // Use the modern Clipboard API if available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(problemUrl).then(() => {
            showLinkCopiedNotification();
        }).catch(err => {
            console.error('Failed to copy link: ', err);
            fallbackCopyTextToClipboard(problemUrl);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(problemUrl);
    }
}

// Fallback copy method for older browsers
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showLinkCopiedNotification();
        } else {
            console.error('Fallback: Copying text command was unsuccessful');
        }
    } catch (err) {
        console.error('Fallback: Unable to copy', err);
    }
    
    document.body.removeChild(textArea);
}

// Show notification when link is copied
function showLinkCopiedNotification() {
    // Create or update notification element
    let notification = document.getElementById('link-copied-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'link-copied-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;
        document.body.appendChild(notification);
    }
    
    // Set message and show notification
    notification.innerHTML = '<i class="fas fa-check me-2"></i>Problem link copied to clipboard!';
    notification.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
    }, 3000);
}

// Helper functions for displaying results (from test-solution.html)
function showFullContent(title, content) {
    // Create a simple modal for viewing full content
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(\`${escapeForJs(content)}\`)">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                    </div>
                    <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"><code>${content}</code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Remove modal from DOM when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function copyTestCase(content) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
            // Could add a toast notification here
        });
    }
}

function copyToClipboard(content) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
            // Could add a toast notification here
        });
    }
}

function displayError(error) {
    const testResultsDiv = document.getElementById('testResults');
    const testResultsContent = document.getElementById('testResultsContent');
    testResultsContent.innerHTML = `<div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${error}
    </div>`;
    
    testResultsDiv.style.display = 'block';
}
</script>
{% endblock %}
