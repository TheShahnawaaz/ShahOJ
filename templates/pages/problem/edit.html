{% extends "layouts/base.html" %}
{% from "layouts/components.html" import enhanced_breadcrumb, problem_header %}

{% block title %}Edit Problem - {{ problem.config.get('title') or problem.slug }} - PocketOJ{% endblock %}

{% block extra_css %}
<!-- Monaco Editor CSS -->
<link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">
<!-- Monaco Editor Component CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/monaco-editor-component.css') }}">

<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body {
        background-color: #f5f7fa;
    }

    /* Enhanced Layout */
    .edit-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
    }

    /* Progress Bar */
    .progress-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

        /* Enhanced Sidebar */
    .sidebar-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        border: 1px solid #e9ecef;
    }

    .sidebar-container .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .sidebar-container .card-header h5 {
        margin: 0;
        font-weight: 600;
        color: var(--dark-color);
        font-size: 1rem;
    }
    
    .file-tab {
        cursor: pointer;
        transition: var(--transition);
        border: none;
        border-left: 4px solid transparent;
        position: relative;
        padding: 1rem 1.25rem;
        margin: 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .file-tab:hover {
        background: linear-gradient(90deg, #f8f9fa, #ffffff);
        border-left-color: var(--primary-color);
        transform: translateX(2px);
    }
    
    .file-tab.active {
        background: linear-gradient(90deg,rgba(0, 123, 255, 0.2),rgba(0, 123, 255, 0.5));
        color: #212529;
        border-left-color: var(--primary-color);
        border-left-width: 6px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .file-tab.active:hover {
        transform: none;
    }
    
    .file-tab.modified {
        font-weight: 600;
    }
    
    .file-tab.modified::after {
        content: "‚óè";
        color: var(--warning-color);
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .file-tab.active.modified::after {
        color: #f0ad4e;
    }

    .file-tab .d-flex {
        align-items: flex-start;
        gap: 0.75rem;
    }

    .file-tab i {
        margin-top: 0.125rem;
        font-size: 1.1rem;
    }

    .file-tab strong {
        font-size: 0.95rem;
        line-height: 1.3;
        margin-bottom: 0.25rem;
        display: block;
    }

    .file-tab small {
        font-size: 0.8rem;
        opacity: 0.8;
        line-height: 1.2;
    }

    .file-tab.active small {
        opacity: 0.7;
    }

    .file-status {
        font-size: 0.7rem;
        margin-top: 0.375rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .file-status i {
        font-size: 0.7rem;
        margin-top: 0;
    }

    .status-complete { 
        color: var(--success-color);
    }
    .status-incomplete { 
        color: var(--danger-color);
    }
    .status-optional { 
        color: var(--info-color);
    }

    .validation-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.375rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        min-width: 2rem;
        height: 2rem;
    }

    .sidebar-container .card-footer {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-top: 1px solid #dee2e6;
        padding: 1rem 1.25rem;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .sidebar-container .card-footer .row {
        margin: 0;
    }

    .sidebar-container .card-footer .col-4 {
        padding: 0.5rem;
        text-align: center;
    }

    .sidebar-container .card-footer .fw-bold {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        display: block;
    }

    .sidebar-container .card-footer small {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* Enhanced Editor Container */
    .editor-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
    }

    .editor-header {
        background: var(--light-color);
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .editor-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        font-size: 1.1rem;
    }

    .editor-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }


    
    /* Fallback textarea styling */
    .code-editor {
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        border: none;
        resize: vertical;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 10px;
    }
    
    .code-editor:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .config-section {
        background: var(--light-color);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border: 1px solid #e9ecef;
    }

    .config-section h6 {
        color: var(--dark-color);
        margin-bottom: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Validation Indicators */
    .validation-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .validation-valid {
        background-color: #d4edda;
        color: #155724;
    }
    
    .validation-invalid {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .validation-loading {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .validation-pending {
        background-color: #e2e3e5;
        color: #6c757d;
    }



    /* Enhanced Buttons */
    .btn-enhanced {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    .btn-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Save Status */
    .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: none;
    }





    /* Responsive Design */
    @media (max-width: 768px) {
        .config-grid {
            grid-template-columns: 1fr;
        }
        
        .action-grid {
            grid-template-columns: 1fr;
        }
        
        .editor-header {
            flex-direction: column;
            align-items: stretch;
        }

        .sidebar-container {
            position: relative;
            top: 0;
            max-height: none;
            margin-bottom: 1rem;
        }

        .file-tab {
            padding: 0.75rem 1rem;
        }

        .file-tab .d-flex {
            gap: 0.5rem;
        }

        .file-tab strong {
            font-size: 0.9rem;
        }

        .file-tab small {
            font-size: 0.75rem;
        }

        .sidebar-container .card-footer .col-4 {
            padding: 0.25rem;
        }

        .sidebar-container .card-footer .fw-bold {
            font-size: 1rem;
        }
    }

    /* Loading States */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: var(--border-radius);
    }

    .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced Tooltips */
    .tooltip-enhanced {
        position: relative;
        cursor: help;
    }

    .tooltip-enhanced::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark-color);
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
        z-index: 1000;
    }

    .tooltip-enhanced:hover::after {
        opacity: 1;
        visibility: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Enhanced Breadcrumb -->
    {{ enhanced_breadcrumb([
        {'text': 'Dashboard', 'url': url_for('dashboard'), 'icon': 'fas fa-home'},
        {'text': problem.config.get('title') or problem.slug, 'url': url_for('problem_detail', slug=problem.slug), 'icon': 'fas fa-file-code'},
        {'text': 'Edit', 'icon': 'fas fa-edit'}
    ]) }}

    <!-- Enhanced Problem Header -->
    {{ problem_header(
        'Edit Problem',
        problem.config.get('title') or problem.slug,
        [
            {'text': 'Save All Changes', 'icon': 'fas fa-save', 'class': 'btn-light', 'id': 'saveAllBtn'},
            {'text': 'Discard Changes', 'icon': 'fas fa-undo', 'class': 'btn-light', 'onclick': 'location.reload()'},
            {'text': 'Back to Problem', 'icon': 'fas fa-arrow-left', 'class': 'btn-light', 'onclick': "location.href='" + url_for('problem_detail', slug=problem.slug) + "'"}
        ]
    ) }}



    <div class="row">
        
        <!-- Enhanced File Tabs Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="sidebar-container">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-folder-open"></i> Problem Files</h5>
                </div>
                <div class="list-group list-group-flush">
                    
                    <!-- Configuration -->
                    <div class="list-group-item file-tab active" data-file="config" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-cog text-primary me-2"></i>
                                <div>
                        <strong>Configuration</strong>
                                    <div class="file-status status-complete">
                                        <i class="fas fa-check"></i> Complete
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-valid" id="config-validation">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Basic settings & metadata</small>
                    </div>
                    
                    <!-- Statement -->
                    <div class="list-group-item file-tab" data-file="statement" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-info me-2"></i>
                                <div>
                        <strong>statement.md</strong>
                                    <div class="file-status status-incomplete" id="statement-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="statement-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Problem description</small>
                    </div>
                    
                    <!-- Solution -->
                    <div class="list-group-item file-tab" data-file="solution" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-code text-success me-2"></i>
                                <div>
                        <strong>solution.py</strong>
                                    <div class="file-status status-incomplete" id="solution-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="solution-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Reference solution</small>
                    </div>
                    
                    <!-- Generator -->
                    <div class="list-group-item file-tab" data-file="generator" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-random text-warning me-2"></i>
                                <div>
                        <strong>generator.py</strong>
                                    <div class="file-status status-incomplete" id="generator-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="generator-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Test case generator</small>
                    </div>
                    
                    <!-- Validator -->
                    <div class="list-group-item file-tab" data-file="validator" data-required="false">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-shield-alt text-secondary me-2"></i>
                                <div>
                        <strong>validator.py</strong>
                                    <div class="file-status status-optional" id="validator-status">
                                        <i class="fas fa-info-circle"></i> Optional
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="validator-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Input validator (optional)</small>
                    </div>
                    
                    <!-- Custom Checker -->
                    <div class="list-group-item file-tab" data-file="checker" data-required="false">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-gavel text-danger me-2"></i>
                                <div>
                        <strong>checker/spj.cpp</strong>
                                    <div class="file-status status-optional" id="checker-status">
                                        <i class="fas fa-info-circle"></i> Optional
                    </div>
                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="checker-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Special judge (optional)</small>
            </div>
            
                </div>
                
            </div>
        </div>

        <!-- Enhanced File Editor -->
        <div class="col-lg-9 col-md-8">
            
            <!-- Configuration Editor -->
            <div class="file-content active" id="config-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-cog text-primary"></i> Problem Configuration
                        </h5>

                    </div>
                    <div class="config-grid">
                        <!-- Basic Information -->
                        <div class="config-section">
                            <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                                <div class="mb-3">
                                <label for="edit_title" class="form-label">Problem Title *</label>
                                    <input type="text" class="form-control" id="edit_title" 
                                       value="{{ problem.config.get('title') or '' }}"
                                       placeholder="Enter a descriptive problem title">
                                <div class="form-text">This will be displayed as the main problem title</div>
                                </div>
                                
                                <div class="mb-3">
                                <label for="edit_difficulty" class="form-label">Difficulty Level</label>
                                    <select class="form-select" id="edit_difficulty">
                                    <option value="Easy" {% if problem.config.get('difficulty') == 'Easy' %}selected{% endif %}>üü¢ Easy</option>
                                    <option value="Medium" {% if problem.config.get('difficulty') == 'Medium' %}selected{% endif %}>üü° Medium</option>
                                    <option value="Hard" {% if problem.config.get('difficulty') == 'Hard' %}selected{% endif %}>üî¥ Hard</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_tags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="edit_tags" 
                                       value="{{ (problem.config.get('tags') or [])|join(', ') }}"
                                       placeholder="array, sorting, dynamic-programming">
                                <div class="form-text">Comma-separated tags for categorization</div>
                            </div>
                            
                            <div class="mb-0">
                                <label for="edit_description" class="form-label">Short Description</label>
                                <textarea class="form-control" id="edit_description" rows="3" 
                                          placeholder="Brief description of the problem">{{ problem.config.get('description') or '' }}</textarea>
                                </div>
                            </div>
                            
                        <!-- Limits & Constraints -->
                        <div class="config-section">
                            <h6><i class="fas fa-stopwatch"></i> Limits & Constraints</h6>
                                <div class="mb-3">
                                    <label for="edit_time_limit" class="form-label">Time Limit (ms)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="edit_time_limit" 
                                           value="{{ problem.config.get('limits.time_ms') or 1000 }}"
                                           min="100" max="10000" step="100">
                                    <span class="input-group-text">ms</span>
                                </div>
                                <div class="form-text">Typical: 1000ms for most problems</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_memory_limit" class="form-label">Memory Limit (MB)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="edit_memory_limit" 
                                           value="{{ problem.config.get('limits.memory_mb') or 256 }}"
                                           min="64" max="1024" step="64">
                                    <span class="input-group-text">MB</span>
                                </div>
                                <div class="form-text">Typical: 256MB for most problems</div>
                                </div>
                                
                            <div class="mb-0">
                                <label for="edit_checker_type" class="form-label">Output Checker</label>
                                    <select class="form-select" id="edit_checker_type">
                                    <option value="diff" {% if problem.config.get('checker.type') == 'diff' %}selected{% endif %}>
                                        üìù Exact Match (diff)
                                    </option>
                                    <option value="float" {% if problem.config.get('checker.type') == 'float' %}selected{% endif %}>
                                        üî¢ Floating Point (1e-6 tolerance)
                                    </option>
                                    <option value="spj" {% if problem.config.get('checker.type') == 'spj' %}selected{% endif %}>
                                        ‚öñÔ∏è Special Judge (Custom)
                                    </option>
                                    </select>
                                <div class="form-text">How to compare solution output with expected answer</div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statement Editor -->
            <div class="file-content" id="statement-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-file-alt text-info"></i> Problem Statement
                        </h5>

                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="statement-monaco-editor"></div>
                        <div class="editor-resize-handle" id="statement-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Solution Editor -->
            <div class="file-content" id="solution-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-code text-success"></i> Reference Solution
                        </h5>

                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="solution-monaco-editor"></div>
                        <div class="editor-resize-handle" id="solution-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Generator Editor -->
            <div class="file-content" id="generator-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-random text-warning"></i> Test Generator
                        </h5>

                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="generator-monaco-editor"></div>
                        <div class="editor-resize-handle" id="generator-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Validator Editor -->
            <div class="file-content" id="validator-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-shield-alt text-secondary"></i> Input Validator
                        </h5>
                        <div class="editor-actions">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="validatorEnabled" 
                                       {{ 'checked' if problem.config.get('validation.enabled', False) else '' }}>
                                <label class="form-check-label" for="validatorEnabled">
                                    Enable Validation
                                </label>
                            </div>

                        </div>
                    </div>
                    
                    <div class="p-3 bg-light border-bottom">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>Validator Control:</strong> 
                            <span id="validatorStatusText">
                                {% if problem.config.get('validation.enabled', False) %}
                                    Validation is <strong>enabled</strong>. Generated test cases will be validated.
                                {% else %}
                                    Validation is <strong>disabled</strong>. Test cases will be generated without validation.
                                {% endif %}
                            </span>
                        </div>
                        </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="validator-monaco-editor"></div>
                        <div class="editor-resize-handle" id="validator-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Checker Editor -->
            <div class="file-content" id="checker-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-gavel text-danger"></i> Custom Checker (SPJ)
                        </h5>

                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="checker-monaco-editor"></div>
                        <div class="editor-resize-handle" id="checker-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- Test Integration Results Modal -->
    <div class="modal fade" id="integrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-flask"></i> Integration Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="integrationResults">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div class="save-indicator alert" id="saveIndicator">
        <!-- Save status messages -->
    </div>

    <!-- Hidden elements to store initial content safely -->
    <script type="application/json" id="initial-content-data">
    {
        "statement": {{ (statement_content or '')|tojson }},
        "solution": {{ (solution_content or '')|tojson }},
        "generator": {{ (generator_content or '')|tojson }},
        "validator": {{ (validator_content or '')|tojson }},
        "checker": {{ (checker_content or '')|tojson }}
    }
    </script>

</div>
{% endblock %}

{% block extra_js %}
<!-- Monaco Editor JS -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Monaco Editor Component JS -->
<script src="{{ url_for('static', filename='js/monaco-editor-component.js') }}"></script>
<script src="{{ url_for('static', filename='js/monaco-editor-presets.js') }}"></script>

<script>
// Enhanced Problem Editor with Reusable Monaco Components
class ProblemEditor {
    constructor() {
        this.currentFile = 'config';
        this.originalContents = {};
        this.modifiedFiles = new Set();
        this.editors = {};

        this.validationCache = new Map();
        this.initialized = false;
        
        // Editor will be initialized via init() method call
    }
    
    async init() {
        if (this.initialized) {
            console.log('Problem Editor already initialized, skipping...');
            return;
        }
        
        try {
            console.log('Initializing Problem Editor...');
            this.initialized = true;
            
            // Wait for DOM to be fully ready
            await new Promise(resolve => {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            });
            
            this.setupEventListeners();
            this.loadFileContents();
            
            // Initialize Monaco Editors using our reusable components
                setTimeout(() => {
                this.initializeEditors();
                this.switchToFile('config');
                console.log('Enhanced Problem Editor initialized for: {{ problem.slug }}');
            }, 100);
            
        } catch (error) {
            console.error('Failed to initialize Problem Editor:', error);
            this.switchToFile('config');
        }
    }
    
    initializeEditors() {
        try {
            console.log('Initializing editors with reusable Monaco components...');
            
            // 1. Statement Editor (Markdown)
            this.editors.statement = MonacoEditorPresets.createStatementEditor('statement-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('statement') // Load content directly
            });
            
            // 2. Solution Editor (Python)
            this.editors.solution = MonacoEditorPresets.createPythonSolutionEditor('solution-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('solution') // Load content directly
            });
            
            // 3. Generator Editor (Python)
            this.editors.generator = MonacoEditorPresets.createGeneratorEditor('generator-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('generator') // Load content directly
            });
            
            // 4. Validator Editor (Python)
            this.editors.validator = MonacoEditorPresets.createValidatorEditor('validator-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('validator') // Load content directly
            });
            
                        // 5. Checker Editor (C++)
            this.editors.checker = MonacoEditorPresets.createCheckerEditor('checker-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('checker') // Load content directly
            });
                    
            console.log('All editors initialized successfully');
            
            // Add change listeners to all editors
            this.setupEditorChangeListeners();
            
                        // Update file statuses now that content is loaded
            setTimeout(() => {
                this.updateAllFileStatuses();
            }, 500);
                    
        } catch (error) {
            console.error('Failed to initialize editors:', error);
        }
    }
    
    setupEditorChangeListeners() {
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        
        fileTypes.forEach(fileType => {
            const editor = this.editors[fileType];
            if (editor && editor.editor && editor.editor.onDidChangeModelContent) {
                editor.editor.onDidChangeModelContent(() => {
                    this.markFileModified(fileType);
                    this.validateFileContent(fileType);
                });
            }
        });
    }
    
    loadInitialContent(fileType, editor) {
        try {
            const content = this.getInitialContent(fileType);
            editor.setValue(content);
            
            console.log(`Loaded initial content for ${fileType}: ${content.length} characters`);
            
            // Add content change listener to the underlying Monaco editor
            if (editor.editor && editor.editor.onDidChangeModelContent) {
                editor.editor.onDidChangeModelContent(() => {
                    this.markFileModified(fileType);
                    this.validateFileContent(fileType);
                });
            }
                    
                } catch (error) {
            console.warn(`Failed to load initial content for ${fileType}:`, error);
                }
    }
    
    createFallbackEditors() {
        console.log('Creating fallback textarea editors');
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        
        fileTypes.forEach(fileType => {
            const container = document.getElementById(`${fileType}-monaco-editor`);
            if (container) {
                this.createFallbackEditor(fileType, container);
            }
        });
        
        // File statuses will be updated after editors are initialized
    }
    
    createFallbackEditor(fileType, container) {
        // Create a textarea as fallback
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control code-editor';
        textarea.style.width = '100%';
        textarea.style.height = '600px';
        textarea.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
        textarea.style.fontSize = '14px';
        textarea.style.lineHeight = '1.4';
        textarea.value = this.getInitialContent(fileType);
        
        // Clear container and add textarea
        container.innerHTML = '';
        container.appendChild(textarea);
        
        // Store reference for getFileContent method
        this.editors[fileType] = {
            getValue: () => textarea.value,
            setValue: (value) => { textarea.value = value; },
            focus: () => textarea.focus(),
            layout: () => {} // No-op for textarea
        };
        
        // Add change listener
        textarea.addEventListener('input', () => {
            this.markFileModified(fileType);
            this.validateFileContent(fileType);
        });
        
        console.log(`Fallback editor created for ${fileType}`);
    }
    
    getInitialContent(fileType) {
        // Get content from JSON data element
        try {
            const dataElement = document.getElementById('initial-content-data');
            
            if (dataElement) {
                const contentData = JSON.parse(dataElement.textContent);
                return contentData[fileType] || '';
            } else {
                console.error('initial-content-data element not found!');
            }
        } catch (error) {
            console.error('Failed to parse initial content data for', fileType, ':', error);
        }
        return '';
    }
    
    setupEventListeners() {
        // File tab switching
        document.querySelectorAll('.file-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const fileName = tab.dataset.file;
                this.switchToFile(fileName);
            });
        });
        
        // Config field changes
    ['edit_title', 'edit_difficulty', 'edit_tags', 'edit_time_limit', 'edit_memory_limit', 'edit_checker_type', 'edit_description'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
                field.addEventListener('input', () => {
                    this.markFileModified('config');
                    this.validateConfig();
            });
        }
    });
    
        // Action buttons
        document.getElementById('saveAllBtn')?.addEventListener('click', () => this.saveAllChanges());
        

        
        // Validator toggle
        document.getElementById('validatorEnabled')?.addEventListener('change', (e) => {
            const statusText = document.getElementById('validatorStatusText');
            if (e.target.checked) {
                statusText.innerHTML = 'Validation is <strong>enabled</strong>. Generated test cases will be validated.';
            } else {
                statusText.innerHTML = 'Validation is <strong>disabled</strong>. Test cases will be generated without validation.';
            }
            this.markFileModified('config');
        });
        
        // Window resize handler for Monaco editors
        window.addEventListener('resize', () => {
            this.handleWindowResize();
        });
    }
    
    handleWindowResize() {
        // Debounce resize events
        clearTimeout(this.resizeTimeout);
        this.resizeTimeout = setTimeout(() => {
            Object.values(this.editors).forEach(editor => {
                if (editor && typeof editor.layout === 'function') {
                    try {
                        editor.layout();
                    } catch (error) {
                        console.warn('Error during resize layout:', error);
                    }
                }
            });
        }, 100);
    }
    
    switchToFile(fileName) {
        console.log(`Switching to file: ${fileName}`);
        
        // Update tab appearance
        document.querySelectorAll('.file-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.file === fileName);
        });
        
        // Update content visibility
        document.querySelectorAll('.file-content').forEach(content => {
            content.style.display = content.id === fileName + '-content' ? 'block' : 'none';
        });
        
        this.currentFile = fileName;
        
        // Focus and layout Monaco editor if available
        if (this.editors[fileName]) {
            setTimeout(() => {
                try {
                    if (typeof this.editors[fileName].layout === 'function') {
                        this.editors[fileName].layout();
                    }
                    if (typeof this.editors[fileName].focus === 'function') {
                        this.editors[fileName].focus();
                    }
                } catch (error) {
                    console.warn(`Error focusing/layouting editor for ${fileName}:`, error);
                }
            }, 150);
        }
        
        // Also trigger a global layout update for Monaco
        setTimeout(() => {
            if (window.monaco && window.monaco.editor) {
                try {
                    window.monaco.editor.getEditors().forEach(editor => {
                        if (editor.getContainerDomNode().offsetParent !== null) {
                            editor.layout();
                        }
                    });
                } catch (error) {
                    console.warn('Error during global Monaco layout:', error);
                }
            }
        }, 200);
    }
    
    loadFileContents() {
        // Store original contents for reset functionality
        this.originalContents = {
            statement: this.getInitialContent('statement'),
            solution: this.getInitialContent('solution'),
            generator: this.getInitialContent('generator'),
            validator: this.getInitialContent('validator'),
            checker: this.getInitialContent('checker')
        };
        
        // Validate that we have the initial content
        console.log('Loaded initial contents:', {
            statement: this.originalContents.statement.length + ' chars',
            solution: this.originalContents.solution.length + ' chars',
            generator: this.originalContents.generator.length + ' chars',
            validator: this.originalContents.validator.length + ' chars',
            checker: this.originalContents.checker.length + ' chars'
        });
        
        // Update file statuses based on content
        this.updateAllFileStatuses();
    }
    
    updateAllFileStatuses() {
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        const requiredFiles = ['statement', 'solution', 'generator'];
        
        fileTypes.forEach(fileType => {
            const content = this.getFileContent(fileType);
            const hasContent = content && content.trim().length > 0;
            const isRequired = requiredFiles.includes(fileType);
            
            if (hasContent) {
                this.updateFileStatus(fileType, 'complete');
            } else if (isRequired) {
                this.updateFileStatus(fileType, 'incomplete');
            } else {
                this.updateFileStatus(fileType, 'optional');
            }
        });
        
        // Also update config status (always complete)
        this.updateFileStatus('config', 'complete');
    }
    
    markFileModified(fileName) {
        this.modifiedFiles.add(fileName);
        const tab = document.querySelector(`[data-file="${fileName}"]`);
        if (tab) {
            tab.classList.add('modified');
        }
        
        // Update save button
        const saveBtn = document.getElementById('saveAllBtn');
        if (this.modifiedFiles.size > 0) {
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Save ${this.modifiedFiles.size} Modified File${this.modifiedFiles.size > 1 ? 's' : ''}`;
            saveBtn.classList.remove('btn-light');
            saveBtn.classList.add('btn-warning');
        }
        
        // Update modified files counter  
        const modifiedElement = document.getElementById('modifiedFiles');
        if (modifiedElement) {
            modifiedElement.textContent = this.modifiedFiles.size;
        }
        
        // Update file status based on content
        if (fileName !== 'config') {
            const content = this.getFileContent(fileName);
            const hasContent = content && content.trim().length > 0;
            const requiredFiles = ['statement', 'solution', 'generator'];
            const isRequired = requiredFiles.includes(fileName);
            
            if (hasContent) {
                this.updateFileStatus(fileName, 'complete');
            } else if (isRequired) {
                this.updateFileStatus(fileName, 'incomplete');
            } else {
                this.updateFileStatus(fileName, 'optional');
            }
        }
    }
    
    async validateFileContent(fileType) {
        const content = this.getFileContent(fileType);
        const validationIndicator = document.getElementById(`${fileType}-validation`);
        
        if (!content.trim()) {
            this.updateValidationStatus(validationIndicator, 'pending', 'Empty');
            return;
        }
        
        this.updateValidationStatus(validationIndicator, 'loading', 'Validating...');
        
        try {
            const response = await fetch('/api/validate-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: this.getFileName(fileType),
                    content: content
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.valid) {
                this.updateValidationStatus(validationIndicator, 'valid', 'Valid');
                this.updateFileStatus(fileType, 'complete');
            } else {
                this.updateValidationStatus(validationIndicator, 'invalid', result.error || 'Invalid');
                this.updateFileStatus(fileType, 'incomplete');
            }
        } catch (error) {
            this.updateValidationStatus(validationIndicator, 'invalid', 'Validation failed');
        }
    }
    
    updateValidationStatus(indicator, status, message) {
        if (!indicator) return;
        
        indicator.className = `validation-indicator validation-${status}`;
        
        const icons = {
            valid: 'fas fa-check',
            invalid: 'fas fa-times',
            loading: 'fas fa-spinner fa-spin',
            pending: 'fas fa-clock'
        };
        
        indicator.innerHTML = `<i class="${icons[status]}"></i>`;
        indicator.title = message;
    }
    
    updateFileStatus(fileType, status) {
        const statusElement = document.getElementById(`${fileType}-status`);
        if (!statusElement) return;
        
        const statusConfig = {
            complete: { class: 'status-complete', icon: 'fas fa-check', text: 'Complete' },
            incomplete: { class: 'status-incomplete', icon: 'fas fa-exclamation-circle', text: 'Required' },
            optional: { class: 'status-optional', icon: 'fas fa-info-circle', text: 'Optional' }
        };
        
        const config = statusConfig[status];
        statusElement.className = `file-status ${config.class}`;
        statusElement.innerHTML = `<i class="${config.icon}"></i> ${config.text}`;
        
        // Also update the validation indicator on the right side
        const validationIndicator = document.getElementById(`${fileType}-validation`);
        if (validationIndicator) {
            if (status === 'complete') {
                this.updateValidationStatus(validationIndicator, 'valid', 'Complete');
            } else {
                this.updateValidationStatus(validationIndicator, 'pending', 'Pending');
            }
        }
    }
    

    
    getFileContent(fileType) {
        if (fileType === 'config') {
            return 'config-data'; // Config is always considered as having content
        }
        
        if (this.editors[fileType]) {
            return this.editors[fileType].getValue();
        }
        return '';
    }
    
    getFileName(fileType) {
        const fileNames = {
            statement: 'statement.md',
            solution: 'solution.py',
            generator: 'generator.py',
            validator: 'validator.py',
            checker: 'checker/spj.cpp'
        };
        return fileNames[fileType] || `${fileType}.txt`;
    }
    

    

    

    
    async saveAllChanges(silent = false) {
        const btn = document.getElementById('saveAllBtn');
        const originalText = btn.innerHTML;
        
        if (!silent) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        }
        
        try {
        // Collect all data
        const data = {
            config: {
                title: document.getElementById('edit_title').value.trim(),
                difficulty: document.getElementById('edit_difficulty').value,
                tags: document.getElementById('edit_tags').value.split(',').map(t => t.trim()).filter(t => t),
                time_limit_ms: parseInt(document.getElementById('edit_time_limit').value),
                memory_limit_mb: parseInt(document.getElementById('edit_memory_limit').value),
                checker_type: document.getElementById('edit_checker_type').value,
                description: document.getElementById('edit_description').value.trim()
            },
            files: {
                    'statement.md': this.getFileContent('statement'),
                    'solution.py': this.getFileContent('solution'),
                    'generator.py': this.getFileContent('generator'),
                    'validator.py': this.getFileContent('validator'),
                    'checker/spj.cpp': this.getFileContent('checker')
            },
            validator_enabled: document.getElementById('validatorEnabled').checked
        };
        
            const response = await fetch(`/api/problem/{{ problem.slug }}/save-all`, {
            method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (!silent) {
                    this.showSaveStatus('success', 'All changes saved successfully!');
                }
                
                // Clear modification markers
                this.modifiedFiles.clear();
                document.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.remove('modified');
                });
                
                // Reset save button
                btn.innerHTML = '<i class="fas fa-save"></i> Save All Changes';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-light');
                
                // Update file statuses after successful save
                this.updateAllFileStatuses();
                
            } else {
                this.showSaveStatus('error', `Save failed: ${result.error}`);
            }
        } catch (error) {
            this.showSaveStatus('error', `Network error: ${error.message}`);
        } finally {
            if (!silent) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            }
        }
    }
    
    async testFileIntegration() {
        const modal = new bootstrap.Modal(document.getElementById('integrationModal'));
        const resultsDiv = document.getElementById('integrationResults');
        
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner"></div><p>Testing file integration...</p></div>';
        modal.show();
        
        try {
        const files = {
                'statement.md': this.getFileContent('statement'),
                'solution.py': this.getFileContent('solution'),
                'generator.py': this.getFileContent('generator'),
                'validator.py': this.getFileContent('validator'),
                'checker/spj.cpp': this.getFileContent('checker')
            };
            
            const response = await fetch('/api/test-file-integration', {
            method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: files })
            });
            
            const data = await response.json();
            this.displayIntegrationResults(data);
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Integration test failed: ${error.message}</div>`;
        }
    }
    
    displayIntegrationResults(data) {
        const resultsDiv = document.getElementById('integrationResults');
        let html = '';
        
        if (data.success) {
            html += '<div class="alert alert-success"><i class="fas fa-check-circle"></i> All files integrate correctly!</div>';
            
            if (data.preview) {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Generated Test Case:</h6>
                            <pre class="bg-light p-3 rounded">${data.preview.input}</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Solution Output:</h6>
                            <pre class="bg-light p-3 rounded">${data.preview.output}</pre>
                            ${data.preview.valid ? '<span class="badge bg-success">‚úì Validator Passed</span>' : ''}
                        </div>
                    </div>
                `;
            }
        } else {
            html += '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Integration issues found:</div>';
            
            if (data.errors) {
                html += '<ul class="text-danger">';
                data.errors.forEach(error => {
                    html += `<li><strong>Error:</strong> ${error}</li>`;
                });
                html += '</ul>';
            }
        }
        
        if (data.warnings) {
            html += '<div class="alert alert-warning"><strong>Warnings:</strong></div>';
            html += '<ul>';
            data.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul>';
        }
        
        resultsDiv.innerHTML = html;
    }
    
    showSaveStatus(type, message) {
        const indicator = document.getElementById('saveIndicator');
        
        indicator.className = `save-indicator alert alert-${type === 'success' ? 'success' : 'danger'} show`;
        indicator.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle"></i> ${message}`;
        indicator.style.display = 'block';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 5000);
    }
    
    validateConfig() {
        // Simple config validation
        const title = document.getElementById('edit_title').value.trim();
        const timeLimit = parseInt(document.getElementById('edit_time_limit').value);
        const memoryLimit = parseInt(document.getElementById('edit_memory_limit').value);
        
        const configValidation = document.getElementById('config-validation');
        
                if (title && timeLimit > 0 && memoryLimit > 0) {
            this.updateValidationStatus(configValidation, 'valid', 'Configuration is valid');
        } else {
            this.updateValidationStatus(configValidation, 'invalid', 'Missing required configuration');
        }
    }
}
    
// Initialize the enhanced editor when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing Problem Editor...');
    
    // Add some debugging information
    console.log('Monaco Editor script loaded:', typeof require !== 'undefined');
    console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
    
    // Check if containers exist
    const containers = ['statement', 'solution', 'generator', 'validator', 'checker'];
    containers.forEach(type => {
        const container = document.getElementById(`${type}-monaco-editor`);
        console.log(`Container ${type}-monaco-editor exists:`, !!container);
    });
    
    try {
        window.problemEditor = new ProblemEditor();
        window.problemEditor.init().catch(error => {
            console.error('Failed to initialize Problem Editor async:', error);
        });
    } catch (error) {
        console.error('Failed to initialize Problem Editor:', error);
        
        // Fallback: Create simple textarea editors
        containers.forEach(type => {
            const container = document.getElementById(`${type}-monaco-editor`);
            if (container) {
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control code-editor';
                textarea.style.width = '100%';
                textarea.style.height = '600px';
                textarea.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
                textarea.placeholder = `Enter ${type} content here...`;
                container.appendChild(textarea);
            }
        });
    }
});
</script>
{% endblock %}
