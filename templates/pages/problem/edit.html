{% extends "layouts/base.html" %}
{% from "layouts/components.html" import enhanced_breadcrumb, problem_header %}

{% block title %}Edit Problem - {{ problem.config.get('title') or problem.slug }} - ShahOJ{% endblock %}

{% block extra_css %}
<!-- Monaco Editor CSS -->
<link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">
<!-- Monaco Editor Component CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/monaco-editor-component.css') }}">

<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --border-radius: 8px;
        --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    body { background-color: var(--primary-bg); }

    /* Enhanced Layout */
    .edit-container {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    /* Progress Bar */
    .progress-header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

        /* Enhanced Sidebar */
    .sidebar-container { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; border: 1px solid var(--border-color); color: var(--text-primary); }

    .sidebar-container .card-header { background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); padding: 1rem 1.25rem; border-radius: var(--border-radius) var(--border-radius) 0 0; color: var(--text-primary); }

    .sidebar-container .card-header h5 { margin: 0; font-weight: 600; color: var(--text-primary); font-size: 1rem; }
    
    .file-tab {
        cursor: pointer;
        transition: var(--transition);
        border: none;
        border-left: 4px solid transparent;
        position: relative;
        padding: 1rem 1.25rem;
        margin: 0;
        border-bottom: 1px solid var(--border-color);
        background: transparent;
        color: var(--text-primary);
    }
    
    .file-tab:hover {
        background: linear-gradient(90deg, var(--secondary-bg), var(--card-bg));
        border-left-color: var(--btn-primary);
        transform: translateX(2px);
    }
    [data-theme="dark"] .file-tab:hover { background: linear-gradient(90deg, #2d2d30, #252526) !important; }
    
    .file-tab.active {
        background: linear-gradient(90deg, rgba(14, 99, 156, 0.25), rgba(14, 99, 156, 0.45));
        color: var(--text-primary);
        border-left-color: var(--btn-primary);
        border-left-width: 6px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .file-tab.active:hover {
        transform: none;
    }
    
    .file-tab.modified {
        font-weight: 600;
    }
    
    .file-tab.modified::after {
        content: "‚óè";
        color: var(--warning-color);
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .file-tab.active.modified::after {
        color: #f0ad4e;
    }

    .file-tab .d-flex {
        align-items: flex-start;
        gap: 0.75rem;
    }

    .file-tab i {
        margin-top: 0.125rem;
        font-size: 1.1rem;
    }

    .file-tab strong {
        font-size: 0.95rem;
        line-height: 1.3;
        margin-bottom: 0.25rem;
        display: block;
    }

    .file-tab small {
        font-size: 0.8rem;
        opacity: 0.8;
        line-height: 1.2;
    }

    .file-tab.active small {
        opacity: 0.7;
    }

    .file-status {
        font-size: 0.7rem;
        margin-top: 0.375rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .file-status i {
        font-size: 0.7rem;
        margin-top: 0;
    }

    .status-complete { 
        color: var(--success-color);
    }
    .status-incomplete { 
        color: var(--danger-color);
    }
    .status-optional { 
        color: var(--info-color);
    }

    .validation-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.375rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        min-width: 2rem;
        height: 2rem;
    }

    .sidebar-container .card-footer { background: var(--secondary-bg); border-top: 1px solid var(--border-color); padding: 1rem 1.25rem; border-radius: 0 0 var(--border-radius) var(--border-radius); color: var(--text-primary); }

    .sidebar-container .card-footer .row {
        margin: 0;
    }

    .sidebar-container .card-footer .col-4 {
        padding: 0.5rem;
        text-align: center;
    }

    .sidebar-container .card-footer .fw-bold {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        display: block;
    }

    .sidebar-container .card-footer small {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
    }

    .auto-build-panel {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--card-bg);
        box-shadow: var(--box-shadow);
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        transition: var(--transition);
    }

    .auto-build-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.85rem 1.1rem;
        background: var(--secondary-bg);
        border-bottom: 1px solid var(--border-color);
    }

    .auto-build-status {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .auto-build-status strong {
        font-size: 0.95rem;
    }

    .auto-build-actions {
        display: flex;
        gap: 0.5rem;
    }

    .auto-build-body {
        padding: 1rem 1.1rem 1.25rem 1.1rem;
    }

    .auto-build-progress .progress {
        height: 0.55rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    [data-theme="dark"] .auto-build-progress .progress {
        background: rgba(255, 255, 255, 0.1);
    }

    .auto-build-progress .progress-bar {
        background: linear-gradient(135deg, var(--btn-primary), #0a83d8);
    }

    .auto-build-steps {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }

    .auto-build-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 0.6rem;
        border-left: 3px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .auto-build-step.completed {
        border-left-color: var(--success-color);
        color: var(--success-color);
    }

    .auto-build-step.active {
        border-left-color: var(--btn-primary);
        color: var(--btn-primary);
        font-weight: 600;
    }

    .auto-build-step.failed {
        border-left-color: var(--danger-color);
        color: var(--danger-color);
        font-weight: 600;
    }

    .auto-build-step small {
        color: inherit;
        opacity: 0.8;
        font-size: 0.8rem;
    }

    .auto-build-message {
        margin-top: 1rem;
        font-size: 0.9rem;
    }

    .auto-build-summary {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: var(--border-radius);
        background: rgba(40, 167, 69, 0.08);
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .auto-build-summary.failed {
        background: rgba(220, 53, 69, 0.08);
        border-color: rgba(220, 53, 69, 0.25);
    }

    .auto-build-summary .alert-info {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #ffffff;
    }

    [data-theme="dark"] .auto-build-summary .alert-info {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #ffffff;
    }

    .auto-build-summary h6 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        position: sticky;
        top: 0;
        padding-bottom: 0.5rem;
        background: inherit;
    }

    .auto-build-summary-details {
        margin-left: 1.75rem;
        margin-top: 0.35rem;
        margin-bottom: 0.35rem;
        padding-left: 0.75rem;
        border-left: 2px solid rgba(0,0,0,0.1);
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.45;
    }

    [data-theme="dark"] .auto-build-summary-details {
        border-left-color: rgba(255,255,255,1);
    }

    .auto-build-summary-details strong {
        color: var(--text-primary);
    }

    .auto-build-summary-detail-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.35rem;
        flex-wrap: wrap;
    }

    .auto-build-summary-detail-label {
        font-weight: 600;
        min-width: 90px;
    }

    .auto-build-summary-detail-value {
        flex: 1;
        white-space: pre-wrap;
        word-break: break-word;
    }

    #autoBuildConfigModal .auto-build-option-card {
        position: relative;
        display: block;
        padding: 1.25rem 3.25rem 1.35rem 1.5rem;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: var(--bs-card-bg, rgba(32, 37, 48, 0.9));
        transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
        cursor: pointer;
        height: 100%;
        overflow: hidden;
        min-height: 136px;
    }

    #autoBuildConfigModal .auto-build-option-card:hover,
    #autoBuildConfigModal .auto-build-option-card:focus-within {
        transform: translateY(-2px);
        border-color: rgba(13, 110, 253, 0.55);
        box-shadow: 0 16px 32px rgba(13, 110, 253, 0.15);
    }

    #autoBuildConfigModal .auto-build-option-card.selected {
        border-color: rgba(13, 110, 253, 0.7);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.14), rgba(13, 110, 253, 0.04));
        box-shadow: 0 18px 40px rgba(13, 110, 253, 0.25);
    }

    #autoBuildConfigModal .auto-build-option-card input.auto-build-option-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    #autoBuildConfigModal .auto-build-option-content h6 {
        font-weight: 700;
        font-size: 1.05rem;
        margin-bottom: 0.4rem;
        color: inherit;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    #autoBuildConfigModal .auto-build-option-content p {
        margin: 0;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.68);
        line-height: 1.45;
    }

    #autoBuildConfigModal .auto-build-option-card.selected .auto-build-option-content p {
        color: rgba(255, 255, 255, 0.82);
    }

    #autoBuildConfigModal .auto-build-option-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.35);
        transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    #autoBuildConfigModal .auto-build-option-card:hover .auto-build-option-indicator {
        background: rgba(13, 110, 253, 0.15);
        color: rgba(13, 110, 253, 0.65);
    }

    #autoBuildConfigModal .auto-build-option-card.selected .auto-build-option-indicator {
        background: rgba(13, 110, 253, 0.85);
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 8px 18px rgba(13, 110, 253, 0.35);
    }

    #autoBuildConfigModal .auto-build-option-card.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    #autoBuildConfigModal .auto-build-option-card.disabled:hover {
        transform: none;
        box-shadow: none;
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-card {
        background: rgba(246, 248, 252, 0.96);
        border-color: rgba(23, 43, 77, 0.1);
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-card.selected {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.16), rgba(13, 110, 253, 0.05));
        border-color: rgba(13, 110, 253, 0.55);
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-content p {
        color: rgba(17, 24, 39, 0.68);
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-card.selected .auto-build-option-content p {
        color: rgba(17, 24, 39, 0.84);
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-indicator {
        background: rgba(17, 24, 39, 0.08);
        color: rgba(17, 24, 39, 0.45);
    }

    [data-theme="light"] #autoBuildConfigModal .auto-build-option-card.selected .auto-build-option-indicator {
        background: rgba(13, 110, 253, 0.9);
        color: #fff;
    }

    #autoBuildTestOptions.auto-build-test-grid {
        display: flex;
        gap: 1rem;
    }

    #autoBuildTestOptions.auto-build-test-grid .col-auto {
        flex: 1;
    }

    #autoBuildTestOptions.auto-build-test-grid .form-control {
        width: 100%;
    }

    #autoBuildTestOptions .form-text {
        color: var(--text-secondary);
    }

    [data-theme="dark"] #autoBuildTestOptions .form-text {
        color: rgba(255, 255, 255, 0.65);
    }

    .auto-build-footer {
        margin-top: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .auto-build-footer .btn {
        min-width: 140px;
    }

    /* Enhanced Editor Container */
    .editor-container { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow: hidden; color: var(--text-primary); }

    .editor-header { background: var(--secondary-bg); padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; color: var(--text-primary); }

    /* Beautiful gradient for editor headers in dark mode */
    [data-theme="dark"] .editor-header {
        background: linear-gradient(135deg, var(--btn-primary), #094766) !important;
        color: #ffffff !important;
        border-color: #3e3e42 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    }

    .editor-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .ai-generate-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
        white-space: nowrap;
    }

    .ai-generate-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.2);
    }

    .ai-generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .ai-generate-btn.loading {
        position: relative;
    }

    .ai-generate-btn.loading .fas {
        animation: spin 1s linear infinite;
    }

    /* AI Polish Button */
    .ai-polish-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
        white-space: nowrap;
        border-color: #28a745;
        color: #28a745;
    }

    .ai-polish-btn:hover {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }

    .ai-polish-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .ai-polish-btn.loading .fas {
        animation: sparkle 1.5s ease-in-out infinite;
    }

    /* Dark mode styling for AI buttons */
    [data-theme="dark"] .ai-generate-btn {
        background-color: rgba(0, 123, 255, 0.1) !important;
        border-color: var(--btn-primary) !important;
        color: #79b8ff !important;
    }

    [data-theme="dark"] .ai-generate-btn:hover {
        background: linear-gradient(135deg, var(--btn-primary), #094766) !important;
        border-color: var(--btn-primary) !important;
        color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4) !important;
    }

    [data-theme="dark"] .ai-polish-btn {
        background-color: rgba(40, 167, 69, 0.1) !important;
        border-color: #28a745 !important;
        color: #4caf50 !important;
    }

    [data-theme="dark"] .ai-polish-btn:hover {
        background: linear-gradient(135deg, #28a745, #1e7e34) !important;
        border-color: #28a745 !important;
        color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
    }

    [data-theme="dark"] .ai-generate-btn:disabled,
    [data-theme="dark"] .ai-polish-btn:disabled {
        background-color: rgba(108, 117, 125, 0.1) !important;
        border-color: #6c757d !important;
        color: #6c757d !important;
        opacity: 0.6;
    }

    /* Dark mode styling for validator control section */
    [data-theme="dark"] .validator-control-section {
        background-color: var(--secondary-bg) !important;
        border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .validator-control-section .alert-info {
        background-color: rgba(23, 162, 184, 0.1) !important;
        border-color: rgba(23, 162, 184, 0.2) !important;
        color: #79b8ff !important;
    }

    [data-theme="dark"] .validator-control-section .alert-info strong {
        color: #ffffff !important;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes sparkle {
        0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
    }

    /* AI Generation Modal */
    .ai-preview-container { background: var(--secondary-bg); border-radius: var(--border-radius); padding: 1rem; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); color: var(--text-primary); }

    .ai-preview-container pre { background: var(--card-bg); padding: 1rem; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.9rem; line-height: 1.4; margin: 0; color: var(--text-primary); }

    .ai-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ai-status-indicator.available {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .ai-status-indicator.unavailable {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* AI Explanation Styling */
    .ai-explanation-container { background: var(--secondary-bg); border-left: 4px solid var(--btn-primary); border-radius: var(--border-radius); padding: 1rem; }

    .ai-explanation-content { font-size: 0.95rem; line-height: 1.5; color: var(--text-primary); white-space: pre-wrap; max-height: 200px; overflow-y: auto; }

    .editor-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        font-size: 1.1rem;
    }

    .editor-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }


    
    /* Fallback textarea styling */
    .code-editor {
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        border: none;
        resize: vertical;
        background-color: var(--secondary-bg);
        color: var(--text-primary);
        padding: 10px;
    }
    
    .code-editor:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .config-section { background: var(--secondary-bg); padding: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); color: var(--text-primary); }

    .config-section h6 { color: var(--text-primary); margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

    /* Form elements within config sections */
    .config-section .form-label { color: var(--text-primary) !important; }
    .config-section .form-text { color: var(--text-secondary) !important; }
    .config-section .form-control, .config-section .form-select, .config-section textarea { background-color: var(--input-bg) !important; color: var(--text-primary) !important; border-color: var(--input-border) !important; }
    .config-section .input-group-text { background-color: var(--secondary-bg) !important; color: var(--text-primary) !important; border-color: var(--input-border) !important; }
    [data-theme="dark"] .config-section .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23cccccc' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important; }

    /* Loading overlay theme-aware */
    .loading-overlay { background: rgba(255, 255, 255, 0.9); }
    [data-theme="dark"] .loading-overlay { background: rgba(0, 0, 0, 0.6) !important; }

    /* Validation Indicators */
    .validation-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .validation-valid {
        background-color: #d4edda;
        color: #155724;
    }
    
    .validation-invalid {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .validation-loading {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .validation-pending {
        background-color: #e2e3e5;
        color: #6c757d;
    }



    /* Enhanced Buttons */
    .btn-enhanced {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        border: 1px solid transparent;
    }

    .btn-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Save Status */
    .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: none;
    }





    /* Responsive Design */
    @media (max-width: 768px) {
        .config-grid {
            grid-template-columns: 1fr;
        }
        
        .action-grid {
            grid-template-columns: 1fr;
        }
        
        .editor-header {
            flex-direction: column;
            align-items: stretch;
        }

        .sidebar-container {
            position: relative;
            top: 0;
            max-height: none;
            margin-bottom: 1rem;
        }

        .file-tab {
            padding: 0.75rem 1rem;
        }

        .file-tab .d-flex {
            gap: 0.5rem;
        }

        .file-tab strong {
            font-size: 0.9rem;
        }

        .file-tab small {
            font-size: 0.75rem;
        }

        .sidebar-container .card-footer .col-4 {
            padding: 0.25rem;
        }

        .sidebar-container .card-footer .fw-bold {
            font-size: 1rem;
        }
    }

    /* Loading States */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: var(--border-radius);
    }

    .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Enhanced Tooltips */
    .tooltip-enhanced {
        position: relative;
        cursor: help;
    }

    .tooltip-enhanced::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dark-color);
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
        z-index: 1000;
    }

    .tooltip-enhanced:hover::after {
        opacity: 1;
        visibility: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Enhanced Breadcrumb -->
    {{ enhanced_breadcrumb([
        {'text': 'Dashboard', 'url': url_for('dashboard'), 'icon': 'fas fa-home'},
        {'text': problem.config.get('title') or problem.slug, 'url': url_for('problem_detail', slug=problem.slug), 'icon': 'fas fa-file-code'},
        {'text': 'Edit', 'icon': 'fas fa-edit'}
    ]) }}

    <!-- Enhanced Problem Header -->
    {{ problem_header(
        'Edit Problem',
        problem.config.get('title') or problem.slug,
        [
            {'text': 'AI Auto-Build', 'icon': 'fas fa-rocket', 'class': 'btn-primary btn-lg', 'id': 'autoBuildLaunchBtn'},
            {'text': 'Save All Changes', 'icon': 'fas fa-save', 'class': 'btn-light', 'id': 'saveAllBtn'},
            {'text': 'Discard Changes', 'icon': 'fas fa-undo', 'class': 'btn-light', 'onclick': 'location.reload()'},
            {'text': 'Back to Problem', 'icon': 'fas fa-arrow-left', 'class': 'btn-light', 'onclick': "location.href='" + url_for('problem_detail', slug=problem.slug) + "'"}
        ]
    ) }}



    <div class="row">
        
        <!-- Enhanced File Tabs Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="sidebar-container">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-folder-open"></i> Problem Files</h5>
                </div>
                <div class="list-group list-group-flush">
                    
                    <!-- Configuration -->
                    <div class="list-group-item file-tab active" data-file="config" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-cog text-primary me-2"></i>
                                <div>
                        <strong>Configuration</strong>
                                    <div class="file-status status-complete">
                                        <i class="fas fa-check"></i> Complete
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-valid" id="config-validation">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Basic settings & metadata</small>
                    </div>
                    
                    <!-- Statement -->
                    <div class="list-group-item file-tab" data-file="statement" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-info me-2"></i>
                                <div>
                        <strong>statement.md</strong>
                                    <div class="file-status status-incomplete" id="statement-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="statement-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Problem description</small>
                    </div>
                    
                    <!-- Solution -->
                    <div class="list-group-item file-tab" data-file="solution" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-code text-success me-2"></i>
                                <div>
                        <strong>solution.py</strong>
                                    <div class="file-status status-incomplete" id="solution-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="solution-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Reference solution</small>
                    </div>
                    
                    <!-- Generator -->
                    <div class="list-group-item file-tab" data-file="generator" data-required="true">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-random text-warning me-2"></i>
                                <div>
                        <strong>generator.py</strong>
                                    <div class="file-status status-incomplete" id="generator-status">
                                        <i class="fas fa-exclamation-circle"></i> Required
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="generator-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Test case generator</small>
                    </div>
                    
                    <!-- Validator -->
                    <div class="list-group-item file-tab" data-file="validator" data-required="false">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-shield-alt text-secondary me-2"></i>
                                <div>
                        <strong>validator.py</strong>
                                    <div class="file-status status-optional" id="validator-status">
                                        <i class="fas fa-info-circle"></i> Optional
                                    </div>
                                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="validator-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Input validator (optional)</small>
                    </div>
                    
                    <!-- Custom Checker -->
                    <div class="list-group-item file-tab" data-file="checker" data-required="false">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-gavel text-danger me-2"></i>
                                <div>
                        <strong>checker/spj.cpp</strong>
                                    <div class="file-status status-optional" id="checker-status">
                                        <i class="fas fa-info-circle"></i> Optional
                    </div>
                </div>
                            </div>
                            <div class="validation-indicator validation-pending" id="checker-validation">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <small class="d-block text-muted mt-1">Special judge (optional)</small>
            </div>
            
                </div>
                
            </div>
        </div>

        <!-- Enhanced File Editor -->
        <div class="col-lg-9 col-md-8">
            <div class="file-content mb-3" id="auto-build-card" style="display: none;">
                <div class="editor-container auto-build-card" id="autoBuildPanel">
                    <div class="editor-header auto-build-header">
                        <div class="auto-build-status">
                            <strong>Auto-Build Status</strong>
                            <span id="autoBuildStatusText" class="text-muted">Idle</span>
                        </div>
                        <div class="auto-build-actions">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="autoBuildReloadBtn" style="display: none;">
                                <i class="fas fa-sync"></i> Reload Page
                            </button>
                        </div>
                    </div>
                    <div class="auto-build-body">
                        <div class="auto-build-progress">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" id="autoBuildProgressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <ul class="auto-build-steps" id="autoBuildStepList"></ul>
                        <div class="auto-build-message" id="autoBuildMessage"></div>
                        <div class="auto-build-summary" id="autoBuildSummary" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Configuration Editor -->
            <div class="file-content active" id="config-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-cog text-primary"></i> Problem Configuration
                        </h5>
                    </div>
                    <div class="config-grid">
                        <!-- Basic Information -->
                        <div class="config-section">
                            <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                                <div class="mb-3">
                                <label for="edit_title" class="form-label">Problem Title *</label>
                                    <input type="text" class="form-control" id="edit_title" 
                                       value="{{ problem.config.get('title') or '' }}"
                                       placeholder="Enter a descriptive problem title">
                                <div class="form-text">This will be displayed as the main problem title</div>
                                </div>
                                
                                <div class="mb-3">
                                <label for="edit_difficulty" class="form-label">Difficulty Level</label>
                                    <select class="form-select" id="edit_difficulty">
                                    <option value="Easy" {% if problem.config.get('difficulty') == 'Easy' %}selected{% endif %}>üü¢ Easy</option>
                                    <option value="Medium" {% if problem.config.get('difficulty') == 'Medium' %}selected{% endif %}>üü° Medium</option>
                                    <option value="Hard" {% if problem.config.get('difficulty') == 'Hard' %}selected{% endif %}>üî¥ Hard</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_tags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="edit_tags" 
                                       value="{{ (problem.config.get('tags') or [])|join(', ') }}"
                                       placeholder="array, sorting, dynamic-programming">
                                <div class="form-text">Comma-separated tags for categorization</div>
                            </div>
                            
                            </div>
                            
                        <!-- Limits & Constraints -->
                        <div class="config-section">
                            <h6><i class="fas fa-stopwatch"></i> Limits & Constraints</h6>
                                <div class="mb-3">
                                    <label for="edit_time_limit" class="form-label">Time Limit (ms)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="edit_time_limit" 
                                           value="{{ problem.config.limits.time_ms or 1000 }}"
                                           min="100" max="10000" step="100">
                                    <span class="input-group-text">ms</span>
                                </div>
                                <div class="form-text">Typical: 1000ms for most problems</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="edit_memory_limit" class="form-label">Memory Limit (MB)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="edit_memory_limit" 
                                           value="{{ problem.config.limits.memory_mb or 256 }}"
                                           min="64" max="1024" step="64">
                                    <span class="input-group-text">MB</span>
                                </div>
                                <div class="form-text">Typical: 256MB for most problems</div>
                                </div>
                                
                            <div class="mb-0">
                                <label for="edit_checker_type" class="form-label">Output Checker</label>
                                    <select class="form-select" id="edit_checker_type">
                                    <option value="diff" {% if problem.config.checker.type == 'diff' %}selected{% endif %}>
                                        üìù Exact Match (diff)
                                    </option>
                                    <option value="float" {% if problem.config.checker.type == 'float' %}selected{% endif %}>
                                        üî¢ Floating Point (1e-6 tolerance)
                                    </option>
                                    <option value="spj" {% if problem.config.checker.type == 'spj' %}selected{% endif %}>
                                        ‚öñÔ∏è Special Judge (Custom)
                                    </option>
                                    </select>
                                <div class="form-text">How to compare solution output with expected answer</div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statement Editor -->
            <div class="file-content" id="statement-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-file-alt text-info"></i> Problem Statement
                        </h5>
                        <div class="editor-actions">
                            <button type="button" class="btn btn-outline-success btn-sm ai-polish-btn" 
                                    data-file-type="statement" title="Polish with AI">
                                <i class="fas fa-sparkles"></i> Polish with AI
                            </button>
                        </div>
                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="statement-monaco-editor"></div>
                        <div class="editor-resize-handle" id="statement-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Solution Editor -->
            <div class="file-content" id="solution-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-code text-success"></i> Reference Solution
                        </h5>
                        <div class="editor-actions">
                            <button type="button" class="btn btn-outline-primary btn-sm ai-generate-btn" 
                                    data-file-type="solution" title="Generate with AI">
                                <i class="fas fa-magic"></i> Generate with AI
                            </button>
                        </div>
                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="solution-monaco-editor"></div>
                        <div class="editor-resize-handle" id="solution-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Generator Editor -->
            <div class="file-content" id="generator-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-random text-warning"></i> Test Generator
                        </h5>
                        <div class="editor-actions">
                            <button type="button" class="btn btn-outline-primary btn-sm ai-generate-btn" 
                                    data-file-type="generator" title="Generate with AI">
                                <i class="fas fa-magic"></i> Generate with AI
                            </button>
                        </div>
                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="generator-monaco-editor"></div>
                        <div class="editor-resize-handle" id="generator-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Validator Editor -->
            <div class="file-content" id="validator-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-shield-alt text-secondary"></i> Input Validator
                        </h5>
                        <div class="editor-actions">
                            <button type="button" class="btn btn-outline-primary btn-sm ai-generate-btn me-3" 
                                    data-file-type="validator" title="Generate with AI">
                                <i class="fas fa-magic"></i> Generate with AI
                            </button>
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="validatorEnabled" 
                                       {{ 'checked' if problem.config.get('validation.enabled', False) else '' }}>
                                <label class="form-check-label" for="validatorEnabled">
                                    Enable Validation
                                </label>
                            </div>

                        </div>
                    </div>
                    
                    <div class="p-3 bg-light border-bottom validator-control-section">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>Validator Control:</strong> 
                            <span id="validatorStatusText">
                                {% if problem.config.get('validation.enabled', False) %}
                                    Validation is <strong>enabled</strong>. Generated test cases will be validated.
                                {% else %}
                                    Validation is <strong>disabled</strong>. Test cases will be generated without validation.
                                {% endif %}
                            </span>
                        </div>
                        </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="validator-monaco-editor"></div>
                        <div class="editor-resize-handle" id="validator-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

            <!-- Checker Editor -->
            <div class="file-content" id="checker-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <h5 class="editor-title">
                            <i class="fas fa-gavel text-danger"></i> Custom Checker (SPJ)
                        </h5>
                        <div class="editor-actions">
                            <button type="button" class="btn btn-outline-primary btn-sm ai-generate-btn" 
                                    data-file-type="spj" title="Generate with AI">
                                <i class="fas fa-magic"></i> Generate with AI
                            </button>
                        </div>
                    </div>
                    

                    
                    <div class="editor-resize-container">
                        <div class="monaco-editor-container" id="checker-monaco-editor"></div>
                        <div class="editor-resize-handle" id="checker-monaco-editor-resize-handle"></div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- Test Integration Results Modal -->
    <div class="modal fade" id="integrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-flask"></i> Integration Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="integrationResults">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Context Input Modal -->
    <div class="modal fade" id="aiContextModal" tabindex="-1" aria-labelledby="aiContextModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiContextModalLabel">
                        <i class="fas fa-brain"></i> AI Generation Context
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3" id="aiContextDescription">
                        Provide additional context to guide the AI generation. This helps the AI understand your specific requirements and constraints.
                    </p>
                    <div class="mb-3">
                        <label for="aiContextInput" class="form-label">
                            <i class="fas fa-comment-alt"></i> Additional Context for AI
                            <span class="text-muted">(Optional)</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="aiContextInput" 
                            rows="4" 
                            placeholder="Provide any additional context, requirements, or preferences for the AI generation...&#10;&#10;Examples:&#10;‚Ä¢ Use a specific algorithm approach&#10;‚Ä¢ Include detailed comments&#10;‚Ä¢ Focus on edge cases&#10;‚Ä¢ Use certain coding style"></textarea>
                        <div class="form-text">
                            This context will be used to guide the AI generation. Leave empty for default behavior.
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Your context will be saved for this problem and used for all AI generations.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="continueWithAI">
                        <i class="fas fa-magic"></i> Continue with AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal fade" id="aiGenerationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-magic text-primary"></i> 
                        AI Code Generation - <span id="aiModalFileType">File Type</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="aiGenerationStatus">
                        <!-- Status messages will be populated by JavaScript -->
                    </div>

                    <div id="aiGenerationPreview" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-eye"></i> Generated Code Preview
                        </h6>
                        <div class="ai-preview-container">
                            <pre id="aiGeneratedCode"></pre>
                        </div>
                        
                        <!-- AI Explanation Section -->
                        <div id="aiExplanationSection" class="mt-3" style="display: none;">
                            <h6 class="mb-2">
                                <i class="fas fa-lightbulb"></i> AI Explanation
                            </h6>
                            <div class="ai-explanation-container">
                                <div id="aiExplanationContent" class="ai-explanation-content"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Review the generated code carefully.</strong> 
                                The AI has created this code based on your problem statement. 
                                You can edit it further after applying it to the editor.
                            </div>
                        </div>
                    </div>

                    <div id="aiGenerationError" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Generation Failed:</strong>
                            <span id="aiErrorMessage"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyAiCodeBtn" style="display: none;">
                        <i class="fas fa-check"></i> Apply to Editor
                    </button>
                    <button type="button" class="btn btn-primary" id="regenerateAiCodeBtn" style="display: none;">
                        <i class="fas fa-redo"></i> Regenerate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div class="save-indicator alert" id="saveIndicator">
        <!-- Save status messages -->
    </div>

    <!-- Auto-Build Configuration Modal -->
    <div class="modal fade" id="autoBuildConfigModal" tabindex="-1" aria-labelledby="autoBuildConfigLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="autoBuildConfigLabel"><i class="fas fa-rocket"></i> AI Auto-Build</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="autoBuildConfigForm">
                    <div class="modal-body">
                        <p class="text-muted">Select which artifacts the AI should generate. You can fine-tune test counts and toggle optional components.</p>

                        <!-- AI Context Input Section -->
                        <div class="mb-4">
                            <div class="card border-primary" style="border-left: 4px solid var(--btn-primary) !important;">
                                <div class="card-body py-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-brain text-primary me-2"></i>
                                        <h6 class="mb-0">AI Context (Optional)</h6>
                                    </div>
                                    <textarea 
                                        class="form-control" 
                                        id="autoBuildContextInput" 
                                        rows="3" 
                                        placeholder="Provide additional context to guide AI generation across all artifacts...&#10;&#10;Examples:&#10;‚Ä¢ Use specific algorithms or data structures&#10;‚Ä¢ Include detailed comments and explanations&#10;‚Ä¢ Focus on particular constraints or edge cases&#10;‚Ä¢ Prefer certain coding styles or patterns"></textarea>
                                    <div class="form-text mt-2">
                                        <i class="fas fa-info-circle"></i>
                                        This context will be used for generating all selected artifacts and saved for future AI operations on this problem.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildStatementCheckbox" checked>
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-sparkles"></i> Polish problem statement</h6>
                                        <p>Use AI to clean up and standardise your Markdown statement.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildSolutionCheckbox" checked>
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-code"></i> Generate reference solution</h6>
                                        <p>Create a Python solution stub tailored to your statement.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildGeneratorCheckbox" checked>
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-random"></i> Generate test generator</h6>
                                        <p>Produce a Python script that emits randomised testcases.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildValidatorCheckbox">
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-shield-alt"></i> Generate input validator</h6>
                                        <p>Ensure <code>Enable Validation</code> is switched on before running.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildSpjCheckbox">
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-gavel"></i> Generate special judge (SPJ)</h6>
                                        <p>Creates a C++ checker using <code>testlib</code>.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                            <div class="col-md-6">
                                <label class="auto-build-option-card" data-option-card>
                                    <input class="auto-build-option-input" type="checkbox" id="autoBuildTestsCheckbox" checked>
                                    <div class="auto-build-option-content">
                                        <h6><i class="fas fa-vials"></i> Generate testcases</h6>
                                        <p>Runs the generator to populate samples/system tests.</p>
                                    </div>
                                    <span class="auto-build-option-indicator"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                        </div>

                        <hr>

                        <div class="row g-3 align-items-end auto-build-test-grid" id="autoBuildTestOptions">
                            <div class="col-auto">
                                <label class="form-label" for="autoBuildSamplesInput">Sample tests</label>
                                <input type="number" class="form-control" id="autoBuildSamplesInput" min="0" max="10" value="3">
                                <div class="form-text">Number of sample cases to regenerate.</div>
                            </div>
                            <div class="col-auto">
                                <label class="form-label" for="autoBuildSystemInput">System tests</label>
                                <input type="number" class="form-control" id="autoBuildSystemInput" min="0" max="50" value="10">
                                <div class="form-text">Number of system tests to produce.</div>
                            </div>
                        </div>

                        <div id="autoBuildModalAlert" class="alert alert-warning mt-3" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="autoBuildStartBtn">
                            <i class="fas fa-rocket"></i> Start Auto-Build
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hidden elements to store initial content safely -->
    <script type="application/json" id="initial-content-data">
    {
        "statement": {{ (statement_content or '')|tojson }},
        "solution": {{ (solution_content or '')|tojson }},
        "generator": {{ (generator_content or '')|tojson }},
        "validator": {{ (validator_content or '')|tojson }},
        "checker": {{ (checker_content or '')|tojson }}
    }
    </script>

</div>
{% endblock %}

{% block extra_js %}
<!-- Monaco Editor JS -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Monaco Editor Component JS -->
<script src="{{ url_for('static', filename='js/monaco-editor-component.js') }}"></script>
<script src="{{ url_for('static', filename='js/monaco-editor-presets.js') }}"></script>

<script>
// Enhanced Problem Editor with Reusable Monaco Components
class ProblemEditor {
    constructor() {
        this.currentFile = 'config';
        this.originalContents = {};
        this.modifiedFiles = new Set();
        this.editors = {};

        this.validationCache = new Map();
        this.initialized = false;
        this.autoBuildState = {
            isRunning: false,
            options: this.normalizeAutoBuildOptions({}),
            currentSteps: null,
            currentStepIndex: -1,
            progressTimer: null
        };
        this.autoBuildElements = {};
        
        // Editor will be initialized via init() method call
    }
    
    async init() {
        if (this.initialized) {
            return;
        }
        
        try {
            this.initialized = true;
            
            // Wait for DOM to be fully ready
            await new Promise(resolve => {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            });
            
            this.cacheAutoBuildElements();
            this.setupEventListeners();
            this.loadFileContents();
            
            // Initialize Monaco Editors using our reusable components
                setTimeout(() => {
                this.initializeEditors();
                this.switchToFile('config');
            }, 100);
            
        } catch (error) {
            console.error('Failed to initialize Problem Editor:', error);
            this.switchToFile('config');
        }
    }
    
    initializeEditors() {
        try {
            // 1. Statement Editor (Markdown)
            this.editors.statement = MonacoEditorPresets.createStatementEditor('statement-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('statement'), // Load content directly
                disableAutoSave: true
            });
            
            // 2. Solution Editor (Python)
            this.editors.solution = MonacoEditorPresets.createPythonSolutionEditor('solution-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('solution'), // Load content directly
                disableAutoSave: true
            });
            
            // 3. Generator Editor (Python)
            this.editors.generator = MonacoEditorPresets.createGeneratorEditor('generator-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('generator'), // Load content directly
                disableAutoSave: true
            });
            
            // 4. Validator Editor (Python)
            this.editors.validator = MonacoEditorPresets.createValidatorEditor('validator-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('validator'), // Load content directly
                disableAutoSave: true
            });
            
                        // 5. Checker Editor (C++)
            this.editors.checker = MonacoEditorPresets.createCheckerEditor('checker-monaco-editor', {
                height: 700,
                defaultValue: this.getInitialContent('checker'), // Load content directly
                disableAutoSave: true
            });
                    
            // Add change listeners to all editors
            this.setupEditorChangeListeners();
            
                        // Update file statuses now that content is loaded
            setTimeout(() => {
                this.updateAllFileStatuses();
            }, 500);
                    
        } catch (error) {
            console.error('Failed to initialize editors:', error);
        }
    }
    
    setupEditorChangeListeners() {
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        
        fileTypes.forEach(fileType => {
            const editor = this.editors[fileType];
            if (editor && editor.editor && editor.editor.onDidChangeModelContent) {
                editor.editor.onDidChangeModelContent(() => {
                    this.markFileModified(fileType);
                    this.validateFileContent(fileType);
                });
            }
        });
    }
    
    loadInitialContent(fileType, editor) {
        try {
            const content = this.getInitialContent(fileType);
            editor.setValue(content);
            
            // Add content change listener to the underlying Monaco editor
            if (editor.editor && editor.editor.onDidChangeModelContent) {
                editor.editor.onDidChangeModelContent(() => {
                    this.markFileModified(fileType);
                    this.validateFileContent(fileType);
                });
            }
                    
                } catch (error) {
            console.warn(`Failed to load initial content for ${fileType}:`, error);
                }
    }
    
    createFallbackEditors() {
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        
        fileTypes.forEach(fileType => {
            const container = document.getElementById(`${fileType}-monaco-editor`);
            if (container) {
                this.createFallbackEditor(fileType, container);
            }
        });
        
        // File statuses will be updated after editors are initialized
    }
    
    createFallbackEditor(fileType, container) {
        // Create a textarea as fallback
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control code-editor';
        textarea.style.width = '100%';
        textarea.style.height = '600px';
        textarea.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
        textarea.style.fontSize = '14px';
        textarea.style.lineHeight = '1.4';
        textarea.value = this.getInitialContent(fileType);
        
        // Clear container and add textarea
        container.innerHTML = '';
        container.appendChild(textarea);
        
        // Store reference for getFileContent method
        this.editors[fileType] = {
            getValue: () => textarea.value,
            setValue: (value) => { textarea.value = value; },
            focus: () => textarea.focus(),
            layout: () => {} // No-op for textarea
        };
        
        // Add change listener
        textarea.addEventListener('input', () => {
            this.markFileModified(fileType);
            this.validateFileContent(fileType);
        });
    }
    
    getInitialContent(fileType) {
        // Get content from JSON data element
        try {
            const dataElement = document.getElementById('initial-content-data');
            
            if (dataElement) {
                const contentData = JSON.parse(dataElement.textContent);
                return contentData[fileType] || '';
            } else {
                console.error('initial-content-data element not found!');
            }
        } catch (error) {
            console.error('Failed to parse initial content data for', fileType, ':', error);
        }
        return '';
    }
    
    setupEventListeners() {
        // File tab switching
        document.querySelectorAll('.file-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const fileName = tab.dataset.file;
                this.switchToFile(fileName);
            });
        });
        
        if (this.autoBuildElements.launchBtn) {
            this.autoBuildElements.launchBtn.addEventListener('click', () => this.openAutoBuildModal());
        }
        this.autoBuildElements.reloadBtn?.addEventListener('click', () => window.location.reload());

        if (this.autoBuildElements.modalForm) {
            this.autoBuildElements.modalForm.addEventListener('submit', (event) => {
                event.preventDefault();
                this.handleAutoBuildModalSubmit();
            });
        }

        this.autoBuildElements.modalTestsCheckbox?.addEventListener('change', (event) => {
            this.toggleAutoBuildTestInputs(event.target.checked);
            this.refreshAutoBuildCheckboxStyles();
        });

        ['modalStatementCheckbox','modalSolutionCheckbox','modalGeneratorCheckbox','modalValidatorCheckbox','modalSpjCheckbox']
            .forEach(key => {
                const input = this.autoBuildElements[key];
                if (!input) return;
                input.addEventListener('change', () => this.refreshAutoBuildCheckboxStyles());
            });

        // Config field changes
    ['edit_title', 'edit_difficulty', 'edit_tags', 'edit_time_limit', 'edit_memory_limit', 'edit_checker_type'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
                field.addEventListener('input', () => {
                    this.markFileModified('config');
                    this.validateConfig();
            });
        }
    });
    
        // Action buttons
        document.getElementById('saveAllBtn')?.addEventListener('click', () => this.saveAllChanges());
        

        
        // Validator toggle
        document.getElementById('validatorEnabled')?.addEventListener('change', (e) => {
            const statusText = document.getElementById('validatorStatusText');
            if (e.target.checked) {
                statusText.innerHTML = 'Validation is <strong>enabled</strong>. Generated test cases will be validated.';
            } else {
                statusText.innerHTML = 'Validation is <strong>disabled</strong>. Test cases will be generated without validation.';
            }
            this.markFileModified('config');
        });
        
        // Window resize handler for Monaco editors
        window.addEventListener('resize', () => {
            this.handleWindowResize();
        });
    }

    cacheAutoBuildElements() {
        const modalElement = document.getElementById('autoBuildConfigModal');
        const bootstrapModal = (typeof bootstrap !== 'undefined' && modalElement)
            ? new bootstrap.Modal(modalElement)
            : null;
        this.autoBuildElements = {
            card: document.getElementById('auto-build-card'),
            panel: document.getElementById('autoBuildPanel'),
            statusText: document.getElementById('autoBuildStatusText'),
            progressBar: document.getElementById('autoBuildProgressBar'),
            stepList: document.getElementById('autoBuildStepList'),
            message: document.getElementById('autoBuildMessage'),
            summary: document.getElementById('autoBuildSummary'),
            reloadBtn: document.getElementById('autoBuildReloadBtn'),
            launchBtn: document.getElementById('autoBuildLaunchBtn'),
            modal: bootstrapModal,
            modalForm: document.getElementById('autoBuildConfigForm'),
            modalSubmit: document.getElementById('autoBuildStartBtn'),
            modalSampleInput: document.getElementById('autoBuildSamplesInput'),
            modalSystemInput: document.getElementById('autoBuildSystemInput'),
            modalStatementCheckbox: document.getElementById('autoBuildStatementCheckbox'),
            modalSolutionCheckbox: document.getElementById('autoBuildSolutionCheckbox'),
            modalGeneratorCheckbox: document.getElementById('autoBuildGeneratorCheckbox'),
            modalValidatorCheckbox: document.getElementById('autoBuildValidatorCheckbox'),
            modalSpjCheckbox: document.getElementById('autoBuildSpjCheckbox'),
            modalTestsCheckbox: document.getElementById('autoBuildTestsCheckbox'),
            modalAlert: document.getElementById('autoBuildModalAlert'),
            modalTestOptions: document.getElementById('autoBuildTestOptions'),
        };

        this.resetAutoBuildUI();
        if (this.autoBuildElements.card) {
            this.autoBuildElements.card.dataset.visible = 'false';
        }

        this.refreshAutoBuildCheckboxStyles();
    }

    getAutoBuildStorageKey() {
        return `pocketoj-auto-build-${this.getSlugFromUrl()}`;
    }

    getAutoBuildOptionsStorageKey() {
        return `${this.getAutoBuildStorageKey()}-options`;
    }

    storeAutoBuildOptions(options) {
        try {
            localStorage.setItem(this.getAutoBuildOptionsStorageKey(), JSON.stringify(options));
        } catch (error) {
            console.warn('Failed to persist auto-build options:', error);
        }
    }

    getStoredAutoBuildOptions() {
        try {
            const raw = localStorage.getItem(this.getAutoBuildOptionsStorageKey());
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (error) {
            console.warn('Failed to parse stored auto-build options:', error);
            return null;
        }
    }

    clearAutoBuildOptions() {
        try {
            localStorage.removeItem(this.getAutoBuildOptionsStorageKey());
        } catch (error) {
            console.warn('Failed to clear stored auto-build options:', error);
        }
    }

    openAutoBuildModal() {
        if (this.autoBuildState.isRunning) {
            this.showAutoBuildPanel();
            return;
        }

        // Show Auto-Build config modal directly (context is now integrated)
        this.performAutoBuildAfterContext();
    }

    performAutoBuildAfterContext() {
        const { modal, modalAlert } = this.autoBuildElements;
        if (!modal) return;

        if (modalAlert) {
            modalAlert.style.display = 'none';
            modalAlert.textContent = '';
        }

        // Load saved context into the Auto-Build modal's context input
        const savedContext = this.loadSavedContext();
        const autoBuildContextInput = document.getElementById('autoBuildContextInput');
        if (autoBuildContextInput) {
            autoBuildContextInput.value = savedContext;
        }

        const storedOptions = this.getStoredAutoBuildOptions();
        const options = this.normalizeAutoBuildOptions(storedOptions || this.autoBuildState.options || {});
        this.applyAutoBuildOptionsToModal(options);
        modal.show();
    }

    applyAutoBuildOptionsToModal(options) {
        const {
            modalStatementCheckbox,
            modalSolutionCheckbox,
            modalGeneratorCheckbox,
            modalValidatorCheckbox,
            modalSpjCheckbox,
            modalTestsCheckbox,
            modalSampleInput,
            modalSystemInput
        } = this.autoBuildElements;

        if (modalStatementCheckbox) modalStatementCheckbox.checked = !!options.polish_statement;
        if (modalSolutionCheckbox) modalSolutionCheckbox.checked = !!options.generate_solution;
        if (modalGeneratorCheckbox) modalGeneratorCheckbox.checked = !!options.generate_generator;
        if (modalValidatorCheckbox) modalValidatorCheckbox.checked = !!options.generate_validator;
        if (modalSpjCheckbox) modalSpjCheckbox.checked = !!options.generate_spj;
        if (modalTestsCheckbox) modalTestsCheckbox.checked = !!options.generate_tests;
        if (modalSampleInput) modalSampleInput.value = options.sample_case_count ?? 3;
        if (modalSystemInput) modalSystemInput.value = options.system_case_count ?? 10;

        this.toggleAutoBuildTestInputs(!!options.generate_tests);
        this.refreshAutoBuildCheckboxStyles();
    }

    collectAutoBuildOptionsFromModal() {
        const {
            modalStatementCheckbox,
            modalSolutionCheckbox,
            modalGeneratorCheckbox,
            modalValidatorCheckbox,
            modalSpjCheckbox,
            modalTestsCheckbox,
            modalSampleInput,
            modalSystemInput
        } = this.autoBuildElements;

        const parseNumber = (input, fallback) => {
            if (!input) return fallback;
            const value = parseInt(input.value, 10);
            if (Number.isNaN(value)) return fallback;
            const min = input.hasAttribute('min') ? parseInt(input.getAttribute('min'), 10) : 0;
            const maxAttr = input.getAttribute('max');
            const max = maxAttr !== null ? parseInt(maxAttr, 10) : Number.POSITIVE_INFINITY;
            return Math.max(min || 0, Math.min(max || Number.POSITIVE_INFINITY, value));
        };

        return this.normalizeAutoBuildOptions({
            polish_statement: modalStatementCheckbox ? modalStatementCheckbox.checked : true,
            generate_solution: modalSolutionCheckbox ? modalSolutionCheckbox.checked : true,
            generate_generator: modalGeneratorCheckbox ? modalGeneratorCheckbox.checked : true,
            generate_validator: modalValidatorCheckbox ? modalValidatorCheckbox.checked : false,
            generate_spj: modalSpjCheckbox ? modalSpjCheckbox.checked : false,
            generate_tests: modalTestsCheckbox ? modalTestsCheckbox.checked : true,
            sample_case_count: parseNumber(modalSampleInput, 3),
            system_case_count: parseNumber(modalSystemInput, 10)
        });
    }

    toggleAutoBuildTestInputs(enabled) {
        const { modalSampleInput, modalSystemInput, modalTestOptions } = this.autoBuildElements;
        [modalSampleInput, modalSystemInput].forEach(input => {
            if (!input) return;
            input.disabled = !enabled;
        });
        if (modalTestOptions) {
            modalTestOptions.style.display = enabled ? '' : 'none';
        }
    }

    getProblemTimeLimit() {
        const input = document.getElementById('edit_time_limit');
        const value = input ? parseInt(input.value, 10) : NaN;
        if (Number.isNaN(value)) {
            return 1000;
        }
        return Math.max(100, value);
    }

    refreshAutoBuildCheckboxStyles() {
        const checkboxKeys = [
            'modalStatementCheckbox',
            'modalSolutionCheckbox',
            'modalGeneratorCheckbox',
            'modalValidatorCheckbox',
            'modalSpjCheckbox',
            'modalTestsCheckbox'
        ];

        checkboxKeys.forEach(key => {
            const input = this.autoBuildElements[key];
            if (!input) return;
            const card = input.closest('.auto-build-option-card');
            if (!card) return;
            card.classList.toggle('selected', input.checked);
            card.classList.toggle('disabled', input.disabled);
        });
    }

    showAutoBuildModalAlert(message, type = 'warning') {
        const alertEl = this.autoBuildElements.modalAlert;
        if (!alertEl) return;
        alertEl.className = `alert alert-${type}`;
        alertEl.innerHTML = message;
        alertEl.style.display = 'block';
    }

    hideAutoBuildModalAlert() {
        const alertEl = this.autoBuildElements.modalAlert;
        if (!alertEl) return;
        alertEl.style.display = 'none';
        alertEl.textContent = '';
    }

    startAutoBuildProgressLoop() {
        this.stopAutoBuildProgressLoop();
        const steps = this.autoBuildState.currentSteps;
        if (!steps || steps.length <= 1) {
            return;
        }

        this.autoBuildState.progressTimer = setInterval(() => {
            const currentSteps = this.autoBuildState.currentSteps;
            if (!currentSteps || currentSteps.length === 0) {
                this.stopAutoBuildProgressLoop();
                return;
            }

            const currentIndex = Math.max(0, this.autoBuildState.currentStepIndex || 0);
            if (currentIndex >= currentSteps.length - 1) {
                this.stopAutoBuildProgressLoop();
                return;
            }

            currentSteps[currentIndex].status = 'completed';
            const nextIndex = currentIndex + 1;
            currentSteps[nextIndex].status = 'active';
            this.autoBuildState.currentStepIndex = nextIndex;

            this.renderAutoBuildSteps(currentSteps);
            this.updateAutoBuildStatus({ status: 'running', message: 'Processing with AI...' }, currentSteps);
        }, 10000);
    }

    stopAutoBuildProgressLoop() {
        if (this.autoBuildState.progressTimer) {
            clearInterval(this.autoBuildState.progressTimer);
            this.autoBuildState.progressTimer = null;
        }
    }

    handleAutoBuildModalSubmit() {
        const { modal } = this.autoBuildElements;
        
        // Extract and save context from the integrated input field
        const autoBuildContextInput = document.getElementById('autoBuildContextInput');
        const context = autoBuildContextInput ? autoBuildContextInput.value.trim() : '';
        this.saveContext(context);
        this.currentAIContext = context;
        
        const options = this.collectAutoBuildOptionsFromModal();

        const selectedFlags = [
            options.polish_statement,
            options.generate_solution,
            options.generate_generator,
            options.generate_validator,
            options.generate_spj,
            options.generate_tests
        ];

        if (!selectedFlags.some(Boolean)) {
            if (document.body.classList.contains('modal-open')) {
                this.showAutoBuildModalAlert('Select at least one artifact to generate.');
            } else if (this.autoBuildElements.message) {
                this.autoBuildElements.message.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Choose at least one artifact to generate.</span>';
            }
            return;
        }

        this.hideAutoBuildModalAlert();

        if (modal && typeof modal.hide === 'function') {
            modal.hide();
        }

        this.startAutoBuild(options);
    }

    normalizeAutoBuildOptions(rawOptions = {}) {
        const defaults = {
            polish_statement: true,
            generate_solution: true,
            generate_generator: true,
            generate_validator: false,
            generate_spj: false,
            generate_tests: true,
            sample_case_count: 3,
            system_case_count: 10,
        };
        const merged = Object.assign({}, defaults, rawOptions || {});
        merged.polish_statement = !!merged.polish_statement;
        merged.generate_solution = !!merged.generate_solution;
        merged.generate_generator = !!merged.generate_generator;
        merged.generate_validator = !!merged.generate_validator;
        merged.generate_spj = !!merged.generate_spj;
        merged.generate_tests = !!merged.generate_tests;
        merged.sample_case_count = Math.max(0, parseInt(merged.sample_case_count, 10) || 0);
        merged.system_case_count = Math.max(0, parseInt(merged.system_case_count, 10) || 0);
        return merged;
    }

    buildAutoBuildStepNames(options) {
        const steps = [];
        if (options.polish_statement) steps.push('Polish statement');
        if (options.generate_solution) steps.push('Generate reference solution');
        if (options.generate_generator) steps.push('Generate test generator');
        if (options.generate_validator) steps.push('Generate input validator');
        if (options.generate_spj) steps.push('Generate special judge');
        if (options.generate_tests) steps.push('Generate test cases');
        return steps;
    }

    renderAutoBuildSteps(stepData) {
        const list = this.autoBuildElements.stepList;
        if (!list) return;

        list.innerHTML = '';
        stepData.forEach(step => {
            const li = document.createElement('li');
            li.className = `auto-build-step ${step.status}`;

            const iconMap = {
                completed: 'fas fa-check-circle',
                active: 'fas fa-spinner fa-spin',
                failed: 'fas fa-times-circle',
                pending: 'fas fa-circle-notch text-muted'
            };

            const icon = iconMap[step.status] || iconMap.pending;
            li.innerHTML = `
                <i class="${icon}"></i>
                <span>${this.escapeHtml(step.name)}</span>
            `;

            list.appendChild(li);
        });
    }

    updateAutoBuildStatus(statusInfo, stepData) {
        const statusText = this.autoBuildElements.statusText;
        const messageEl = this.autoBuildElements.message;
        const progressBar = this.autoBuildElements.progressBar;
        if (!statusText || !progressBar) return;

        const status = (statusInfo && statusInfo.status) ? statusInfo.status : 'pending';
        const message = (statusInfo && statusInfo.message) ? statusInfo.message : '';

        const statusMap = {
            pending: 'Queued',
            running: 'Running',
            succeeded: 'Completed',
            failed: 'Failed'
        };

        statusText.textContent = statusMap[status] || status;

        if (messageEl) {
            if (status === 'succeeded') {
                messageEl.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Auto-build completed successfully.</span>';
            } else if (status === 'failed') {
                const safe = this.escapeHtml(message || 'Auto-build failed.');
                messageEl.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> ${safe}</span>`;
            } else if (message) {
                messageEl.innerHTML = `<span class="text-muted"><i class="fas fa-cog fa-spin"></i> ${this.escapeHtml(message)}</span>`;
            } else {
                messageEl.innerHTML = '';
            }
        }

        const totalSteps = stepData.length || 1;
        const completedCount = stepData.filter(step => step.status === 'completed').length;
        const percent = status === 'succeeded' ? 100 : Math.round((completedCount / totalSteps) * 100);
        const clamped = Math.min(100, Math.max(0, percent));
        progressBar.style.width = `${clamped}%`;
        progressBar.setAttribute('aria-valuenow', `${clamped}`);

        if (status === 'failed') {
            progressBar.classList.add('bg-danger');
        } else {
            progressBar.classList.remove('bg-danger');
        }
    }

    showAutoBuildPanel() {
        const { panel, card } = this.autoBuildElements;
        if (card) {
            card.dataset.visible = 'true';
            card.style.display = 'block';
        }
        if (panel) {
            panel.style.display = 'block';
        }
    }

    setAutoBuildButtonLoading(isLoading) {
        const { launchBtn, modalSubmit } = this.autoBuildElements;
        const setButtonState = (btn, label) => {
            if (!btn) return;
            btn.disabled = !!isLoading;
            if (label) btn.innerHTML = label;
        };

        if (isLoading) {
            setButtonState(launchBtn, '<i class="fas fa-spinner fa-spin"></i> Auto-Building...');
            setButtonState(modalSubmit, '<i class="fas fa-spinner fa-spin"></i> Starting...');
        } else {
            setButtonState(launchBtn, '<i class="fas fa-rocket"></i> AI Auto-Build');
            setButtonState(modalSubmit, '<i class="fas fa-rocket"></i> Start Auto-Build');
        }
    }

    async startAutoBuild(providedOptions) {
        if (this.autoBuildState.isRunning) {
            this.showAutoBuildPanel();
            return;
        }

        if (this.modifiedFiles.size > 0) {
            const proceed = confirm('You have unsaved changes. Auto-build may overwrite files. Continue?');
            if (!proceed) {
                return;
            }
        }

        this.hideAutoBuildModalAlert();

        const options = this.normalizeAutoBuildOptions(providedOptions || this.autoBuildState.options || {});
        options.solution_timeout_ms = this.getProblemTimeLimit();
        const selectedFlags = [
            options.polish_statement,
            options.generate_solution,
            options.generate_generator,
            options.generate_validator,
            options.generate_spj,
            options.generate_tests
        ];

        if (!selectedFlags.some(Boolean)) {
            const message = 'Select at least one artifact to generate.';
            if (document.body.classList.contains('modal-open')) {
                this.showAutoBuildModalAlert(message);
            } else if (this.autoBuildElements.message) {
                this.autoBuildElements.message.innerHTML = `<span class="text-warning"><i class=\"fas fa-exclamation-triangle\"></i> ${message}</span>`;
            }
            return;
        }

        if (options.generate_validator) {
            const validatorToggle = document.getElementById('validatorEnabled');
            if (validatorToggle && !validatorToggle.checked) {
                validatorToggle.checked = true;
                validatorToggle.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }

        if (options.generate_spj) {
            const checkerSelect = document.getElementById('edit_checker_type');
            if (checkerSelect && checkerSelect.value !== 'spj') {
                checkerSelect.value = 'spj';
                this.markFileModified('config');
            }
        }

        if (!options.generate_tests) {
            options.sample_case_count = 0;
            options.system_case_count = 0;
        }

        this.autoBuildState.options = options;
        this.storeAutoBuildOptions(options);

        this.autoBuildState.isRunning = true;
        this.stopAutoBuildProgressLoop();
        this.showAutoBuildPanel();
        this.resetAutoBuildUI();
        if (this.autoBuildElements.summary) {
            this.autoBuildElements.summary.style.display = 'none';
            this.autoBuildElements.summary.classList.remove('failed');
            this.autoBuildElements.summary.innerHTML = '';
        }
        if (this.autoBuildElements.reloadBtn) {
            this.autoBuildElements.reloadBtn.style.display = 'none';
            this.autoBuildElements.reloadBtn.classList.remove('btn-success');
            this.autoBuildElements.reloadBtn.classList.add('btn-outline-secondary');
        }

        const steps = this.buildAutoBuildStepNames(options).map((name, index) => ({
            name,
            status: index === 0 ? 'active' : 'pending',
            details: null,
        }));

        this.autoBuildState.currentSteps = steps;
        this.autoBuildState.currentStepIndex = steps.length ? 0 : -1;

        this.renderAutoBuildSteps(steps);
        this.updateAutoBuildStatus({ status: 'running', message: 'Preparing auto-build...' }, steps);
        this.setAutoBuildButtonLoading(true);
        this.startAutoBuildProgressLoop();

        try {
            const response = await fetch(`/api/problem/${this.getSlugFromUrl()}/ai-auto-build`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    options,
                    context: this.currentAIContext || ''
                })
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Auto-build request failed');
            }

            const summary = data.summary || {};
            let stepResults = Array.isArray(summary.steps) ? summary.steps : null;
            if (!stepResults) {
                stepResults = steps.map(step => ({ ...step, status: 'completed' }));
                summary.steps = stepResults;
            }

            this.renderAutoBuildSteps(stepResults);
            this.updateAutoBuildStatus({ status: 'succeeded' }, stepResults);
            this.renderAutoBuildSummary(summary);

            if (this.autoBuildElements.reloadBtn) {
                const reloadButton = this.autoBuildElements.reloadBtn;
                reloadButton.style.display = 'inline-block';
                reloadButton.classList.remove('btn-outline-secondary');
                reloadButton.classList.add('btn-success');
            }
        } catch (error) {
            console.error('Auto-build failed:', error);
            const failureMessage = error && error.message ? error.message : 'Auto-build failed.';
            steps.forEach(step => {
                if (step.status === 'active') {
                    step.status = 'failed';
                }
            });
            this.renderAutoBuildSteps(steps);
            this.updateAutoBuildStatus({ status: 'failed', message: failureMessage }, steps);
            this.renderAutoBuildFailure({ message: failureMessage });
        } finally {
            this.stopAutoBuildProgressLoop();
            this.autoBuildState.currentSteps = null;
            this.autoBuildState.currentStepIndex = -1;
            this.autoBuildState.isRunning = false;
            this.setAutoBuildButtonLoading(false);
        }
    }

    renderAutoBuildSummary(summary = {}) {
        const summaryEl = this.autoBuildElements.summary;
        if (!summaryEl) return;

        summaryEl.classList.remove('failed');
        summaryEl.style.display = 'block';

        const steps = Array.isArray(summary.steps) ? summary.steps : [];
        const tests = summary.tests || null;

        let html = '<h6><i class="fas fa-clipboard-check"></i> Auto-Build Summary</h6>';
        steps.forEach(step => {
            const completed = step.status === 'completed';
            const statusIcon = completed ? 'fas fa-check-circle text-success' : 'fas fa-exclamation-circle text-warning';
            html += `<div class="mb-2"><i class="${statusIcon}"></i> <strong>${this.escapeHtml(step.name)}</strong>`;
            if (step.details) {
                html += `<div class="auto-build-summary-details">${this.formatAutoBuildSummaryDetails(step.details)}</div>`;
            }
            html += '</div>';
        });

        if (tests) {
            html += `<div class="mb-2"><i class="fas fa-vials"></i> Tests generated ‚Äî Samples: <strong>${this.escapeHtml(String(tests.samples ?? 0))}</strong>, System: <strong>${this.escapeHtml(String(tests.system ?? 0))}</strong></div>`;
        }

        html += '<div class="alert alert-info mb-0"><i class="fas fa-info-circle"></i> Reload the page to load generated files into the editors, then review and publish.</div>';

        summaryEl.innerHTML = html;
    }

    renderAutoBuildFailure(detail = {}) {
        const summaryEl = this.autoBuildElements.summary;
        if (!summaryEl) return;

        summaryEl.classList.add('failed');
        summaryEl.style.display = 'block';
        const message = detail && detail.message ? detail.message : 'Auto-build failed.';
        summaryEl.innerHTML = `
            <h6><i class="fas fa-exclamation-triangle"></i> Auto-Build Failed</h6>
            <p class="mb-0">${this.escapeHtml(message)}</p>
        `;
    }

    resetAutoBuildUI() {
        this.stopAutoBuildProgressLoop();
        const { statusText, progressBar, stepList, message, summary } = this.autoBuildElements;
        this.autoBuildState.currentSteps = null;
        this.autoBuildState.currentStepIndex = -1;
        if (statusText) {
            statusText.textContent = 'Ready';
        }
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            progressBar.classList.remove('bg-danger');
        }
        if (stepList) {
            stepList.innerHTML = '';
        }
        if (message) {
            message.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle"></i> Use AI Auto-Build to generate problem assets automatically.</span>';
        }
        if (summary) {
            summary.style.display = 'none';
            summary.classList.remove('failed');
            summary.innerHTML = '';
        }
    }

    escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        const div = document.createElement('div');
        div.textContent = String(value);
        return div.innerHTML;
    }

    formatAutoBuildSummaryDetails(details) {
        if (!details) return '';

        if (typeof details === 'string') {
            return this.escapeHtml(details);
        }

        if (typeof details !== 'object') {
            return this.escapeHtml(String(details));
        }

        const entries = Object.entries(details);
        if (!entries.length) return '';

        return entries.map(([key, value]) => {
            const formattedKey = this.escapeHtml(key.replace(/_/g, ' '));
            let formattedValue;
            if (value === null || value === undefined) {
                formattedValue = '';
            } else if (typeof value === 'string') {
                formattedValue = value.trim();
            } else {
                formattedValue = JSON.stringify(value);
            }

            formattedValue = this.escapeHtml(formattedValue);

            return `
                <div class="auto-build-summary-detail-row">
                    <span class="auto-build-summary-detail-label">${formattedKey}:</span>
                    <span class="auto-build-summary-detail-value">${formattedValue}</span>
                </div>
            `;
        }).join('');
    }
    
    handleWindowResize() {
        // Debounce resize events
        clearTimeout(this.resizeTimeout);
        this.resizeTimeout = setTimeout(() => {
            Object.values(this.editors).forEach(editor => {
                if (editor && typeof editor.layout === 'function') {
                    try {
                        editor.layout();
                    } catch (error) {
                        console.warn('Error during resize layout:', error);
                    }
                }
            });
        }, 100);
    }
    
    switchToFile(fileName) {
        // Update tab appearance
        document.querySelectorAll('.file-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.file === fileName);
        });
        
        // Update content visibility
        document.querySelectorAll('.file-content').forEach(content => {
            if (content.id === 'auto-build-card') {
                const shouldShow = content.dataset.visible === 'true';
                content.style.display = shouldShow ? 'block' : 'none';
                return;
            }
            content.style.display = content.id === fileName + '-content' ? 'block' : 'none';
        });
        
        this.currentFile = fileName;
        
        // Focus and layout Monaco editor if available
        if (this.editors[fileName]) {
            setTimeout(() => {
                try {
                    if (typeof this.editors[fileName].layout === 'function') {
                        this.editors[fileName].layout();
                    }
                    if (typeof this.editors[fileName].focus === 'function') {
                        this.editors[fileName].focus();
                    }
                } catch (error) {
                    console.warn(`Error focusing/layouting editor for ${fileName}:`, error);
                }
            }, 150);
        }
        
        // Also trigger a global layout update for Monaco
        setTimeout(() => {
            if (window.monaco && window.monaco.editor) {
                try {
                    window.monaco.editor.getEditors().forEach(editor => {
                        if (editor.getContainerDomNode().offsetParent !== null) {
                            editor.layout();
                        }
                    });
                } catch (error) {
                    console.warn('Error during global Monaco layout:', error);
                }
            }
        }, 200);
    }
    
    loadFileContents() {
        // Store original contents for reset functionality
        this.originalContents = {
            statement: this.getInitialContent('statement'),
            solution: this.getInitialContent('solution'),
            generator: this.getInitialContent('generator'),
            validator: this.getInitialContent('validator'),
            checker: this.getInitialContent('checker')
        };
        
        // Store original contents for reset functionality
        
        // Update file statuses based on content
        this.updateAllFileStatuses();
    }
    
    updateAllFileStatuses() {
        const fileTypes = ['statement', 'solution', 'generator', 'validator', 'checker'];
        const requiredFiles = ['statement', 'solution', 'generator'];
        
        fileTypes.forEach(fileType => {
            const content = this.getFileContent(fileType);
            const hasContent = content && content.trim().length > 0;
            const isRequired = requiredFiles.includes(fileType);
            
            if (hasContent) {
                this.updateFileStatus(fileType, 'complete');
            } else if (isRequired) {
                this.updateFileStatus(fileType, 'incomplete');
            } else {
                this.updateFileStatus(fileType, 'optional');
            }
        });
        
        // Also update config status (always complete)
        this.updateFileStatus('config', 'complete');
    }
    
    markFileModified(fileName) {
        this.modifiedFiles.add(fileName);
        const tab = document.querySelector(`[data-file="${fileName}"]`);
        if (tab) {
            tab.classList.add('modified');
        }
        
        // Update save button
        const saveBtn = document.getElementById('saveAllBtn');
        if (this.modifiedFiles.size > 0) {
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Save ${this.modifiedFiles.size} Modified File${this.modifiedFiles.size > 1 ? 's' : ''}`;
            saveBtn.classList.remove('btn-light');
            saveBtn.classList.add('btn-warning');
        }
        
        // Update modified files counter  
        const modifiedElement = document.getElementById('modifiedFiles');
        if (modifiedElement) {
            modifiedElement.textContent = this.modifiedFiles.size;
        }
        
        // Update file status based on content
        if (fileName !== 'config') {
            const content = this.getFileContent(fileName);
            const hasContent = content && content.trim().length > 0;
            const requiredFiles = ['statement', 'solution', 'generator'];
            const isRequired = requiredFiles.includes(fileName);
            
            if (hasContent) {
                this.updateFileStatus(fileName, 'complete');
            } else if (isRequired) {
                this.updateFileStatus(fileName, 'incomplete');
            } else {
                this.updateFileStatus(fileName, 'optional');
            }
        }
    }
    
    async validateFileContent(fileType) {
        const content = this.getFileContent(fileType);
        const validationIndicator = document.getElementById(`${fileType}-validation`);
        
        if (!content.trim()) {
            this.updateValidationStatus(validationIndicator, 'pending', 'Empty');
            return;
        }
        
        this.updateValidationStatus(validationIndicator, 'loading', 'Validating...');
        
        try {
            const response = await fetch('/api/validate-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: this.getFileName(fileType),
                    content: content
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.valid) {
                this.updateValidationStatus(validationIndicator, 'valid', 'Valid');
                this.updateFileStatus(fileType, 'complete');
            } else {
                this.updateValidationStatus(validationIndicator, 'invalid', result.error || 'Invalid');
                this.updateFileStatus(fileType, 'incomplete');
            }
        } catch (error) {
            this.updateValidationStatus(validationIndicator, 'invalid', 'Validation failed');
        }
    }
    
    updateValidationStatus(indicator, status, message) {
        if (!indicator) return;
        
        indicator.className = `validation-indicator validation-${status}`;
        
        const icons = {
            valid: 'fas fa-check',
            invalid: 'fas fa-times',
            loading: 'fas fa-spinner fa-spin',
            pending: 'fas fa-clock'
        };
        
        indicator.innerHTML = `<i class="${icons[status]}"></i>`;
        indicator.title = message;
    }
    
    updateFileStatus(fileType, status) {
        const statusElement = document.getElementById(`${fileType}-status`);
        if (!statusElement) return;
        
        const statusConfig = {
            complete: { class: 'status-complete', icon: 'fas fa-check', text: 'Complete' },
            incomplete: { class: 'status-incomplete', icon: 'fas fa-exclamation-circle', text: 'Required' },
            optional: { class: 'status-optional', icon: 'fas fa-info-circle', text: 'Optional' }
        };
        
        const config = statusConfig[status];
        statusElement.className = `file-status ${config.class}`;
        statusElement.innerHTML = `<i class="${config.icon}"></i> ${config.text}`;
        
        // Also update the validation indicator on the right side
        const validationIndicator = document.getElementById(`${fileType}-validation`);
        if (validationIndicator) {
            if (status === 'complete') {
                this.updateValidationStatus(validationIndicator, 'valid', 'Complete');
            } else {
                this.updateValidationStatus(validationIndicator, 'pending', 'Pending');
            }
        }
    }
    

    
    getFileContent(fileType) {
        if (fileType === 'config') {
            return 'config-data'; // Config is always considered as having content
        }
        
        if (this.editors[fileType]) {
            return this.editors[fileType].getValue();
        }
        return '';
    }
    
    getFileName(fileType) {
        const fileNames = {
            statement: 'statement.md',
            solution: 'solution.py',
            generator: 'generator.py',
            validator: 'validator.py',
            checker: 'checker/spj.cpp'
        };
        return fileNames[fileType] || `${fileType}.txt`;
    }
    

    

    

    
    async saveAllChanges(silent = false) {
        const btn = document.getElementById('saveAllBtn');
        const originalText = btn.innerHTML;
        
        if (!silent) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        }
        
        try {
        // Collect all data
        const data = {
            config: {
                title: document.getElementById('edit_title').value.trim(),
                difficulty: document.getElementById('edit_difficulty').value,
                tags: document.getElementById('edit_tags').value.split(',').map(t => t.trim()).filter(t => t),
                time_limit_ms: parseInt(document.getElementById('edit_time_limit').value),
                memory_limit_mb: parseInt(document.getElementById('edit_memory_limit').value),
                checker_type: document.getElementById('edit_checker_type').value
            },
            files: {
                    'statement.md': this.getFileContent('statement'),
                    'solution.py': this.getFileContent('solution'),
                    'generator.py': this.getFileContent('generator'),
                    'validator.py': this.getFileContent('validator'),
                    'checker/spj.cpp': this.getFileContent('checker')
            },
            validator_enabled: document.getElementById('validatorEnabled').checked
        };
        
            const response = await fetch(`/api/problem/{{ problem.slug }}/save-all`, {
            method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (!silent) {
                    this.showSaveStatus('success', 'All changes saved successfully!');
                }
                
                // Clear modification markers
                this.modifiedFiles.clear();
                document.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.remove('modified');
                });
                
                // Reset save button
                btn.innerHTML = '<i class="fas fa-save"></i> Save All Changes';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-light');
                
                // Update file statuses after successful save
                this.updateAllFileStatuses();
                
            } else {
                this.showSaveStatus('error', `Save failed: ${result.error}`);
            }
        } catch (error) {
            this.showSaveStatus('error', `Network error: ${error.message}`);
        } finally {
            if (!silent) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            }
        }
    }
    
    async testFileIntegration() {
        const modal = new bootstrap.Modal(document.getElementById('integrationModal'));
        const resultsDiv = document.getElementById('integrationResults');
        
        resultsDiv.innerHTML = '<div class="text-center"><div class="spinner"></div><p>Testing file integration...</p></div>';
        modal.show();
        
        try {
        const files = {
                'statement.md': this.getFileContent('statement'),
                'solution.py': this.getFileContent('solution'),
                'generator.py': this.getFileContent('generator'),
                'validator.py': this.getFileContent('validator'),
                'checker/spj.cpp': this.getFileContent('checker')
            };
            
            const response = await fetch('/api/test-file-integration', {
            method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: files })
            });
            
            const data = await response.json();
            this.displayIntegrationResults(data);
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Integration test failed: ${error.message}</div>`;
        }
    }
    
    displayIntegrationResults(data) {
        const resultsDiv = document.getElementById('integrationResults');
        let html = '';
        
        if (data.success) {
            html += '<div class="alert alert-success"><i class="fas fa-check-circle"></i> All files integrate correctly!</div>';
            
            if (data.preview) {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Generated Test Case:</h6>
                            <pre class="bg-light p-3 rounded">${data.preview.input}</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Solution Output:</h6>
                            <pre class="bg-light p-3 rounded">${data.preview.output}</pre>
                            ${data.preview.valid ? '<span class="badge bg-success">‚úì Validator Passed</span>' : ''}
                        </div>
                    </div>
                `;
            }
        } else {
            html += '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Integration issues found:</div>';
            
            if (data.errors) {
                html += '<ul class="text-danger">';
                data.errors.forEach(error => {
                    html += `<li><strong>Error:</strong> ${error}</li>`;
                });
                html += '</ul>';
            }
        }
        
        if (data.warnings) {
            html += '<div class="alert alert-warning"><strong>Warnings:</strong></div>';
            html += '<ul>';
            data.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul>';
        }
        
        resultsDiv.innerHTML = html;
    }
    
    showSaveStatus(type, message) {
        const indicator = document.getElementById('saveIndicator');
        
        indicator.className = `save-indicator alert alert-${type === 'success' ? 'success' : 'danger'} show`;
        indicator.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle"></i> ${message}`;
        indicator.style.display = 'block';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 5000);
    }
    
    validateConfig() {
        // Simple config validation
        const title = document.getElementById('edit_title').value.trim();
        const timeLimit = parseInt(document.getElementById('edit_time_limit').value);
        const memoryLimit = parseInt(document.getElementById('edit_memory_limit').value);
        
        const configValidation = document.getElementById('config-validation');
        
                if (title && timeLimit > 0 && memoryLimit > 0) {
            this.updateValidationStatus(configValidation, 'valid', 'Configuration is valid');
        } else {
            this.updateValidationStatus(configValidation, 'invalid', 'Missing required configuration');
        }
    }

    // AI Context Management
    getContextStorageKey() {
        return `pocketoj_ai_context_${this.getSlugFromUrl()}`;
    }

    loadSavedContext() {
        try {
            const saved = localStorage.getItem(this.getContextStorageKey());
            return saved || '';
        } catch (error) {
            console.warn('Failed to load saved context:', error);
            return '';
        }
    }

    saveContext(context) {
        try {
            localStorage.setItem(this.getContextStorageKey(), context);
        } catch (error) {
            console.warn('Failed to save context:', error);
        }
    }

    showContextModal(actionType, fileType = null) {
        // Store the action type and file type for later use
        this.pendingAIAction = actionType;
        this.pendingAIFileType = fileType;

        // Update modal title and description based on action type
        const modalTitle = document.getElementById('aiContextModalLabel');
        const modalDescription = document.getElementById('aiContextDescription');
        
        if (actionType === 'autoBuild') {
            modalTitle.innerHTML = '<i class="fas fa-rocket"></i> AI Auto-Build Context';
            modalDescription.textContent = 'Provide additional context to guide the AI Auto-Build process. This context will be used for generating all selected artifacts (statement polish, solution, generator, validator, tests, etc.).';
        } else if (actionType === 'polish') {
            modalTitle.innerHTML = '<i class="fas fa-brain"></i> AI Statement Polish Context';  
            modalDescription.textContent = 'Provide additional context to guide the AI statement polishing. This helps the AI understand your specific requirements and style preferences.';
        } else {
            modalTitle.innerHTML = '<i class="fas fa-brain"></i> AI Generation Context';
            modalDescription.textContent = 'Provide additional context to guide the AI code generation. This helps the AI understand your specific requirements and constraints.';
        }

        // Load saved context
        const savedContext = this.loadSavedContext();
        document.getElementById('aiContextInput').value = savedContext;

        // Show context modal
        const contextModal = new bootstrap.Modal(document.getElementById('aiContextModal'));
        contextModal.show();
    }

    async continueWithAIAfterContext() {
        // Save the context
        const context = document.getElementById('aiContextInput').value.trim();
        this.saveContext(context);
        this.currentAIContext = context;

        // Hide context modal
        const contextModal = bootstrap.Modal.getInstance(document.getElementById('aiContextModal'));
        contextModal.hide();

        // Continue with the pending AI action
        if (this.pendingAIAction === 'generate') {
            this.currentAIOperationType = 'generate';
            await this.performAIGeneration(this.pendingAIFileType);
        } else if (this.pendingAIAction === 'polish') {
            this.currentAIOperationType = 'polish';
            await this.performAIStatementPolish();
        }
        // Note: Auto-Build no longer uses separate context modal
    }

    // AI Generation Methods
    async initializeAI() {
        // Check AI availability
        try {
            const response = await fetch('/api/ai/status');
            const data = await response.json();
            
            this.aiAvailable = data.ai_available;
            
            // Enable/disable AI buttons based on availability
            const aiButtons = document.querySelectorAll('.ai-generate-btn, .ai-polish-btn');
            aiButtons.forEach(btn => {
                if (!this.aiAvailable) {
                    btn.disabled = true;
                    btn.title = 'AI service not available. Configure OPENAI_API_KEY.';
                    if (btn.classList.contains('ai-polish-btn')) {
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> AI Unavailable';
                    } else {
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> AI Unavailable';
                    }
                }
            });
            
            // Setup AI button event listeners
            this.setupAIEventListeners();
            
        } catch (error) {
            console.error('Failed to check AI status:', error);
            this.aiAvailable = false;
        }
    }

    setupAIEventListeners() {
        // Setup AI generation button listeners
        document.querySelectorAll('.ai-generate-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileType = e.currentTarget.getAttribute('data-file-type');
                this.handleAIGeneration(fileType);
            });
        });

        // Setup AI polish button listeners
        document.querySelectorAll('.ai-polish-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const fileType = e.currentTarget.getAttribute('data-file-type');
                this.handleAIStatementPolish();
            });
        });

        // Setup modal button listeners
        document.getElementById('applyAiCodeBtn').addEventListener('click', () => {
            this.applyAICode();
        });

        document.getElementById('regenerateAiCodeBtn').addEventListener('click', () => {
            this.regenerateAICode();
        });

        // Setup context modal button listener
        document.getElementById('continueWithAI').addEventListener('click', () => {
            this.continueWithAIAfterContext();
        });

        // Setup AI generation modal close listener to clear operation type
        document.getElementById('aiGenerationModal').addEventListener('hidden.bs.modal', () => {
            // Only clear operation type when modal is actually closed (not during regeneration)
            this.currentAIOperationType = null;
        });
    }

    async handleAIGeneration(fileType) {
        if (!this.aiAvailable) {
            alert('AI service is not available. Please configure OPENAI_API_KEY.');
            return;
        }

        // Show context modal first
        this.showContextModal('generate', fileType);
    }

    async performAIGeneration(fileType) {
        // Store current file type for regeneration
        this.currentAIFileType = fileType;

        // Show generation modal
        const modal = new bootstrap.Modal(document.getElementById('aiGenerationModal'));
        document.getElementById('aiModalFileType').textContent = this.getFileTypeDisplayName(fileType);
        
        // Reset modal state
        this.resetAIModal();
        modal.show();

        // Start generation with context
        await this.generateAICode(fileType);
    }

    async generateAICode(fileType) {
        const statusDiv = document.getElementById('aiGenerationStatus');
        const previewDiv = document.getElementById('aiGenerationPreview');
        const errorDiv = document.getElementById('aiGenerationError');
        const applyBtn = document.getElementById('applyAiCodeBtn');
        const regenerateBtn = document.getElementById('regenerateAiCodeBtn');

        // Show loading state
        statusDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Generating...</span>
                </div>
                <div class="mt-3">
                    <h6>Generating ${this.getFileTypeDisplayName(fileType)} with AI...</h6>
                    <p class="text-muted">This may take 10-30 seconds depending on the complexity.</p>
                </div>
            </div>
        `;

        try {
            const response = await fetch(`/api/problem/${this.getSlugFromUrl()}/ai-generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_type: fileType,
                    context: this.currentAIContext || ''
                })
            });

            const data = await response.json();

            if (data.success) {
                // Store generated code (clean any remaining formatting issues)
                this.currentAICode = this.cleanGeneratedCode(data.generated_code);
                this.currentAIExplanation = data.explanation;

                // Show preview
                statusDiv.style.display = 'none';
                previewDiv.style.display = 'block';
                errorDiv.style.display = 'none';

                document.getElementById('aiGeneratedCode').textContent = this.currentAICode;
                
                // Show explanation if available
                this.updateExplanationDisplay(data.explanation);
                
                applyBtn.style.display = 'inline-block';
                regenerateBtn.style.display = 'inline-block';

            } else {
                // Show error
                statusDiv.style.display = 'none';
                previewDiv.style.display = 'none';
                errorDiv.style.display = 'block';

                document.getElementById('aiErrorMessage').textContent = data.error;
                regenerateBtn.style.display = 'inline-block';
            }

        } catch (error) {
            console.error('AI generation error:', error);
            
            statusDiv.style.display = 'none';
            previewDiv.style.display = 'none';
            errorDiv.style.display = 'block';

            document.getElementById('aiErrorMessage').textContent = `Network error: ${error.message}`;
            regenerateBtn.style.display = 'inline-block';
        }
    }

    applyAICode() {
        // Handle statement polishing
        if (this.currentPolishedStatement) {
            const statementEditor = this.editors.statement;
            if (statementEditor && statementEditor.setValue) {
                statementEditor.setValue(this.currentPolishedStatement);
                this.markFileModified('statement');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiGenerationModal'));
                modal.hide();

                // Switch to statement tab
                this.switchToFile('statement');

                // Show success message
                this.showSaveStatus('success', 'AI-polished statement applied successfully!');
                
                // Clear polished statement
                this.currentPolishedStatement = null;
            }
            return;
        }

        // Handle regular code generation
        if (!this.currentAICode || !this.currentAIFileType) {
            return;
        }

        // Map file type to editor name (SPJ uses 'checker' editor)
        const editorName = this.currentAIFileType === 'spj' ? 'checker' : this.currentAIFileType;
        
        // Get the appropriate editor
        const editor = this.editors[editorName];
        if (editor && editor.setValue) {
            editor.setValue(this.currentAICode);
            this.markFileModified(editorName);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiGenerationModal'));
            modal.hide();

            // Switch to the file tab (use editor name for switching)
            this.switchToFile(editorName);

            // Show success message
            this.showSaveStatus('success', `AI-generated ${this.getFileTypeDisplayName(this.currentAIFileType)} applied successfully!`);
        }
    }

    async regenerateAICode() {
        // Determine what type of regeneration this is based on current operation type
        if (this.currentAIOperationType === 'polish' && this.currentRawStatement) {
            // Regenerate statement polish with same context
            this.resetAIModal();
            await this.polishStatement(this.currentRawStatement);
            return;
        }

        if (this.currentAIOperationType === 'generate' && this.currentAIFileType) {
            // Regenerate code with same context
            this.resetAIModal();
            await this.generateAICode(this.currentAIFileType);
            return;
        }

        // Fallback - try to determine from existing state
        const modalTitle = document.getElementById('aiModalFileType').textContent;
        
        if (modalTitle === 'Statement Polish' && this.currentRawStatement) {
            this.currentAIOperationType = 'polish';
            this.resetAIModal();
            await this.polishStatement(this.currentRawStatement);
            return;
        }

        if (this.currentAIFileType) {
            this.currentAIOperationType = 'generate';
            this.resetAIModal();
            await this.generateAICode(this.currentAIFileType);
            return;
        }

        // No regeneration context available
        console.warn('No regeneration context available');
        const modal = bootstrap.Modal.getInstance(document.getElementById('aiGenerationModal'));
        if (modal) modal.hide();
    }

    resetAIModal() {
        const statusDiv = document.getElementById('aiGenerationStatus');
        const previewDiv = document.getElementById('aiGenerationPreview');
        const errorDiv = document.getElementById('aiGenerationError');
        const applyBtn = document.getElementById('applyAiCodeBtn');
        const regenerateBtn = document.getElementById('regenerateAiCodeBtn');

        statusDiv.style.display = 'block';
        previewDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        applyBtn.style.display = 'none';
        regenerateBtn.style.display = 'none';

        statusDiv.innerHTML = '';
        
        // Reset button text to default
        applyBtn.innerHTML = '<i class="fas fa-check"></i> Apply to Editor';
        regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Regenerate';
        
        // Clear stored data
        this.currentAICode = null;
        this.currentPolishedStatement = null;
        this.currentAIExplanation = null;
        // Note: Keep currentAIOperationType for regeneration, only clear on modal close
    }

    updateExplanationDisplay(explanation) {
        const explanationSection = document.getElementById('aiExplanationSection');
        const explanationContent = document.getElementById('aiExplanationContent');
        
        if (explanation && explanation.trim()) {
            explanationContent.textContent = explanation;
            explanationSection.style.display = 'block';
        } else {
            explanationSection.style.display = 'none';
        }
    }

    getFileTypeDisplayName(fileType) {
        const names = {
            'solution': 'Reference Solution',
            'generator': 'Test Generator',
            'validator': 'Input Validator',
            'spj': 'Special Judge (SPJ)'
        };
        return names[fileType] || fileType;
    }

    getSlugFromUrl() {
        const pathParts = window.location.pathname.split('/');
        return pathParts[pathParts.length - 2]; // Assuming URL is /problem/{slug}/edit
    }

    cleanGeneratedCode(code) {
        // Additional client-side cleaning as a safety net
        if (!code) return '';

        // Remove markdown code blocks if they somehow made it through
        let cleaned = code.replace(/^```[\w]*\n?/gm, '').replace(/\n?```$/gm, '');
        
        // Remove any leading explanatory text before code starts
        const lines = cleaned.split('\n');
        let startIndex = 0;
        
        // Look for actual code start patterns
        const codePatterns = [
            /^#!/,                          // Shebang
            /^#include/,                    // C++ includes
            /^import\s/,                    // Python imports
            /^from\s/,                      // Python from imports
            /^def\s/,                       // Python functions
            /^class\s/,                     // Python classes
            /^"""/,                         // Python docstrings
            /^'''/,                         // Python docstrings
            /^using namespace/,             // C++ using
            /^int main\s*\(/,              // C++ main
            /^\w+\s+\w+\s*\(/,            // Function definitions
        ];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (codePatterns.some(pattern => pattern.test(line))) {
                startIndex = i;
                break;
            }
        }
        
        if (startIndex > 0) {
            cleaned = lines.slice(startIndex).join('\n');
        }
        
        return cleaned.trim();
    }

    // Statement Polishing Methods
    async handleAIStatementPolish() {
        if (!this.aiAvailable) {
            alert('AI service is not available. Please configure OPENAI_API_KEY.');
            return;
        }

        // Get current statement content from the editor
        const statementEditor = this.editors.statement;
        if (!statementEditor || !statementEditor.getValue) {
            alert('Statement editor not available.');
            return;
        }

        const currentStatement = statementEditor.getValue().trim();
        if (!currentStatement) {
            alert('Please write some content in the statement editor first.');
            return;
        }

        // Store for regeneration
        this.currentRawStatement = currentStatement;

        // Show context modal first
        this.showContextModal('polish');
    }

    async performAIStatementPolish() {
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('aiGenerationModal'));
        document.getElementById('aiModalFileType').textContent = 'Statement Polish';
        
        // Reset modal state
        this.resetAIModal();
        modal.show();

        // Start polishing with context
        await this.polishStatement(this.currentRawStatement);
    }

    async polishStatement(rawStatement) {
        const statusDiv = document.getElementById('aiGenerationStatus');
        const previewDiv = document.getElementById('aiGenerationPreview');
        const errorDiv = document.getElementById('aiGenerationError');
        const applyBtn = document.getElementById('applyAiCodeBtn');
        const regenerateBtn = document.getElementById('regenerateAiCodeBtn');

        // Show loading state
        statusDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Polishing...</span>
                </div>
                <div class="mt-3">
                    <h6><i class="fas fa-sparkles"></i> Polishing Statement with AI...</h6>
                    <p class="text-muted">Creating a professional, well-structured problem statement. This may take 15-45 seconds.</p>
                </div>
            </div>
        `;

        try {
            const response = await fetch(`/api/problem/${this.getSlugFromUrl()}/ai-polish-statement`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    raw_statement: rawStatement,
                    context: this.currentAIContext || ''
                })
            });

            const data = await response.json();

            if (data.success) {
                // Store polished statement
                this.currentPolishedStatement = data.polished_statement;
                this.currentAIExplanation = data.explanation;

                // Show preview
                statusDiv.style.display = 'none';
                previewDiv.style.display = 'block';
                errorDiv.style.display = 'none';

                document.getElementById('aiGeneratedCode').textContent = data.polished_statement;
                
                // Show explanation if available
                this.updateExplanationDisplay(data.explanation);
                
                applyBtn.style.display = 'inline-block';
                applyBtn.innerHTML = '<i class="fas fa-check"></i> Apply Polished Statement';
                regenerateBtn.style.display = 'inline-block';
                regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Re-polish';

            } else {
                // Show error
                statusDiv.style.display = 'none';
                previewDiv.style.display = 'none';
                errorDiv.style.display = 'block';

                document.getElementById('aiErrorMessage').textContent = data.error;
                regenerateBtn.style.display = 'inline-block';
                regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
            }

        } catch (error) {
            console.error('AI statement polishing error:', error);
            
            statusDiv.style.display = 'none';
            previewDiv.style.display = 'none';
            errorDiv.style.display = 'block';

            document.getElementById('aiErrorMessage').textContent = `Network error: ${error.message}`;
            regenerateBtn.style.display = 'inline-block';
            regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
        }
    }
}
    
// Initialize the enhanced editor when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    
    try {
        window.problemEditor = new ProblemEditor();
        window.problemEditor.init().then(() => {
            // Initialize AI functionality after main editor is ready
            return window.problemEditor.initializeAI();
        }).catch(error => {
            console.error('Failed to initialize Problem Editor async:', error);
        });
    } catch (error) {
        console.error('Failed to initialize Problem Editor:', error);
        
        // Fallback: Create simple textarea editors
        containers.forEach(type => {
            const container = document.getElementById(`${type}-monaco-editor`);
            if (container) {
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control code-editor';
                textarea.style.width = '100%';
                textarea.style.height = '600px';
                textarea.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
                textarea.placeholder = `Enter ${type} content here...`;
                container.appendChild(textarea);
            }
        });
    }
});
</script>
{% endblock %}
